<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#080810">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SubsTrack">
<meta name="description" content="Smart Subscription Manager for India">
<title>SubsTrack â€” Subscription Manager</title>
<link rel="manifest" id="pwa-manifest" href="#">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#080810;--surface:#0f0f1a;--surface2:#161625;--surface3:#1e1e30;--surface4:#252540;
  --accent:#7c5cfc;--accent2:#a78bfa;--accent-glow:rgba(124,92,252,.3);--accent-dim:rgba(124,92,252,.1);--accent-border:rgba(124,92,252,.25);
  --text:#f0f0ff;--text2:#9898bb;--text3:#5a5a7a;
  --danger:#ff4d6d;--danger-glow:rgba(255,77,109,.35);--danger-dim:rgba(255,77,109,.08);
  --success:#22d3a0;--warning:#f59e0b;--info:#38bdf8;
  --card-border:rgba(255,255,255,.045);--card-shine:rgba(255,255,255,.03);
  --radius:18px;--radius-sm:12px;--radius-xs:9px;--radius-pill:100px;
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --safe-top:env(safe-area-inset-top,0px);
  --nav-h:68px;
  --spring:cubic-bezier(0.32,0.72,0,1);
  --ease-out:cubic-bezier(0.22,1,0.36,1);
}
html{background:var(--bg);overflow:hidden;height:100%;overscroll-behavior:none}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;overscroll-behavior:none;-webkit-font-smoothing:antialiased}
input,button,select,textarea{font-family:inherit;border:none;outline:none;background:none;color:inherit}
button{cursor:pointer}
h1,h2,h3,.metric-value,.sub-price,.auth-title{font-family:'Sora',sans-serif}

/* Global noise overlay */
body::before{content:'';position:fixed;inset:0;pointer-events:none;opacity:.025;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");z-index:9999}

/* Skeleton */
.skeleton{background:linear-gradient(90deg,var(--surface) 0%,var(--surface3) 50%,var(--surface) 100%);background-size:200% 100%;animation:shimmer 1.6s infinite linear;border-radius:var(--radius-sm)}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{height:76px;border-radius:var(--radius);margin-bottom:10px}
.skeleton-metric{height:104px;border-radius:var(--radius);flex:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-screen{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;transition:opacity .5s var(--ease-out),transform .5s var(--ease-out)}
#auth-screen.hidden{opacity:0;pointer-events:none;transform:scale(1.04) translateY(-8px)}
#auth-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(124,92,252,.12) 0%,transparent 70%);pointer-events:none}
.auth-logo{width:76px;height:76px;border-radius:22px;background:linear-gradient(135deg,#7c5cfc,#4f35c2);display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 12px 40px var(--accent-glow),0 0 0 1px rgba(124,92,252,.2)}
.auth-logo svg{width:38px;height:38px;fill:#fff}
.auth-title{font-size:30px;font-weight:800;margin-bottom:6px;letter-spacing:-.8px;background:linear-gradient(135deg,#f0f0ff,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-subtitle{font-size:14px;color:var(--text3);margin-bottom:36px;font-weight:400}
.auth-form{width:100%;max-width:380px;position:relative;z-index:1}
.auth-input-group{position:relative;margin-bottom:14px}
.auth-input-group input{width:100%;height:54px;background:var(--surface);border:1.5px solid var(--surface3);border-radius:var(--radius-sm);padding:16px 16px 0;font-size:15px;transition:border-color .2s,box-shadow .2s}
.auth-input-group input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.auth-input-group label{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--text3);pointer-events:none;transition:.2s;font-family:'DM Sans',sans-serif}
.auth-input-group input:focus+label,.auth-input-group input:not(:placeholder-shown)+label{top:14px;font-size:10px;transform:none;color:var(--accent);font-weight:600;letter-spacing:.4px;text-transform:uppercase}
.auth-btn{width:100%;height:54px;background:linear-gradient(135deg,#7c5cfc,#5b35e8);border-radius:var(--radius-sm);font-size:15px;font-weight:700;color:#fff;transition:transform .2s,box-shadow .2s;margin-top:10px;letter-spacing:.2px;box-shadow:0 8px 24px var(--accent-glow);font-family:'Sora',sans-serif}
.auth-btn:active{transform:scale(0.97);box-shadow:0 4px 12px var(--accent-glow)}
.auth-btn:disabled{opacity:.5}
.auth-toggle{text-align:center;margin-top:22px;font-size:13px;color:var(--text3)}
.auth-toggle span{color:var(--accent2);font-weight:600;cursor:pointer}
.auth-error{color:var(--danger);font-size:12px;text-align:center;margin-top:8px;min-height:18px;font-weight:500}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{height:100%;display:flex;flex-direction:column;opacity:0;transition:opacity .5s var(--ease-out)}
#app.visible{opacity:1}

.app-header{position:sticky;top:0;z-index:50;padding:10px 20px 10px;padding-top:calc(10px + var(--safe-top));background:rgba(8,8,16,.88);-webkit-backdrop-filter:blur(32px) saturate(200%);backdrop-filter:blur(32px) saturate(200%);border-bottom:1px solid var(--card-border)}
.app-header-inner{display:flex;align-items:center;justify-content:space-between}
.app-header-logo{display:flex;align-items:center;gap:10px}
.header-logo-mark{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,#7c5cfc,#4f35c2);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px var(--accent-glow)}
.header-logo-mark svg{width:16px;height:16px;fill:#fff}
.app-header h1{font-size:20px;font-weight:800;letter-spacing:-.6px}
.app-header h1 span{background:linear-gradient(135deg,#7c5cfc,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-actions{display:flex;gap:6px}
.header-btn{width:36px;height:36px;border-radius:50%;background:var(--surface2);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;transition:transform .2s,background .2s}
.header-btn:active{transform:scale(0.88);background:var(--surface3)}
.header-btn svg{width:16px;height:16px;stroke:var(--text2);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* Main */
.main-scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 88px)}
::-webkit-scrollbar{width:0;height:0}

/* PTR */
.ptr-indicator{text-align:center;padding:0;height:0;overflow:hidden;transition:height .3s var(--spring);color:var(--accent2);font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px}
.ptr-indicator svg{width:16px;height:16px;stroke:var(--accent2);fill:none;stroke-width:2}
.ptr-indicator.refreshing svg{animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Tab Content */
.tab-content{display:none;padding:16px 18px;animation:fadeUp .35s var(--ease-out)}
.tab-content.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}

/* Section Labels */
.section-label{font-size:10px;text-transform:uppercase;letter-spacing:1.4px;color:var(--text3);font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;font-family:'Sora',sans-serif}
.section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--surface3),transparent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• URGENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.urgent-card{background:var(--danger-dim);border:1px solid rgba(255,77,109,.18);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:14px;margin-bottom:10px;cursor:pointer;transition:transform .2s,box-shadow .2s;animation:urgentPulse 2.5s ease-in-out infinite}
.urgent-card:active{transform:scale(0.96)}
@keyframes urgentPulse{0%,100%{box-shadow:0 0 20px rgba(255,77,109,.15)}50%{box-shadow:0 0 32px rgba(255,77,109,.08)}}
.urgent-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px;background:rgba(255,77,109,.1);color:#fff;font-weight:700;font-family:'Sora',sans-serif;overflow:hidden}
.urgent-icon img{width:100%;height:100%;object-fit:contain;padding:6px}
.urgent-info{flex:1;min-width:0}
.urgent-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Sora',sans-serif}
.urgent-detail{font-size:11px;color:var(--danger);font-weight:600;margin-top:3px}
.urgent-amount{font-size:15px;font-weight:800;white-space:nowrap;font-family:'Sora',sans-serif}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• METRICS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.metrics-row{display:flex;gap:10px;margin-bottom:20px}
.metric-card{flex:1;background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden;transition:transform .2s}
.metric-card:active{transform:scale(0.97)}
.metric-card::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-border),transparent)}
.metric-accent{position:absolute;top:-30px;right:-20px;width:80px;height:80px;border-radius:50%;background:var(--accent-glow);filter:blur(24px);pointer-events:none}
.metric-label{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.8px;font-family:'Sora',sans-serif}
.metric-value{font-size:24px;font-weight:800;margin-top:8px;letter-spacing:-.8px;line-height:1}
.metric-value .cur{font-size:14px;font-weight:600;color:var(--text2);vertical-align:super;line-height:0}
.metric-sub{font-size:10px;color:var(--text3);margin-top:5px;font-weight:500}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHART â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-section{margin-bottom:24px}
.chart-wrap{background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius);padding:16px;overflow-x:auto}
.chart-wrap::after{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-border),transparent)}
.chart-wrap{position:relative}
.chart-bars{display:flex;align-items:flex-end;gap:10px;height:130px;min-width:max-content;padding:20px 4px 0}
.chart-bar-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:48px}
.chart-bar{width:32px;border-radius:8px 8px 3px 3px;background:linear-gradient(180deg,var(--surface3),var(--surface4));min-height:4px;transition:height .6s var(--spring);position:relative;cursor:default}
.chart-bar-val{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:700;white-space:nowrap;color:var(--text3);font-family:'Sora',sans-serif}
.chart-bar-label{font-size:9px;color:var(--text3);font-weight:600;font-family:'Sora',sans-serif}
.chart-bar.current{background:linear-gradient(180deg,#a78bfa,#7c5cfc);box-shadow:0 6px 20px var(--accent-glow)}
.chart-bar.current .chart-bar-val{color:var(--accent2)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUB CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sub-list{display:flex;flex-direction:column;gap:8px}
.sub-card-wrapper{position:relative;overflow:hidden;border-radius:var(--radius);transition:max-height .4s var(--spring),opacity .3s,margin .3s}
.sub-card-wrapper.removing{max-height:0!important;opacity:0;margin:0}
.sub-card-delete-bg{position:absolute;right:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,transparent 50%,#ff1a3e);display:flex;align-items:center;justify-content:flex-end;padding-right:22px;border-radius:var(--radius)}
.sub-card-delete-bg svg{width:22px;height:22px;stroke:#fff;fill:none;stroke-width:2}
.sub-card{background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius);padding:13px 15px;display:flex;align-items:center;gap:13px;position:relative;overflow:hidden;transition:transform .15s;cursor:pointer;touch-action:pan-y;user-select:none;-webkit-user-select:none}
.sub-card:active{transform:scale(0.97)}
.sub-card.swiping:active{transform:none}
.sub-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--card-shine),transparent);pointer-events:none}
.sub-logo{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;font-weight:800;color:#fff;overflow:hidden;position:relative;font-family:'Sora',sans-serif}
.sub-logo img{width:100%;height:100%;object-fit:contain;padding:6px}
.sub-info{flex:1;min-width:0}
.sub-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Sora',sans-serif;letter-spacing:-.2px}
.sub-meta{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.sub-cycle{font-size:11px;color:var(--text3);font-weight:500}
.sub-right{text-align:right;flex-shrink:0}
.sub-price{font-size:15px;font-weight:800;font-family:'Sora',sans-serif;letter-spacing:-.3px}
.sub-next{font-size:11px;color:var(--text3);margin-top:3px;font-weight:500}
.sub-status-dot{width:5px;height:5px;border-radius:50%;display:inline-block;flex-shrink:0}
.sub-status-dot.active{background:var(--success)}
.sub-status-dot.due-soon{background:var(--warning)}
.sub-status-dot.overdue{background:var(--danger)}
.sub-status-dot.prepaid{background:var(--info)}

/* Payment badge */
.pay-badge{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 7px;border-radius:var(--radius-pill);background:var(--surface3);color:var(--text3);letter-spacing:.2px;text-transform:uppercase}
.pay-badge.upi{background:rgba(124,92,252,.1);color:var(--accent2)}
.pay-badge.card{background:rgba(34,211,160,.08);color:var(--success)}
.pay-badge.gplay{background:rgba(56,189,248,.08);color:var(--info)}
.pay-badge.net{background:rgba(245,158,11,.08);color:var(--warning)}
.pay-badge.prepaid-badge{background:rgba(56,189,248,.08);color:var(--info)}

/* Prepaid progress bar */
.prepaid-bar-wrap{margin-top:5px;display:flex;align-items:center;gap:6px}
.prepaid-bar{flex:1;height:3px;background:var(--surface3);border-radius:2px;overflow:hidden}
.prepaid-bar-inner{height:100%;background:linear-gradient(90deg,var(--info),#7dd3fc);border-radius:2px;transition:width .6s var(--spring)}
.prepaid-bar-text{font-size:9px;color:var(--text3);font-weight:600;white-space:nowrap}

/* Empty State */
.empty-state{text-align:center;padding:52px 24px}
.empty-icon{width:64px;height:64px;border-radius:20px;background:var(--surface2);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;margin:0 auto 20px}
.empty-icon svg{width:28px;height:28px;stroke:var(--text3);fill:none;stroke-width:1.5}
.empty-state h3{font-size:17px;font-weight:700;margin-bottom:6px;font-family:'Sora',sans-serif}
.empty-state p{font-size:13px;color:var(--text3);line-height:1.6}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INSIGHTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.insight-card{background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius);padding:18px;margin-bottom:14px;position:relative;overflow:hidden}
.insight-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-border),transparent)}
.insight-card h3{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;font-family:'Sora',sans-serif;color:var(--text2);letter-spacing:-.2px}
.insight-card h3 .icon{font-size:16px}
.donut-container{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
.donut-chart{width:130px;height:130px;flex-shrink:0}
.donut-legend{display:flex;flex-direction:column;gap:9px;flex:1;min-width:120px}
.legend-item{display:flex;align-items:center;gap:8px;font-size:12px}
.legend-dot{width:8px;height:8px;border-radius:3px;flex-shrink:0}
.legend-name{flex:1;color:var(--text2);font-weight:500}
.legend-val{font-weight:700;font-size:12px;font-family:'Sora',sans-serif}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--card-border)}
.stat-row:last-child{border-bottom:none}
.stat-label{font-size:12px;color:var(--text2);font-weight:500}
.stat-value{font-size:13px;font-weight:700;font-family:'Sora',sans-serif;text-align:right}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACCOUNT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.account-avatar{width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#7c5cfc,#4f35c2);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#fff;margin:0 auto 12px;box-shadow:0 0 0 4px var(--surface2),0 0 0 5px var(--accent-border),0 12px 32px var(--accent-glow);font-family:'Sora',sans-serif}
.account-email{text-align:center;font-size:13px;color:var(--text3);margin-bottom:28px;word-break:break-all}
.account-name{text-align:center;font-size:18px;font-weight:800;margin-bottom:4px;font-family:'Sora',sans-serif}
.account-section{margin-bottom:20px}
.account-section-title{font-size:10px;text-transform:uppercase;letter-spacing:1.4px;color:var(--text3);font-weight:700;margin-bottom:10px;font-family:'Sora',sans-serif}
.account-item{background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;transition:transform .2s,background .2s;cursor:pointer}
.account-item:active{transform:scale(0.97);background:var(--surface2)}
.account-item svg{width:18px;height:18px;stroke:var(--text2);fill:none;stroke-width:2;flex-shrink:0}
.account-item span{flex:1;font-size:14px;font-weight:500;font-family:'DM Sans',sans-serif}
.account-item .chevron{width:14px;height:14px;stroke:var(--text3)}
.account-item.danger span{color:var(--danger)}
.account-item.danger svg{stroke:var(--danger)}
.account-footer{text-align:center;margin-top:28px;padding:20px 0 8px;border-top:1px solid var(--card-border);color:var(--text3);font-size:11px;font-weight:500;line-height:1.8}
.account-footer strong{color:var(--text2);font-weight:600;font-family:'Sora',sans-serif}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(8,8,16,.92);-webkit-backdrop-filter:blur(32px) saturate(200%);backdrop-filter:blur(32px) saturate(200%);border-top:1px solid var(--card-border);padding-bottom:var(--safe-bottom)}
.bottom-nav-inner{display:flex;height:var(--nav-h);align-items:center;position:relative}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--text3);transition:color .2s;-webkit-tap-highlight-color:transparent;padding:8px 0}
.nav-item.active{color:var(--accent2)}
.nav-item svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:transform .2s}
.nav-item.active svg{transform:scale(1.12)}
.nav-item span{font-size:9px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;font-family:'Sora',sans-serif}
.nav-indicator{position:absolute;top:-1px;height:2px;background:linear-gradient(90deg,transparent,var(--accent2),transparent);border-radius:0 0 2px 2px;transition:left .35s var(--spring),width .35s var(--spring)}

/* FAB */
.fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);right:18px;z-index:90;width:54px;height:54px;border-radius:50%;background:linear-gradient(135deg,#7c5cfc,#5b35e8);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 28px var(--accent-glow),0 0 0 1px rgba(124,92,252,.3);transition:transform .2s,box-shadow .2s}
.fab:active{transform:scale(0.88);box-shadow:0 4px 14px var(--accent-glow)}
.fab svg{width:22px;height:22px;stroke:#fff;fill:none;stroke-width:2.5;stroke-linecap:round}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OVERLAYS / SHEETS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bs-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.65);opacity:0;pointer-events:none;transition:opacity .3s;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
.bs-overlay.open{opacity:1;pointer-events:auto}
.bottom-sheet{position:fixed;bottom:0;left:0;right:0;z-index:201;background:var(--surface);border-radius:26px 26px 0 0;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 320ms var(--spring);padding-bottom:var(--safe-bottom);border-top:1px solid var(--card-border)}
.bottom-sheet::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent-border),transparent)}
.bottom-sheet.open{transform:translateY(0)}
.bs-handle{width:36px;height:4px;background:var(--surface3);border-radius:4px;margin:12px auto 0}
.bs-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px 16px;flex-shrink:0}
.bs-header h2{font-size:18px;font-weight:800;letter-spacing:-.4px;font-family:'Sora',sans-serif}
.bs-close{width:30px;height:30px;border-radius:50%;background:var(--surface2);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center}
.bs-close svg{width:14px;height:14px;stroke:var(--text2);fill:none;stroke-width:2.5}
.bs-body{overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 20px 28px;flex:1}

/* Templates */
.templates-label{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:10px;font-family:'Sora',sans-serif}
.templates-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:22px}
.template-btn{display:flex;flex-direction:column;align-items:center;gap:5px;padding:10px 4px;border-radius:var(--radius-sm);background:var(--surface2);border:1px solid var(--card-border);transition:transform .2s,box-shadow .2s,border-color .2s}
.template-btn:active{transform:scale(0.9)}
.template-btn.selected{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-dim),0 0 20px var(--accent-glow)}
.template-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;overflow:hidden;font-family:'Sora',sans-serif}
.template-icon img{width:100%;height:100%;object-fit:contain;padding:4px}
.template-name{font-size:8px;font-weight:700;color:var(--text2);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;font-family:'Sora',sans-serif;text-transform:uppercase;letter-spacing:.3px}

/* Form */
.form-group{margin-bottom:14px}
.form-group>label{display:block;font-size:10px;font-weight:700;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:.8px;font-family:'Sora',sans-serif}
.form-input{width:100%;height:46px;background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--radius-xs);padding:0 14px;font-size:14px;transition:border-color .2s,box-shadow .2s;color:var(--text);font-family:'DM Sans',sans-serif}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.form-input::placeholder{color:var(--text3)}
select.form-input{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235a5a7a'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;background-color:var(--surface2);color:var(--text)}
select.form-input option{background:var(--surface);color:var(--text)}
.form-row{display:flex;gap:10px}
.form-row .form-group{flex:1}
.form-submit{width:100%;height:52px;background:linear-gradient(135deg,#7c5cfc,#5b35e8);border-radius:var(--radius-sm);font-size:15px;font-weight:700;color:#fff;transition:transform .15s,box-shadow .2s;margin-top:10px;letter-spacing:.2px;box-shadow:0 6px 20px var(--accent-glow);font-family:'Sora',sans-serif}
.form-submit:active{transform:scale(0.97)}
.form-submit:disabled{opacity:.5}

/* Toggle */
.form-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surface2);border:1.5px solid var(--surface3);border-radius:var(--radius-xs);margin-bottom:14px;cursor:pointer;transition:border-color .2s}
.form-toggle-row.active{border-color:var(--accent-border);background:var(--accent-dim)}
.form-toggle-label{font-size:13px;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:8px}
.form-toggle-label span{font-size:16px}
.toggle-switch{width:40px;height:22px;border-radius:12px;background:var(--surface3);position:relative;transition:background .2s;flex-shrink:0}
.toggle-switch::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:#fff;top:3px;left:3px;transition:transform .2s var(--spring),background .2s}
.form-toggle-row.active .toggle-switch{background:var(--accent)}
.form-toggle-row.active .toggle-switch::after{transform:translateX(18px)}

/* Prepaid fields */
.prepaid-fields{background:var(--surface2);border:1px solid var(--accent-border);border-radius:var(--radius-xs);padding:12px;margin-bottom:14px;display:none}
.prepaid-fields.show{display:block}

/* Category Tags */
.category-tags{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px}
.cat-tag{padding:5px 13px;border-radius:var(--radius-pill);font-size:11px;font-weight:700;background:var(--surface);color:var(--text2);border:1px solid var(--card-border);transition:all .2s;letter-spacing:.2px;font-family:'Sora',sans-serif}
.cat-tag.active{background:var(--accent-dim);color:var(--accent2);border-color:var(--accent-border)}
.cat-tag:active{transform:scale(0.95)}

/* Search */
.search-bar{position:relative;margin-bottom:14px}
.search-bar input{width:100%;height:42px;background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:0 14px 0 40px;font-size:14px;font-family:'DM Sans',sans-serif;color:var(--text)}
.search-bar input::placeholder{color:var(--text3)}
.search-bar input:focus{border-color:var(--accent);outline:none}
.search-bar svg{position:absolute;left:13px;top:50%;transform:translateY(-50%);width:16px;height:16px;stroke:var(--text3);fill:none;stroke-width:2}

/* Toast */
.toast{position:fixed;top:calc(16px + var(--safe-top));left:50%;transform:translateX(-50%) translateY(-130%);z-index:500;background:var(--surface2);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:11px 18px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;transition:transform .4s var(--spring);white-space:nowrap;max-width:90vw;box-shadow:0 16px 40px rgba(0,0,0,.5);font-family:'Sora',sans-serif}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{border-color:rgba(34,211,160,.2)}
.toast.error{border-color:rgba(255,77,109,.2)}
.toast-icon{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.toast.success .toast-icon{background:rgba(34,211,160,.15);color:var(--success)}
.toast.error .toast-icon{background:rgba(255,77,109,.15);color:var(--danger)}

/* Sort */
.sort-dropdown{position:relative}
.sort-menu{position:absolute;top:calc(100% + 8px);right:0;background:var(--surface2);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:6px;min-width:170px;z-index:60;opacity:0;transform:scale(.94) translateY(-6px);pointer-events:none;transition:all .2s var(--ease-out);box-shadow:0 20px 50px rgba(0,0,0,.5)}
.sort-menu.open{opacity:1;transform:none;pointer-events:auto}
.sort-option{display:block;width:100%;padding:9px 12px;text-align:left;font-size:13px;font-weight:600;border-radius:7px;color:var(--text2);transition:background .15s;font-family:'Sora',sans-serif}
.sort-option.active{background:var(--accent-dim);color:var(--accent2)}
.sort-option:hover{background:var(--surface3)}

/* Summary strip */
.summary-strip{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:10px 16px;margin-bottom:14px}
.strip-item{text-align:center}
.strip-val{font-size:15px;font-weight:800;font-family:'Sora',sans-serif}
.strip-lbl{font-size:9px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-top:2px;font-family:'Sora',sans-serif}
.strip-div{width:1px;height:28px;background:var(--card-border)}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
  <div class="auth-logo">
    <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 8 12 11.82 4.65 8 12 4.18zM4 9.47l7 3.5V19.7l-7-3.5V9.47zm10 10.23V12.97l7-3.5v6.73l-7 3.5z"/></svg>
  </div>
  <h2 class="auth-title">SubsTrack</h2>
  <p class="auth-subtitle">Smart subscription management for India</p>
  <div class="auth-form">
    <div id="auth-name-group" class="auth-input-group" style="display:none">
      <input type="text" id="auth-name" placeholder=" " autocomplete="name">
      <label>Display Name</label>
    </div>
    <div class="auth-input-group">
      <input type="email" id="auth-email" placeholder=" " autocomplete="email">
      <label>Email</label>
    </div>
    <div class="auth-input-group">
      <input type="password" id="auth-pass" placeholder=" " autocomplete="current-password">
      <label>Password</label>
    </div>
    <button class="auth-btn" id="auth-submit" onclick="handleAuth()">Sign In</button>
    <div class="auth-error" id="auth-error"></div>
    <p class="auth-toggle" id="auth-toggle">Don't have an account? <span onclick="toggleAuthMode()">Sign Up</span></p>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="app-header">
    <div class="app-header-inner">
      <div class="app-header-logo">
        <div class="header-logo-mark"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 8 12 11.82 4.65 8 12 4.18zM4 9.47l7 3.5V19.7l-7-3.5V9.47zm10 10.23V12.97l7-3.5v6.73l-7 3.5z"/></svg></div>
        <h1>Subs<span>Track</span></h1>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="openSearch()" aria-label="Search"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
        <button class="header-btn" onclick="toggleSort()" aria-label="Sort"><svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="16" y2="12"/><line x1="4" y1="18" x2="12" y2="18"/></svg></button>
        <div class="sort-dropdown">
          <div class="sort-menu" id="sort-menu">
            <button class="sort-option active" data-sort="date">Next Billing</button>
            <button class="sort-option" data-sort="price-asc">Price: Low â†’ High</button>
            <button class="sort-option" data-sort="price-desc">Price: High â†’ Low</button>
            <button class="sort-option" data-sort="name">Name A â†’ Z</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-scroll" id="main-scroll">
    <div class="ptr-indicator" id="ptr-indicator">
      <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
      <span>Syncingâ€¦</span>
    </div>

    <!-- Dashboard -->
    <div class="tab-content active" id="tab-dashboard">
      <div id="urgent-container"></div>
      <div class="metrics-row" id="metrics-container">
        <div class="metric-card skeleton skeleton-metric"></div>
        <div class="metric-card skeleton skeleton-metric"></div>
      </div>
      <div class="chart-section">
        <div class="section-label">6-Month Projection</div>
        <div class="chart-wrap" id="chart-container">
          <div class="chart-bars" id="chart-bars"></div>
        </div>
      </div>
      <div class="section-label">Upcoming Renewals</div>
      <div class="sub-list" id="dashboard-recent">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>

    <!-- Active Subs -->
    <div class="tab-content" id="tab-subs">
      <div class="search-bar" id="subs-search" style="display:none">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" placeholder="Search subscriptionsâ€¦" oninput="filterSubs(this.value)">
      </div>
      <div class="category-tags" id="category-filters"></div>
      <div id="subs-summary-strip"></div>
      <div class="sub-list" id="subs-list">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>

    <!-- Insights -->
    <div class="tab-content" id="tab-insights">
      <div id="insights-content"></div>
    </div>

    <!-- Account -->
    <div class="tab-content" id="tab-account">
      <div id="account-content"></div>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openAddSheet()" aria-label="Add subscription">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <div class="nav-indicator" id="nav-indicator"></div>
      <button class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
        <span>Dashboard</span>
      </button>
      <button class="nav-item" data-tab="subs" onclick="switchTab('subs')">
        <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        <span>My Subs</span>
      </button>
      <button class="nav-item" data-tab="insights" onclick="switchTab('insights')">
        <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <span>Insights</span>
      </button>
      <button class="nav-item" data-tab="account" onclick="switchTab('account')">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>Account</span>
      </button>
    </div>
  </nav>
</div>

<!-- Bottom Sheet -->
<div class="bs-overlay" id="bs-overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottom-sheet">
  <div class="bs-handle"></div>
  <div class="bs-header">
    <h2 id="bs-title">Add Subscription</h2>
    <button class="bs-close" onclick="closeSheet()"><svg viewBox="0 0 24 24" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>
  <div class="bs-body">
    <div class="templates-label">Quick Templates</div>
    <div class="templates-grid" id="templates-grid"></div>
    <div class="templates-label">Details</div>
    <form id="sub-form" onsubmit="return handleSubForm(event)">
      <div class="form-group">
        <label>Service Name *</label>
        <input class="form-input" id="f-name" required placeholder="e.g. Netflix">
      </div>
      <div class="form-group">
        <label>Logo URL (optional)</label>
        <input class="form-input" id="f-logo" placeholder="https://...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Cost (â‚¹) *</label>
          <input class="form-input" id="f-cost" type="number" min="1" required placeholder="499">
        </div>
        <div class="form-group">
          <label>Billing Cycle *</label>
          <select class="form-input" id="f-cycle" required>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Next Billing Date *</label>
        <input class="form-input" id="f-date" type="date" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Category</label>
          <select class="form-input" id="f-category">
            <option value="Entertainment">Entertainment</option>
            <option value="Food & Delivery">Food & Delivery</option>
            <option value="Music">Music</option>
            <option value="Gaming">Gaming</option>
            <option value="Productivity">Productivity</option>
            <option value="Cloud Storage">Cloud Storage</option>
            <option value="News">News</option>
            <option value="Fitness">Fitness</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Payment Mode</label>
          <select class="form-input" id="f-payment">
            <option value="">Selectâ€¦</option>
            <option value="UPI/GPay">GPay (UPI)</option>
            <option value="UPI/PhonePe">PhonePe (UPI)</option>
            <option value="UPI/Paytm">Paytm (UPI)</option>
            <option value="UPI/BHIM">BHIM (UPI)</option>
            <option value="Google Play">Google Play</option>
            <option value="Debit Card">Debit Card</option>
            <option value="Credit Card">Credit Card</option>
            <option value="Net Banking">Net Banking</option>
            <option value="Prepaid Card">Prepaid Card</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>
      <!-- Prepaid Toggle -->
      <div class="form-toggle-row" id="prepaid-toggle-row" onclick="togglePrepaid()">
        <span class="form-toggle-label"><span>ğŸŸï¸</span> Prepaid Subscription</span>
        <div class="toggle-switch" id="prepaid-toggle"></div>
      </div>
      <!-- Prepaid Fields -->
      <div class="prepaid-fields" id="prepaid-fields">
        <div class="form-row">
          <div class="form-group">
            <label>Prepaid Duration</label>
            <input class="form-input" id="f-prepaid-months" type="number" min="1" max="60" placeholder="12" oninput="updatePrepaidEnd()">
          </div>
          <div class="form-group">
            <label>Unit</label>
            <select class="form-input" id="f-prepaid-unit" onchange="updatePrepaidEnd()">
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Prepaid Until</label>
          <input class="form-input" id="f-prepaid-until" type="date" readonly style="opacity:.7">
        </div>
      </div>
      <div class="form-group">
        <label>Notes (optional)</label>
        <input class="form-input" id="f-notes" placeholder="Family plan, sharedâ€¦">
      </div>
      <input type="hidden" id="f-edit-id" value="">
      <input type="hidden" id="f-is-prepaid" value="false">
      <button class="form-submit" type="submit" id="f-submit-btn">Add Subscription</button>
    </form>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><div class="toast-icon" id="toast-icon"></div><span id="toast-msg"></span></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA â€” Blob manifest + Service Worker
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  // Build icon as SVG
  const iconSVG=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#080810"/><rect width="512" height="512" rx="100" fill="url(#g)"/><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#7c5cfc"/><stop offset="1" stop-color="#4f35c2"/></linearGradient></defs><path d="M256 88L136 155v106l120 60 120-60V155L256 88zm0 26.2l88.5 44.3L256 202.8l-88.5-44.3L256 114.2zM152 174.9l84 42V328l-84-42V174.9zm120 42l84-42V286l-84 42V216.9z" fill="white"/></svg>`;
  const iconBlob=new Blob([iconSVG],{type:'image/svg+xml'});
  const iconURL=URL.createObjectURL(iconBlob);
  const manifest={name:'SubsTrack',short_name:'SubsTrack',description:'Smart Subscription Manager for India',start_url:'.',display:'standalone',background_color:'#080810',theme_color:'#080810',orientation:'portrait',icons:[{src:iconURL,sizes:'192x192',type:'image/svg+xml'},{src:iconURL,sizes:'512x512',type:'image/svg+xml',purpose:'any maskable'}]};
  const mBlob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
  document.getElementById('pwa-manifest').href=URL.createObjectURL(mBlob);

  // Register inline service worker
  if('serviceWorker' in navigator){
    const sw=`const C='substrack-v2';
self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(C).then(c=>c.addAll(['./'])))});
self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(k=>Promise.all(k.filter(n=>n!==C).map(n=>caches.delete(n))))));
self.addEventListener('fetch',e=>{if(e.request.method!=='GET')return;e.respondWith(fetch(e.request).then(r=>{const cl=r.clone();caches.open(C).then(c=>c.put(e.request,cl));return r}).catch(()=>caches.match(e.request)))});`;
    const swBlob=new Blob([sw],{type:'application/javascript'});
    const swURL=URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL,{scope:'./'}).catch(()=>{});
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firebase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig={apiKey:"AIzaSyAp9negxP0RVgyJD0DJ3uh1Twz0VrNj9Q4",authDomain:"subscriptions-7c00f.firebaseapp.com",projectId:"subscriptions-7c00f",storageBucket:"subscriptions-7c00f.firebasestorage.app",messagingSenderId:"124269956323",appId:"1:124269956323:web:76f5617aae481fdf6bc9d6"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser=null,subscriptions=[],currentTab='dashboard';
let isSignUp=false,editingId=null,currentSort='date';
let searchQuery='',activeCategory='All',unsubListener=null;
let isPrepaidMode=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Templates
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TEMPLATES=[
  {name:'Netflix',color:'#E50914',logo:'https://cdn.simpleicons.org/netflix/E50914',cost:649,cycle:'monthly',category:'Entertainment'},
  {name:'Amazon Prime',color:'#00A8E1',logo:'https://cdn.simpleicons.org/amazon/00A8E1',cost:1499,cycle:'yearly',category:'Entertainment'},
  {name:'JioCinema',color:'#E8308C',logo:'https://cdn.simpleicons.org/jio/E8308C',cost:999,cycle:'yearly',category:'Entertainment'},
  {name:'SonyLIV',color:'#003087',logo:'https://cdn.simpleicons.org/sony/4F8BFF',cost:999,cycle:'yearly',category:'Entertainment'},
  {name:'Zee5',color:'#8230C6',logo:'https://cdn.simpleicons.org/zee5/8230C6',cost:999,cycle:'yearly',category:'Entertainment'},
  {name:'Swiggy One',color:'#FC8019',logo:'https://cdn.simpleicons.org/swiggy/FC8019',cost:299,cycle:'monthly',category:'Food & Delivery'},
  {name:'Zomato Gold',color:'#E23744',logo:'https://cdn.simpleicons.org/zomato/E23744',cost:300,cycle:'monthly',category:'Food & Delivery'},
  {name:'Spotify',color:'#1DB954',logo:'https://cdn.simpleicons.org/spotify/1DB954',cost:119,cycle:'monthly',category:'Music'},
  {name:'YouTube',color:'#FF0000',logo:'https://cdn.simpleicons.org/youtube/FF0000',cost:149,cycle:'monthly',category:'Entertainment'},
  {name:'Xbox Game Pass',color:'#107C10',logo:'https://cdn.simpleicons.org/xbox/107C10',cost:999,cycle:'monthly',category:'Gaming'},
  {name:'Hotstar',color:'#3A7BF7',logo:'https://cdn.simpleicons.org/hotstar/3A7BF7',cost:899,cycle:'yearly',category:'Entertainment'},
  {name:'Apple Music',color:'#FA243C',logo:'https://cdn.simpleicons.org/applemusic/FA243C',cost:99,cycle:'monthly',category:'Music'},
];

// Payment mode display helpers
const PAY_CONFIG={
  'UPI/GPay':{label:'GPay',cls:'upi'},'UPI/PhonePe':{label:'PhonePe',cls:'upi'},
  'UPI/Paytm':{label:'Paytm',cls:'upi'},'UPI/BHIM':{label:'BHIM',cls:'upi'},
  'Google Play':{label:'G Play',cls:'gplay'},'Debit Card':{label:'Debit',cls:'card'},
  'Credit Card':{label:'Credit',cls:'card'},'Net Banking':{label:'Netbank',cls:'net'},
  'Prepaid Card':{label:'Prepaid',cls:'card'},'Other':{label:'Other',cls:''},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Auth
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleAuthMode(){
  isSignUp=!isSignUp;
  document.getElementById('auth-name-group').style.display=isSignUp?'block':'none';
  document.getElementById('auth-submit').textContent=isSignUp?'Create Account':'Sign In';
  document.getElementById('auth-toggle').innerHTML=isSignUp
    ?'Already have an account? <span onclick="toggleAuthMode()">Sign In</span>'
    :'Don\'t have an account? <span onclick="toggleAuthMode()">Sign Up</span>';
  document.getElementById('auth-error').textContent='';
}

async function handleAuth(){
  const email=document.getElementById('auth-email').value.trim();
  const pass=document.getElementById('auth-pass').value;
  const btn=document.getElementById('auth-submit');
  const errEl=document.getElementById('auth-error');
  if(!email||!pass){errEl.textContent='Please fill in all fields.';return}
  btn.disabled=true;errEl.textContent='';
  try{
    if(isSignUp){
      const cred=await auth.createUserWithEmailAndPassword(email,pass);
      const name=document.getElementById('auth-name').value.trim();
      if(name)await cred.user.updateProfile({displayName:name});
      await db.collection('users').doc(cred.user.uid).set({email,displayName:name||'',createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    }else{
      await auth.signInWithEmailAndPassword(email,pass);
    }
  }catch(e){
    const msgs={'auth/email-already-in-use':'Email already registered','auth/invalid-email':'Invalid email','auth/weak-password':'Password must be 6+ characters','auth/user-not-found':'No account found','auth/wrong-password':'Incorrect password','auth/invalid-credential':'Invalid credentials','auth/too-many-requests':'Too many attempts. Try later.'};
    errEl.textContent=msgs[e.code]||e.message;btn.disabled=false;
  }
}

auth.onAuthStateChanged(user=>{
  currentUser=user;
  if(user){
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    loadSubscriptions();
  }else{
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app').classList.remove('visible');
    if(unsubListener)unsubListener();
    subscriptions=[];
  }
  document.getElementById('auth-submit').disabled=false;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Firestore
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function subsRef(){return db.collection('users').doc(currentUser.uid).collection('subscriptions')}

function loadSubscriptions(){
  if(unsubListener)unsubListener();
  unsubListener=subsRef().onSnapshot(snap=>{
    subscriptions=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderAll();
  },err=>{console.error(err);showToast('Error loading data','error')});
}

async function addSubscription(data){
  try{await subsRef().add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});showToast('Subscription added!','success')}
  catch(e){showToast('Failed to add','error')}
}
async function updateSubscription(id,data){
  try{await subsRef().doc(id).update(data);showToast('Updated!','success')}
  catch(e){showToast('Failed to update','error')}
}
async function deleteSubscription(id){
  try{await subsRef().doc(id).delete();showToast('Removed','success')}
  catch(e){showToast('Failed to delete','error')}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function daysUntil(dateStr){
  if(!dateStr)return 999;
  const d=new Date(dateStr);d.setHours(0,0,0,0);
  const now=new Date();now.setHours(0,0,0,0);
  return Math.ceil((d-now)/86400000);
}

function monthlyEquiv(cost,cycle){
  if(cycle==='monthly')return cost;
  if(cycle==='yearly')return cost/12;
  if(cycle==='quarterly')return cost/3;
  if(cycle==='weekly')return cost*4.33;
  return cost;
}
function yearlyEquiv(cost,cycle){
  if(cycle==='yearly')return cost;
  if(cycle==='monthly')return cost*12;
  if(cycle==='quarterly')return cost*4;
  if(cycle==='weekly')return cost*52;
  return cost;
}

function formatINR(n){return 'â‚¹'+Math.round(n).toLocaleString('en-IN')}
function fmtDate(d){
  if(!d)return 'â€”';
  const dt=new Date(d);
  return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
}
function fmtDateShort(d){
  if(!d)return 'â€”';
  const dt=new Date(d);
  return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'2-digit'});
}
function getInitials(name){return name.split(/\s+/).map(w=>w[0]).join('').substring(0,2).toUpperCase()}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function cycleLabel(c){return{monthly:'Monthly',yearly:'Yearly',weekly:'Weekly',quarterly:'Quarterly'}[c]||c}

function isEffectivelyActive(s){
  // A prepaid sub is "active" until its prepaidUntil date
  if(s.isPrepaid&&s.prepaidUntil){
    return daysUntil(s.prepaidUntil)>=0;
  }
  return true;
}

function getSubStatus(s){
  if(s.isPrepaid&&s.prepaidUntil){
    const d=daysUntil(s.prepaidUntil);
    if(d<0)return{cls:'overdue',label:'Expired'};
    if(d<=7)return{cls:'due-soon',label:`Expires in ${d}d`};
    return{cls:'prepaid',label:'Prepaid'};
  }
  const d=daysUntil(s.nextDate);
  if(d<0)return{cls:'overdue',label:'Overdue'};
  if(d===0)return{cls:'due-soon',label:'Due Today'};
  if(d<=3)return{cls:'due-soon',label:`Due in ${d}d`};
  return{cls:'active',label:'Active'};
}

function sortedSubs(list){
  const arr=[...list];
  const getEffectiveDate=s=>s.isPrepaid&&s.prepaidUntil?s.prepaidUntil:(s.nextDate||'9999-12-31');
  switch(currentSort){
    case 'date':arr.sort((a,b)=>new Date(getEffectiveDate(a))-new Date(getEffectiveDate(b)));break;
    case 'price-asc':arr.sort((a,b)=>a.cost-b.cost);break;
    case 'price-desc':arr.sort((a,b)=>b.cost-a.cost);break;
    case 'name':arr.sort((a,b)=>a.name.localeCompare(b.name));break;
  }
  return arr;
}

function filteredSubs(){
  let list=subscriptions;
  if(searchQuery){const q=searchQuery.toLowerCase();list=list.filter(s=>s.name.toLowerCase().includes(q)||(s.notes||'').toLowerCase().includes(q))}
  if(activeCategory!=='All')list=list.filter(s=>(s.category||'Other')===activeCategory);
  return sortedSubs(list);
}

function payBadgeHTML(payMode){
  if(!payMode)return '';
  const cfg=PAY_CONFIG[payMode];
  if(!cfg)return '';
  return `<span class="pay-badge ${cfg.cls}">${cfg.label}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Prepaid Toggle
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePrepaid(){
  isPrepaidMode=!isPrepaidMode;
  const row=document.getElementById('prepaid-toggle-row');
  const fields=document.getElementById('prepaid-fields');
  const hidden=document.getElementById('f-is-prepaid');
  row.classList.toggle('active',isPrepaidMode);
  fields.classList.toggle('show',isPrepaidMode);
  hidden.value=isPrepaidMode?'true':'false';
  if(isPrepaidMode)updatePrepaidEnd();
}

function updatePrepaidEnd(){
  const months=parseInt(document.getElementById('f-prepaid-months').value)||0;
  const unit=document.getElementById('f-prepaid-unit').value;
  const startDate=document.getElementById('f-date').value;
  if(!months||!startDate){document.getElementById('f-prepaid-until').value='';return;}
  const d=new Date(startDate);
  if(unit==='years')d.setFullYear(d.getFullYear()+months);
  else d.setMonth(d.getMonth()+months);
  document.getElementById('f-prepaid-until').value=d.toISOString().split('T')[0];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render All
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderDashboard();
  renderSubsList();
  renderInsights();
  renderAccount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Dashboard
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const monthly=subscriptions.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
  const yearly=subscriptions.reduce((s,i)=>s+yearlyEquiv(i.cost,i.cycle),0);

  // Urgent (due within 3 days OR prepaid expiring within 7 days)
  const urgent=subscriptions.filter(s=>{
    if(s.isPrepaid&&s.prepaidUntil){const d=daysUntil(s.prepaidUntil);return d>=0&&d<=7;}
    const d=daysUntil(s.nextDate);return d>=0&&d<=3;
  }).sort((a,b)=>{
    const dA=a.isPrepaid?daysUntil(a.prepaidUntil||''):daysUntil(a.nextDate);
    const dB=b.isPrepaid?daysUntil(b.prepaidUntil||''):daysUntil(b.nextDate);
    return dA-dB;
  });

  const urgentEl=document.getElementById('urgent-container');
  if(urgent.length){
    urgentEl.innerHTML='<div class="section-label" style="margin-bottom:10px">âš ï¸ Needs Attention</div>'+urgent.map(s=>{
      const d=s.isPrepaid?daysUntil(s.prepaidUntil||''):daysUntil(s.nextDate);
      const label=d===0?(s.isPrepaid?'Expires Today':'Due Today'):d===1?(s.isPrepaid?'Expires Tomorrow':'Due Tomorrow'):(s.isPrepaid?`Expires in ${d}d`:`Due in ${d}d`);
      return `<div class="urgent-card" onclick="openEditSheet('${s.id}')">
        <div class="urgent-icon" style="background:${(TEMPLATES.find(t=>t.name===s.name)||{color:'rgba(255,77,109,.12)'}).color}22">${s.logo?`<img src="${esc(s.logo)}" onerror="this.parentNode.innerHTML='${getInitials(s.name)}'">`:getInitials(s.name)}</div>
        <div class="urgent-info">
          <div class="urgent-name">${esc(s.name)}</div>
          <div class="urgent-detail">${label}</div>
        </div>
        <div class="urgent-amount">${formatINR(s.cost)}</div>
      </div>`;
    }).join('');
  }else{urgentEl.innerHTML=''}

  // Metrics
  document.getElementById('metrics-container').innerHTML=`
    <div class="metric-card">
      <div class="metric-accent"></div>
      <div class="metric-label">Monthly Outflow</div>
      <div class="metric-value"><span class="cur">â‚¹</span>${Math.round(monthly).toLocaleString('en-IN')}</div>
      <div class="metric-sub">${subscriptions.length} subscription${subscriptions.length!==1?'s':''}</div>
    </div>
    <div class="metric-card">
      <div class="metric-accent" style="background:rgba(34,211,160,.15)"></div>
      <div class="metric-label">Yearly Outflow</div>
      <div class="metric-value"><span class="cur">â‚¹</span>${Math.round(yearly).toLocaleString('en-IN')}</div>
      <div class="metric-sub">${formatINR(monthly*12/365)}/day</div>
    </div>`;

  renderChart(monthly);

  // Recent upcoming
  const recent=sortedSubs(subscriptions).filter(s=>!s.isPrepaid||daysUntil(s.prepaidUntil||'')>=0).slice(0,6);
  const recentEl=document.getElementById('dashboard-recent');
  if(!recent.length){
    recentEl.innerHTML=`<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg></div><h3>No Subscriptions Yet</h3><p>Tap + to add your first subscription and start tracking your spending.</p></div>`;
    return;
  }
  recentEl.innerHTML=recent.map(s=>renderSubCard(s)).join('');
  initSwipe(recentEl);
}

function renderChart(monthlyTotal){
  const bars=document.getElementById('chart-bars');
  const now=new Date();
  const months=Array.from({length:6},(_,i)=>{
    const d=new Date(now.getFullYear(),now.getMonth()+i,1);
    // Use actual upcoming subs for current month, project others
    const factor=i===0?1:(1+((Math.random()-.5)*.06));
    return{label:d.toLocaleDateString('en-IN',{month:'short'}),year:d.getFullYear().toString().slice(2),val:monthlyTotal*factor,current:i===0};
  });
  const max=Math.max(...months.map(m=>m.val),1);
  bars.innerHTML=months.map(m=>{
    const h=Math.max((m.val/max)*110,4);
    return `<div class="chart-bar-wrap">
      <div class="chart-bar ${m.current?'current':''}" style="height:${h}px">
        <span class="chart-bar-val">${formatINR(m.val)}</span>
      </div>
      <span class="chart-bar-label">${m.label} '${m.year}</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sub Card
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSubCard(s){
  const status=getSubStatus(s);
  const tmpl=TEMPLATES.find(t=>t.name===s.name);
  const brandColor=s.brandColor||tmpl?.color||'var(--accent)';
  const effectiveDate=s.isPrepaid?s.prepaidUntil:s.nextDate;
  const d=s.isPrepaid?daysUntil(s.prepaidUntil||''):daysUntil(s.nextDate||'');
  
  // Prepaid bar
  let prepaidBarHTML='';
  if(s.isPrepaid&&s.prepaidUntil&&s.nextDate){
    const total=daysUntil(s.prepaidUntil)-daysUntil(s.nextDate)+daysUntil(s.nextDate);
    const daysLeft=Math.max(0,daysUntil(s.prepaidUntil));
    // Estimate total prepaid days
    const prepaidMonths=s.prepaidMonths||12;
    const prepaidUnit=s.prepaidUnit||'months';
    const totalDays=prepaidUnit==='years'?prepaidMonths*365:prepaidMonths*30;
    const pct=Math.max(0,Math.min(100,(daysLeft/totalDays)*100));
    prepaidBarHTML=`<div class="prepaid-bar-wrap">
      <div class="prepaid-bar"><div class="prepaid-bar-inner" style="width:${pct}%"></div></div>
      <span class="prepaid-bar-text">${daysLeft}d left</span>
    </div>`;
  }

  const payBadge=payBadgeHTML(s.paymentMode);

  return `<div class="sub-card-wrapper" data-id="${s.id}" style="max-height:200px">
    <div class="sub-card-delete-bg"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
    <div class="sub-card" data-id="${s.id}" onclick="openEditSheet('${s.id}')">
      <div class="sub-logo" style="background:${brandColor}18">${s.logo?`<img src="${esc(s.logo)}" onerror="this.parentNode.innerHTML='${getInitials(s.name)}'">`:getInitials(s.name)}</div>
      <div class="sub-info">
        <div class="sub-name">${esc(s.name)}</div>
        <div class="sub-meta">
          <span class="sub-status-dot ${status.cls}"></span>
          <span class="sub-cycle">${cycleLabel(s.cycle)}</span>
          ${payBadge}
          ${s.isPrepaid?'<span class="pay-badge prepaid-badge">Prepaid</span>':''}
        </div>
        ${prepaidBarHTML}
      </div>
      <div class="sub-right">
        <div class="sub-price">${formatINR(s.cost)}</div>
        <div class="sub-next">${s.isPrepaid?`Until ${fmtDateShort(s.prepaidUntil)}`:(d<0?'âš  Overdue':fmtDateShort(s.nextDate))}</div>
      </div>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Active Subs Tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSubsList(){
  const categories=['All',...[...new Set(subscriptions.map(s=>s.category||'Other'))].sort()];
  document.getElementById('category-filters').innerHTML=categories.map(c=>`<button class="cat-tag${activeCategory===c?' active':''}" onclick="setCategory('${c}')">${c}</button>`).join('');

  const list=filteredSubs();
  
  // Summary strip
  const stripEl=document.getElementById('subs-summary-strip');
  if(list.length){
    const m=list.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
    const overdue=list.filter(s=>!s.isPrepaid&&daysUntil(s.nextDate)<0).length;
    stripEl.innerHTML=`<div class="summary-strip">
      <div class="strip-item"><div class="strip-val">${list.length}</div><div class="strip-lbl">Active</div></div>
      <div class="strip-div"></div>
      <div class="strip-item"><div class="strip-val">${formatINR(m)}</div><div class="strip-lbl">Monthly</div></div>
      <div class="strip-div"></div>
      <div class="strip-item"><div class="strip-val" style="color:${overdue?'var(--danger)':'var(--success)'}">${overdue}</div><div class="strip-lbl">Overdue</div></div>
    </div>`;
  }else{stripEl.innerHTML=''}

  const el=document.getElementById('subs-list');
  if(!list.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div><h3>No subscriptions found</h3><p>Try a different filter, or add a new subscription with the + button.</p></div>`;
    return;
  }
  el.innerHTML=list.map(s=>renderSubCard(s)).join('');
  initSwipe(el);
}

function setCategory(c){activeCategory=c;renderSubsList()}
function filterSubs(q){searchQuery=q;renderSubsList()}
function openSearch(){
  const el=document.getElementById('subs-search');
  if(currentTab!=='subs')switchTab('subs');
  const isOpen=el.style.display!=='none';
  el.style.display=isOpen?'none':'block';
  if(!isOpen){el.querySelector('input').focus();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Insights
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInsights(){
  const el=document.getElementById('insights-content');
  if(!subscriptions.length){
    el.innerHTML=`<div class="empty-state"><div class="empty-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div><h3>No insights yet</h3><p>Add subscriptions to unlock detailed spending analytics.</p></div>`;
    return;
  }

  const monthly=subscriptions.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
  const yearly=subscriptions.reduce((s,i)=>s+yearlyEquiv(i.cost,i.cycle),0);
  const daily=monthly/30;

  const catMap={};
  subscriptions.forEach(s=>{const c=s.category||'Other';catMap[c]=(catMap[c]||0)+monthlyEquiv(s.cost,s.cycle)});
  const catEntries=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const colors=['#7c5cfc','#ec4899','#f59e0b','#22d3a0','#38bdf8','#ef4444','#a78bfa','#f97316','#6366f1'];

  const most=subscriptions.reduce((a,b)=>monthlyEquiv(a.cost,a.cycle)>monthlyEquiv(b.cost,b.cycle)?a:b);
  const least=subscriptions.reduce((a,b)=>monthlyEquiv(a.cost,a.cycle)<monthlyEquiv(b.cost,b.cycle)?a:b);

  // Pay mode breakdown
  const payMap={};
  subscriptions.forEach(s=>{const p=s.paymentMode||'Not Set';payMap[p]=(payMap[p]||0)+1});
  const payEntries=Object.entries(payMap).sort((a,b)=>b[1]-a[1]);

  // SVG donut
  const total=catEntries.reduce((s,e)=>s+e[1],0);
  let cumPct=0;
  const r=48,cx=60,cy=60;
  const donutParts=catEntries.map((e,i)=>{
    const pct=e[1]/total*100;const startAngle=cumPct*3.6;cumPct+=pct;
    const endAngle=cumPct*3.6;const large=pct>50?1:0;
    const x1=cx+r*Math.cos((startAngle-90)*Math.PI/180);
    const y1=cy+r*Math.sin((startAngle-90)*Math.PI/180);
    const x2=cx+r*Math.cos((endAngle-90)*Math.PI/180);
    const y2=cy+r*Math.sin((endAngle-90)*Math.PI/180);
    return `<path d="M${cx},${cy} L${x1.toFixed(2)},${y1.toFixed(2)} A${r},${r} 0 ${large},1 ${x2.toFixed(2)},${y2.toFixed(2)} Z" fill="${colors[i%colors.length]}" opacity="0.88"/>`;
  }).join('');

  // Upcoming sorted
  const upcoming=sortedSubs(subscriptions).filter(s=>{
    if(s.isPrepaid)return daysUntil(s.prepaidUntil||'')>=0;
    return daysUntil(s.nextDate||'')>=0;
  }).slice(0,8);

  el.innerHTML=`
  <div class="insight-card">
    <h3><span class="icon">ğŸ“Š</span> Spending by Category</h3>
    <div class="donut-container">
      <svg class="donut-chart" viewBox="0 0 120 120">${donutParts}
        <circle cx="${cx}" cy="${cy}" r="28" fill="var(--surface)"/>
        <text x="${cx}" y="${cy-5}" text-anchor="middle" fill="var(--text)" font-size="11" font-weight="800" font-family="Sora,sans-serif">${formatINR(monthly)}</text>
        <text x="${cx}" y="${cy+9}" text-anchor="middle" fill="var(--text3)" font-size="7" font-family="Sora,sans-serif">/month</text>
      </svg>
      <div class="donut-legend">${catEntries.map((e,i)=>`<div class="legend-item"><div class="legend-dot" style="background:${colors[i%colors.length]}"></div><span class="legend-name">${esc(e[0])}</span><span class="legend-val">${formatINR(e[1])}</span></div>`).join('')}</div>
    </div>
  </div>
  <div class="insight-card">
    <h3><span class="icon">ğŸ’¡</span> Quick Stats</h3>
    <div class="stat-row"><span class="stat-label">Total subscriptions</span><span class="stat-value">${subscriptions.length}</span></div>
    <div class="stat-row"><span class="stat-label">Daily cost</span><span class="stat-value">${formatINR(daily)}/day</span></div>
    <div class="stat-row"><span class="stat-label">Avg per subscription</span><span class="stat-value">${formatINR(monthly/subscriptions.length)}/mo</span></div>
    <div class="stat-row"><span class="stat-label">Most expensive</span><span class="stat-value">${esc(most.name)} Â· ${formatINR(monthlyEquiv(most.cost,most.cycle))}/mo</span></div>
    <div class="stat-row"><span class="stat-label">Cheapest</span><span class="stat-value">${esc(least.name)} Â· ${formatINR(monthlyEquiv(least.cost,least.cycle))}/mo</span></div>
    <div class="stat-row"><span class="stat-label">Annual total</span><span class="stat-value">${formatINR(yearly)}</span></div>
    <div class="stat-row"><span class="stat-label">Prepaid subs</span><span class="stat-value">${subscriptions.filter(s=>s.isPrepaid).length}</span></div>
  </div>
  <div class="insight-card">
    <h3><span class="icon">ğŸ’³</span> Payment Methods</h3>
    ${payEntries.map(([p,n])=>`<div class="stat-row"><span class="stat-label">${esc(p)}</span><span class="stat-value">${n} sub${n!==1?'s':''}</span></div>`).join('')}
  </div>
  <div class="insight-card">
    <h3><span class="icon">ğŸ“…</span> Upcoming Renewals</h3>
    ${upcoming.map(s=>{
      const dateStr=s.isPrepaid?`Until ${fmtDate(s.prepaidUntil)}`:`${fmtDate(s.nextDate)}`;
      return `<div class="stat-row"><span class="stat-label">${esc(s.name)}${s.isPrepaid?' ğŸŸï¸':''}</span><span class="stat-value">${dateStr} Â· ${formatINR(s.cost)}</span></div>`;
    }).join('')||'<p style="color:var(--text3);font-size:12px;padding:8px 0">No upcoming renewals</p>'}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Account
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAccount(){
  if(!currentUser)return;
  const el=document.getElementById('account-content');
  const name=currentUser.displayName||currentUser.email.split('@')[0];
  const monthly=subscriptions.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
  const year=new Date().getFullYear();
  el.innerHTML=`
    <div class="account-avatar">${getInitials(name)}</div>
    <div class="account-name">${esc(name)}</div>
    <div class="account-email">${esc(currentUser.email)}</div>
    <div class="account-section">
      <div class="account-section-title">Summary</div>
      <div class="account-item">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
        <span>${subscriptions.length} Active Subscription${subscriptions.length!==1?'s':''}</span>
      </div>
      <div class="account-item">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        <span>${formatINR(monthly)}/month Â· ${formatINR(monthly*12)}/year</span>
      </div>
      <div class="account-item">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
        <span>${subscriptions.filter(s=>s.isPrepaid).length} Prepaid Subscription${subscriptions.filter(s=>s.isPrepaid).length!==1?'s':''}</span>
      </div>
    </div>
    <div class="account-section">
      <div class="account-section-title">Export Data</div>
      <div class="account-item" onclick="exportCSV()">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>Export as CSV</span>
        <svg class="chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="account-item" onclick="exportJSON()">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span>Export as JSON</span>
        <svg class="chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>
    <div class="account-section">
      <div class="account-section-title">Account</div>
      <div class="account-item danger" onclick="handleSignOut()">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span>Sign Out</span>
      </div>
    </div>
    <div class="account-footer">
      <strong>SubsTrack</strong> v2.0 &nbsp;Â·&nbsp; Made for India ğŸ‡®ğŸ‡³<br>
      <strong>Arnav Dugad</strong> Â© ${year}
    </div>`;
}

function handleSignOut(){auth.signOut()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){
  const rows=[['Name','Cost (â‚¹)','Cycle','Category','Payment Mode','Next Billing','Prepaid','Prepaid Until','Notes']];
  subscriptions.forEach(s=>rows.push([s.name,s.cost,s.cycle,s.category||'',s.paymentMode||'',s.nextDate||'',s.isPrepaid?'Yes':'No',s.prepaidUntil||'',s.notes||'']));
  downloadFile(rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n'),'subscriptions.csv','text/csv');
  showToast('CSV exported','success');
}
function exportJSON(){
  const data=subscriptions.map(({id,createdAt,...rest})=>rest);
  downloadFile(JSON.stringify(data,null,2),'subscriptions.json','application/json');
  showToast('JSON exported','success');
}
function downloadFile(content,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=name;a.click();URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Navigation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.toggle('active',el.dataset.tab===tab));
  updateNavIndicator();
  document.getElementById('main-scroll').scrollTop=0;
}

function updateNavIndicator(){
  const activeBtn=document.querySelector('.nav-item.active');
  const ind=document.getElementById('nav-indicator');
  if(!activeBtn)return;
  const rect=activeBtn.getBoundingClientRect();
  const navRect=activeBtn.parentElement.getBoundingClientRect();
  ind.style.left=(rect.left-navRect.left+rect.width*.25)+'px';
  ind.style.width=(rect.width*.5)+'px';
}
window.addEventListener('resize',updateNavIndicator);
setTimeout(updateNavIndicator,120);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sort
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSort(){
  document.getElementById('sort-menu').classList.toggle('open');
}
document.querySelectorAll('.sort-option').forEach(btn=>{
  btn.addEventListener('click',()=>{
    currentSort=btn.dataset.sort;
    document.querySelectorAll('.sort-option').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('sort-menu').classList.remove('open');
    renderAll();
  });
});
document.addEventListener('click',e=>{
  if(!e.target.closest('.sort-dropdown')&&!e.target.closest('[onclick="toggleSort()"]'))
    document.getElementById('sort-menu').classList.remove('open');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Bottom Sheet
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddSheet(){
  editingId=null;isPrepaidMode=false;
  document.getElementById('bs-title').textContent='New Subscription';
  document.getElementById('f-submit-btn').textContent='Add Subscription';
  document.getElementById('sub-form').reset();
  document.getElementById('f-edit-id').value='';
  document.getElementById('f-is-prepaid').value='false';
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('prepaid-toggle-row').classList.remove('active');
  document.getElementById('prepaid-fields').classList.remove('show');
  document.querySelectorAll('.template-btn').forEach(b=>b.classList.remove('selected'));
  openSheet();
}

function openEditSheet(id){
  const sub=subscriptions.find(s=>s.id===id);
  if(!sub)return;
  editingId=id;
  isPrepaidMode=!!sub.isPrepaid;
  document.getElementById('bs-title').textContent='Edit Subscription';
  document.getElementById('f-submit-btn').textContent='Save Changes';
  document.getElementById('f-name').value=sub.name||'';
  document.getElementById('f-logo').value=sub.logo||'';
  document.getElementById('f-cost').value=sub.cost||'';
  document.getElementById('f-cycle').value=sub.cycle||'monthly';
  document.getElementById('f-date').value=sub.nextDate||'';
  document.getElementById('f-category').value=sub.category||'Entertainment';
  document.getElementById('f-payment').value=sub.paymentMode||'';
  document.getElementById('f-notes').value=sub.notes||'';
  document.getElementById('f-edit-id').value=id;
  document.getElementById('f-is-prepaid').value=isPrepaidMode?'true':'false';
  // Prepaid fields
  document.getElementById('prepaid-toggle-row').classList.toggle('active',isPrepaidMode);
  document.getElementById('prepaid-fields').classList.toggle('show',isPrepaidMode);
  if(isPrepaidMode){
    document.getElementById('f-prepaid-months').value=sub.prepaidMonths||'';
    document.getElementById('f-prepaid-unit').value=sub.prepaidUnit||'months';
    document.getElementById('f-prepaid-until').value=sub.prepaidUntil||'';
  }
  openSheet();
}

function openSheet(){
  document.getElementById('bs-overlay').classList.add('open');
  document.getElementById('bottom-sheet').classList.add('open');
}
function closeSheet(){
  document.getElementById('bs-overlay').classList.remove('open');
  document.getElementById('bottom-sheet').classList.remove('open');
}

// Templates
function renderTemplates(){
  document.getElementById('templates-grid').innerHTML=TEMPLATES.map((t,i)=>`
    <button class="template-btn" type="button" onclick="selectTemplate(${i})">
      <div class="template-icon" style="background:${t.color}22"><img src="${t.logo}" onerror="this.parentNode.style.background='${t.color}';this.parentNode.textContent='${getInitials(t.name)}'"></div>
      <span class="template-name">${t.name}</span>
    </button>`).join('');
}
renderTemplates();

function selectTemplate(i){
  const t=TEMPLATES[i];
  document.getElementById('f-name').value=t.name;
  document.getElementById('f-logo').value=t.logo;
  document.getElementById('f-cost').value=t.cost;
  document.getElementById('f-cycle').value=t.cycle;
  document.getElementById('f-category').value=t.category;
  document.querySelectorAll('.template-btn').forEach((b,j)=>b.classList.toggle('selected',j===i));
}

// Form submit
function handleSubForm(e){
  e.preventDefault();
  const isPrepaid=document.getElementById('f-is-prepaid').value==='true';
  const prepaidMonths=parseInt(document.getElementById('f-prepaid-months').value)||0;
  const prepaidUnit=document.getElementById('f-prepaid-unit').value||'months';
  const prepaidUntil=document.getElementById('f-prepaid-until').value||'';

  const data={
    name:document.getElementById('f-name').value.trim(),
    logo:document.getElementById('f-logo').value.trim()||'',
    cost:parseFloat(document.getElementById('f-cost').value),
    cycle:document.getElementById('f-cycle').value,
    nextDate:document.getElementById('f-date').value,
    category:document.getElementById('f-category').value,
    paymentMode:document.getElementById('f-payment').value||'',
    notes:document.getElementById('f-notes').value.trim(),
    isPrepaid,
    prepaidMonths:isPrepaid?prepaidMonths:0,
    prepaidUnit:isPrepaid?prepaidUnit:'months',
    prepaidUntil:isPrepaid?prepaidUntil:'',
  };
  const tmpl=TEMPLATES.find(t=>t.name.toLowerCase()===data.name.toLowerCase());
  if(tmpl&&!data.logo)data.logo=tmpl.logo;
  if(tmpl)data.brandColor=tmpl.color;

  if(editingId)updateSubscription(editingId,data);
  else addSubscription(data);
  closeSheet();
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Swipe to Delete
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSwipe(container){
  container.querySelectorAll('.sub-card').forEach(card=>{
    let startX=0,currentX=0,isDragging=false;
    const wrapper=card.closest('.sub-card-wrapper');
    card.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;isDragging=false;card.style.transition='none'},{passive:true});
    card.addEventListener('touchmove',e=>{
      const dx=e.touches[0].clientX-startX;
      if(dx<-12){isDragging=true;card.classList.add('swiping')}
      if(isDragging){currentX=Math.min(0,Math.max(dx,-110));card.style.transform=`translateX(${currentX}px)`}
    },{passive:true});
    card.addEventListener('touchend',()=>{
      card.style.transition='transform .3s var(--spring)';
      if(currentX<-70){
        card.style.transform='translateX(-110%)';
        const id=card.dataset.id;
        setTimeout(()=>{wrapper.classList.add('removing');setTimeout(()=>deleteSubscription(id),350)},120);
      }else{card.style.transform='translateX(0)'}
      setTimeout(()=>card.classList.remove('swiping'),300);
      currentX=0;isDragging=false;
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Pull to Refresh
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const scroll=document.getElementById('main-scroll');
  const ptr=document.getElementById('ptr-indicator');
  let startY=0,pulling=false;
  scroll.addEventListener('touchstart',e=>{if(scroll.scrollTop<=0)startY=e.touches[0].clientY},{passive:true});
  scroll.addEventListener('touchmove',e=>{
    if(scroll.scrollTop>0)return;
    const dy=e.touches[0].clientY-startY;
    if(dy>0&&dy<100){pulling=true;ptr.style.height=Math.min(dy*.55,44)+'px';ptr.querySelector('svg').style.transform=`rotate(${dy*3}deg)`}
  },{passive:true});
  scroll.addEventListener('touchend',()=>{
    if(pulling&&parseInt(ptr.style.height)>32){
      ptr.classList.add('refreshing');ptr.querySelector('span').textContent='Syncingâ€¦';ptr.style.height='44px';
      loadSubscriptions();
      setTimeout(()=>{ptr.classList.remove('refreshing');ptr.style.height='0';ptr.querySelector('span').textContent='Syncingâ€¦'},1500);
    }else{ptr.style.height='0'}
    pulling=false;
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Toast
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  const icon=document.getElementById('toast-icon');
  t.className='toast '+type;
  icon.textContent=type==='success'?'âœ“':'âœ•';
  document.getElementById('toast-msg').textContent=msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer=setTimeout(()=>t.classList.remove('show'),2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Keyboard helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('auth-pass').addEventListener('keydown',e=>{if(e.key==='Enter')handleAuth()});
document.getElementById('auth-email').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('auth-pass').focus()});

// Auto-update prepaid end when date changes
document.getElementById('f-date').addEventListener('change',()=>{if(isPrepaidMode)updatePrepaidEnd()});
</script>
</body>
</html>
