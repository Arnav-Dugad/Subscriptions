<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#0A0A0A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SubsTrack">
<meta name="description" content="Smart Subscription Manager for India">
<title>SubsTrack â€” Subscription Manager</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3Vic1RyYWNrIiwic2hvcnRfbmFtZSI6IlN1YnNUcmFjayIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMEEwQTBBIiwidGhlbWVfY29sb3IiOiIjMEEwQTBBIn0=">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#0A0A0A;--surface:#171717;--surface2:#1E1E1E;--surface3:#252525;
--accent:#8B5CF6;--accent-glow:rgba(139,92,246,.25);--accent-dim:rgba(139,92,246,.1);
--text:#F5F5F5;--text2:#A3A3A3;--text3:#6B6B6B;
--danger:#EF4444;--danger-glow:rgba(239,68,68,.4);
--success:#22C55E;--warning:#F59E0B;
--radius:16px;--radius-sm:10px;--radius-xs:8px;
--safe-bottom:env(safe-area-inset-bottom,0px);
--safe-top:env(safe-area-inset-top,0px);
--nav-h:72px;
--ease-spring:cubic-bezier(0.32,0.72,0,1);
}
html{background:var(--bg);overflow:hidden;height:100%;overscroll-behavior:none}
body{font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;overscroll-behavior:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
input,button,select,textarea{font-family:inherit;border:none;outline:none;background:none;color:inherit}
button{cursor:pointer}

/* Skeleton Loader */
.skeleton{background:linear-gradient(90deg,var(--surface) 25%,var(--surface2) 50%,var(--surface) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite linear;border-radius:var(--radius-xs)}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-text{height:14px;margin:6px 0;border-radius:4px}
.skeleton-title{height:22px;width:60%;margin:8px 0;border-radius:6px}
.skeleton-card{height:80px;border-radius:var(--radius);margin-bottom:12px}
.skeleton-metric{height:100px;border-radius:var(--radius);flex:1}

/* Auth Screen */
#auth-screen{position:fixed;inset:0;z-index:1000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;transition:opacity .4s,transform .4s}
#auth-screen.hidden{opacity:0;pointer-events:none;transform:scale(1.02)}
.auth-logo{width:72px;height:72px;border-radius:20px;background:linear-gradient(135deg,var(--accent),#6D28D9);display:flex;align-items:center;justify-content:center;margin-bottom:16px;box-shadow:0 8px 32px var(--accent-glow)}
.auth-logo svg{width:36px;height:36px;fill:#fff}
.auth-title{font-size:28px;font-weight:800;margin-bottom:4px;letter-spacing:-.5px}
.auth-subtitle{font-size:14px;color:var(--text2);margin-bottom:32px}
.auth-form{width:100%;max-width:380px}
.auth-input-group{position:relative;margin-bottom:16px}
.auth-input-group input{width:100%;height:52px;background:var(--surface);border:1.5px solid var(--surface3);border-radius:var(--radius-sm);padding:0 16px;font-size:15px;transition:border-color .2s}
.auth-input-group input:focus{border-color:var(--accent)}
.auth-input-group label{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--text3);pointer-events:none;transition:.2s}
.auth-input-group input:focus+label,.auth-input-group input:not(:placeholder-shown)+label{top:8px;font-size:10px;transform:none;color:var(--accent)}
.auth-btn{width:100%;height:52px;background:var(--accent);border-radius:var(--radius-sm);font-size:15px;font-weight:700;color:#fff;transition:transform .2s,opacity .2s;margin-top:8px}
.auth-btn:active{transform:scale(0.97)}
.auth-btn:disabled{opacity:.5}
.auth-toggle{text-align:center;margin-top:20px;font-size:13px;color:var(--text2)}
.auth-toggle span{color:var(--accent);font-weight:600;cursor:pointer}
.auth-error{color:var(--danger);font-size:12px;text-align:center;margin-top:8px;min-height:18px}
.auth-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--text3);font-size:12px}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--surface3)}

/* App Shell */
#app{height:100%;display:flex;flex-direction:column;opacity:0;transition:opacity .4s}
#app.visible{opacity:1}
.app-header{position:sticky;top:0;z-index:50;padding:12px 20px;padding-top:calc(12px + var(--safe-top));background:rgba(10,10,10,.82);-webkit-backdrop-filter:blur(24px) saturate(180%);backdrop-filter:blur(24px) saturate(180%);border-bottom:1px solid rgba(255,255,255,.04)}
.app-header-inner{display:flex;align-items:center;justify-content:space-between}
.app-header h1{font-size:22px;font-weight:800;letter-spacing:-.5px}
.app-header h1 span{color:var(--accent)}
.header-actions{display:flex;gap:8px}
.header-btn{width:38px;height:38px;border-radius:50%;background:var(--surface);display:flex;align-items:center;justify-content:center;transition:transform .2s}
.header-btn:active{transform:scale(0.9)}
.header-btn svg{width:18px;height:18px;stroke:var(--text2);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

/* Main Content */
.main-scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;padding-bottom:calc(var(--nav-h) + var(--safe-bottom) + 80px)}

/* Pull to Refresh */
.ptr-indicator{text-align:center;padding:0;height:0;overflow:hidden;transition:height .3s var(--ease-spring);color:var(--accent);font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px}
.ptr-indicator svg{width:18px;height:18px;stroke:var(--accent);fill:none;stroke-width:2;transition:transform .3s}
.ptr-indicator.refreshing svg{animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Tab Content */
.tab-content{display:none;padding:16px 20px;animation:fadeUp .3s ease}
.tab-content.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

/* Dashboard - Urgent Warnings */
.urgent-section{margin-bottom:20px}
.urgent-card{background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(239,68,68,.03));border:1px solid rgba(239,68,68,.15);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:14px;margin-bottom:10px;animation:urgentPulse 2s ease-in-out infinite;transition:transform .2s,opacity .4s}
.urgent-card:active{transform:scale(0.96)}
@keyframes urgentPulse{0%,100%{box-shadow:0 0 15px rgba(239,68,68,.4)}50%{box-shadow:0 0 25px rgba(239,68,68,.2)}}
.urgent-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:22px;background:rgba(239,68,68,.12)}
.urgent-info{flex:1;min-width:0}
.urgent-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.urgent-detail{font-size:12px;color:var(--danger);font-weight:600;margin-top:2px}
.urgent-amount{font-size:16px;font-weight:800;white-space:nowrap}
.section-label{font-size:11px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.section-label::after{content:'';flex:1;height:1px;background:var(--surface3)}

/* Metrics */
.metrics-row{display:flex;gap:12px;margin-bottom:20px}
.metric-card{flex:1;background:var(--surface);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden}
.metric-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);border-radius:2px 2px 0 0}
.metric-label{font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.6px}
.metric-value{font-size:22px;font-weight:800;margin-top:6px;letter-spacing:-.5px}
.metric-value span{font-size:14px;font-weight:600;color:var(--text2)}

/* 6-Month Chart */
.chart-section{margin-bottom:24px}
.chart-container{background:var(--surface);border-radius:var(--radius);padding:16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.chart-container::-webkit-scrollbar{display:none}
.chart-bars{display:flex;align-items:flex-end;gap:10px;height:140px;min-width:max-content;padding:0 4px}
.chart-bar-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:52px}
.chart-bar{width:36px;border-radius:8px 8px 4px 4px;background:linear-gradient(180deg,var(--accent),rgba(139,92,246,.4));min-height:4px;transition:height .6s var(--ease-spring);position:relative}
.chart-bar-val{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:700;white-space:nowrap;color:var(--text2)}
.chart-bar-label{font-size:10px;color:var(--text3);font-weight:600}
.chart-bar.current{background:linear-gradient(180deg,var(--accent),#7C3AED);box-shadow:0 4px 16px var(--accent-glow)}

/* Subscription Cards */
.sub-list{display:flex;flex-direction:column;gap:10px}
.sub-card-wrapper{position:relative;overflow:hidden;border-radius:var(--radius);transition:max-height .4s var(--ease-spring),opacity .4s,margin .4s,padding .4s}
.sub-card-wrapper.removing{max-height:0!important;opacity:0;margin:0;padding:0;overflow:hidden}
.sub-card-delete-bg{position:absolute;right:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,transparent 60%,var(--danger));display:flex;align-items:center;justify-content:flex-end;padding-right:24px;border-radius:var(--radius)}
.sub-card-delete-bg svg{width:24px;height:24px;stroke:#fff;fill:none;stroke-width:2}
.sub-card{background:var(--surface);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:14px;position:relative;transition:transform .15s ease-out;will-change:transform;touch-action:pan-y;user-select:none;-webkit-user-select:none}
.sub-card:active{transform:scale(0.96);transition:transform .2s ease-out}
.sub-card.swiping:active{transform:none}
.sub-logo{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px;font-weight:800;color:#fff;background:var(--surface3);overflow:hidden;position:relative}
.sub-logo img{width:100%;height:100%;object-fit:contain;padding:6px}
.sub-logo.glow{box-shadow:0 0 20px var(--glow-color,var(--accent-glow))}
.sub-info{flex:1;min-width:0}
.sub-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sub-cycle{font-size:11px;color:var(--text3);margin-top:2px;font-weight:500}
.sub-right{text-align:right;flex-shrink:0}
.sub-price{font-size:16px;font-weight:800}
.sub-next{font-size:11px;color:var(--text3);margin-top:2px;font-weight:500}
.sub-status-dot{width:6px;height:6px;border-radius:50%;display:inline-block;margin-right:4px}
.sub-status-dot.active{background:var(--success)}
.sub-status-dot.due-soon{background:var(--warning)}
.sub-status-dot.overdue{background:var(--danger)}

/* Empty State */
.empty-state{text-align:center;padding:48px 24px}
.empty-state svg{width:64px;height:64px;stroke:var(--text3);fill:none;stroke-width:1.5;margin-bottom:16px}
.empty-state h3{font-size:18px;font-weight:700;margin-bottom:6px}
.empty-state p{font-size:13px;color:var(--text3);line-height:1.5}

/* Insights Tab */
.insight-card{background:var(--surface);border-radius:var(--radius);padding:18px;margin-bottom:14px}
.insight-card h3{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.insight-card h3 span{font-size:18px}
.donut-container{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.donut-chart{width:140px;height:140px;flex-shrink:0}
.donut-legend{display:flex;flex-direction:column;gap:8px;flex:1;min-width:120px}
.legend-item{display:flex;align-items:center;gap:8px;font-size:12px}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.legend-name{flex:1;color:var(--text2)}
.legend-val{font-weight:700;font-size:13px}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--surface3)}
.stat-row:last-child{border-bottom:none}
.stat-label{font-size:13px;color:var(--text2)}
.stat-value{font-size:14px;font-weight:700}
.trend-badge{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:700;padding:3px 8px;border-radius:20px}
.trend-badge.up{background:rgba(239,68,68,.1);color:var(--danger)}
.trend-badge.down{background:rgba(34,197,94,.1);color:var(--success)}
.trend-badge.neutral{background:var(--surface3);color:var(--text3)}

/* Account Tab */
.account-avatar{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6D28D9);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#fff;margin:0 auto 12px;box-shadow:0 8px 24px var(--accent-glow)}
.account-email{text-align:center;font-size:14px;color:var(--text2);margin-bottom:24px;word-break:break-all}
.account-section{margin-bottom:20px}
.account-section-title{font-size:11px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:10px}
.account-item{background:var(--surface);border-radius:var(--radius-sm);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;transition:transform .2s}
.account-item:active{transform:scale(0.97)}
.account-item svg{width:20px;height:20px;stroke:var(--text2);fill:none;stroke-width:2;flex-shrink:0}
.account-item span{flex:1;font-size:14px;font-weight:500}
.account-item .chevron{width:16px;height:16px;stroke:var(--text3)}
.account-item.danger span{color:var(--danger)}
.account-item.danger svg{stroke:var(--danger)}

/* Bottom Nav */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(23,23,23,.78);-webkit-backdrop-filter:blur(24px) saturate(180%);backdrop-filter:blur(24px) saturate(180%);border-top:1px solid rgba(255,255,255,.04);padding-bottom:var(--safe-bottom)}
.bottom-nav-inner{display:flex;height:var(--nav-h);align-items:center}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--text3);transition:color .2s;-webkit-tap-highlight-color:transparent;padding:8px 0}
.nav-item.active{color:var(--accent)}
.nav-item svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:transform .2s}
.nav-item.active svg{transform:scale(1.1)}
.nav-item span{font-size:10px;font-weight:600;letter-spacing:.3px}
.nav-indicator{position:absolute;top:-1px;height:2px;background:var(--accent);border-radius:0 0 2px 2px;transition:left .3s var(--ease-spring),width .3s var(--ease-spring);box-shadow:0 0 8px var(--accent-glow)}

/* FAB */
.fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-bottom) + 16px);right:20px;z-index:90;width:56px;height:56px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px var(--accent-glow);transition:transform .2s,box-shadow .2s}
.fab:active{transform:scale(0.9)}
.fab svg{width:24px;height:24px;stroke:#fff;fill:none;stroke-width:2.5;stroke-linecap:round}

/* Bottom Sheet Overlay */
.bs-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:opacity .3s}
.bs-overlay.open{opacity:1;pointer-events:auto}

/* Bottom Sheet */
.bottom-sheet{position:fixed;bottom:0;left:0;right:0;z-index:201;background:var(--surface);border-radius:24px 24px 0 0;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 300ms var(--ease-spring);padding-bottom:var(--safe-bottom)}
.bottom-sheet.open{transform:translateY(0)}
.bs-handle{width:40px;height:4px;background:var(--surface3);border-radius:4px;margin:10px auto}
.bs-header{display:flex;align-items:center;justify-content:space-between;padding:8px 20px 16px;flex-shrink:0}
.bs-header h2{font-size:18px;font-weight:800}
.bs-close{width:32px;height:32px;border-radius:50%;background:var(--surface3);display:flex;align-items:center;justify-content:center}
.bs-close svg{width:16px;height:16px;stroke:var(--text2);fill:none;stroke-width:2.5}
.bs-body{overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 20px 24px;flex:1}

/* Templates Grid */
.templates-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;margin-bottom:12px}
.templates-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px}
.template-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 4px;border-radius:var(--radius-sm);background:var(--surface2);transition:transform .2s,box-shadow .2s;border:1px solid transparent}
.template-btn:active{transform:scale(0.92)}
.template-btn.selected{border-color:var(--accent);box-shadow:0 0 16px var(--accent-glow)}
.template-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff;overflow:hidden}
.template-icon img{width:100%;height:100%;object-fit:contain;padding:4px}
.template-name{font-size:9px;font-weight:600;color:var(--text2);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}

/* Form */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px}
.form-input{width:100%;height:48px;background:var(--bg);border:1.5px solid var(--surface3);border-radius:var(--radius-xs);padding:0 14px;font-size:14px;transition:border-color .2s}
.form-input:focus{border-color:var(--accent)}
.form-input::placeholder{color:var(--text3)}
select.form-input{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236B6B6B'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}
.form-row{display:flex;gap:12px}
.form-row .form-group{flex:1}
.form-submit{width:100%;height:52px;background:var(--accent);border-radius:var(--radius-sm);font-size:15px;font-weight:700;color:#fff;transition:transform .15s;margin-top:8px}
.form-submit:active{transform:scale(0.97)}
.form-submit:disabled{opacity:.5}

/* Category Tags */
.category-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.cat-tag{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:var(--surface2);color:var(--text2);border:1px solid var(--surface3);transition:all .2s}
.cat-tag.active{background:var(--accent-dim);color:var(--accent);border-color:var(--accent)}
.cat-tag:active{transform:scale(0.95)}

/* Search */
.search-bar{position:relative;margin-bottom:16px}
.search-bar input{width:100%;height:44px;background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius-sm);padding:0 14px 0 42px;font-size:14px}
.search-bar input:focus{border-color:var(--accent)}
.search-bar svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:18px;height:18px;stroke:var(--text3);fill:none;stroke-width:2}

/* Toast */
.toast{position:fixed;top:calc(20px + var(--safe-top));left:50%;transform:translateX(-50%) translateY(-120%);z-index:500;background:var(--surface2);border:1px solid var(--surface3);border-radius:var(--radius-sm);padding:12px 20px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;transition:transform .4s var(--ease-spring);white-space:nowrap;max-width:90vw}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{border-color:rgba(34,197,94,.3)}
.toast.error{border-color:rgba(239,68,68,.3)}

/* Edit Mode Badge */
.edit-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:3px 8px;border-radius:12px;background:var(--accent-dim);color:var(--accent)}

/* No scrollbar */
::-webkit-scrollbar{width:0;height:0}

/* Sort dropdown */
.sort-dropdown{position:relative}
.sort-menu{position:absolute;top:calc(100% + 8px);right:0;background:var(--surface);border:1px solid var(--surface3);border-radius:var(--radius-sm);padding:6px;min-width:160px;z-index:60;opacity:0;transform:scale(.95) translateY(-4px);pointer-events:none;transition:all .2s}
.sort-menu.open{opacity:1;transform:none;pointer-events:auto}
.sort-option{display:block;width:100%;padding:10px 12px;text-align:left;font-size:13px;font-weight:500;border-radius:6px;color:var(--text2);transition:background .15s}
.sort-option:hover,.sort-option.active{background:var(--accent-dim);color:var(--accent)}

/* Export section */
.export-actions{display:flex;gap:10px;margin-top:12px}
.export-btn{flex:1;height:44px;border-radius:var(--radius-xs);font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px;background:var(--surface2);border:1px solid var(--surface3);transition:transform .15s}
.export-btn:active{transform:scale(0.96)}
.export-btn svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2}
</style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
  <div class="auth-logo"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 8 12 11.82 4.65 8 12 4.18zM4 9.47l7 3.5V19.7l-7-3.5V9.47zm10 10.23V12.97l7-3.5v6.73l-7 3.5z"/></svg></div>
  <h2 class="auth-title">Subs<span style="color:var(--accent)">Track</span></h2>
  <p class="auth-subtitle">Smart subscription management</p>
  <div class="auth-form">
    <div id="auth-name-group" class="auth-input-group" style="display:none">
      <input type="text" id="auth-name" placeholder=" " autocomplete="name">
      <label>Display Name</label>
    </div>
    <div class="auth-input-group">
      <input type="email" id="auth-email" placeholder=" " autocomplete="email">
      <label>Email</label>
    </div>
    <div class="auth-input-group">
      <input type="password" id="auth-pass" placeholder=" " autocomplete="current-password">
      <label>Password</label>
    </div>
    <button class="auth-btn" id="auth-submit" onclick="handleAuth()">Sign In</button>
    <div class="auth-error" id="auth-error"></div>
    <p class="auth-toggle" id="auth-toggle">Don't have an account? <span onclick="toggleAuthMode()">Sign Up</span></p>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="app-header">
    <div class="app-header-inner">
      <h1>Subs<span>Track</span></h1>
      <div class="header-actions">
        <button class="header-btn" onclick="openSearch()" aria-label="Search"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
        <button class="header-btn" onclick="toggleSort()" aria-label="Sort"><svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="16" y2="12"/><line x1="4" y1="18" x2="12" y2="18"/></svg></button>
        <div class="sort-dropdown">
          <div class="sort-menu" id="sort-menu">
            <button class="sort-option active" data-sort="date">Next billing</button>
            <button class="sort-option" data-sort="price-asc">Price: Low â†’ High</button>
            <button class="sort-option" data-sort="price-desc">Price: High â†’ Low</button>
            <button class="sort-option" data-sort="name">Name A â†’ Z</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-scroll" id="main-scroll">
    <div class="ptr-indicator" id="ptr-indicator">
      <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
      <span>Pull to refresh</span>
    </div>

    <!-- Dashboard -->
    <div class="tab-content active" id="tab-dashboard">
      <div id="urgent-container"></div>
      <div class="metrics-row" id="metrics-container">
        <div class="metric-card skeleton skeleton-metric"></div>
        <div class="metric-card skeleton skeleton-metric"></div>
      </div>
      <div class="chart-section">
        <div class="section-label">6-Month Projection</div>
        <div class="chart-container" id="chart-container">
          <div class="chart-bars" id="chart-bars"></div>
        </div>
      </div>
      <div class="section-label">Recent Activity</div>
      <div class="sub-list" id="dashboard-recent">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>

    <!-- Active Subs -->
    <div class="tab-content" id="tab-subs">
      <div class="search-bar" id="subs-search" style="display:none">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" placeholder="Search subscriptions..." oninput="filterSubs(this.value)">
      </div>
      <div class="category-tags" id="category-filters"></div>
      <div class="sub-list" id="subs-list">
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>

    <!-- Insights -->
    <div class="tab-content" id="tab-insights">
      <div id="insights-content"></div>
    </div>

    <!-- Account -->
    <div class="tab-content" id="tab-account">
      <div id="account-content"></div>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" onclick="openAddSheet()" aria-label="Add subscription">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="bottom-nav-inner" style="position:relative">
      <div class="nav-indicator" id="nav-indicator"></div>
      <button class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
        <span>Dashboard</span>
      </button>
      <button class="nav-item" data-tab="subs" onclick="switchTab('subs')">
        <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        <span>Active Subs</span>
      </button>
      <button class="nav-item" data-tab="insights" onclick="switchTab('insights')">
        <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        <span>Insights</span>
      </button>
      <button class="nav-item" data-tab="account" onclick="switchTab('account')">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>Account</span>
      </button>
    </div>
  </nav>
</div>

<!-- Bottom Sheet (Add / Edit) -->
<div class="bs-overlay" id="bs-overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottom-sheet">
  <div class="bs-handle"></div>
  <div class="bs-header">
    <h2 id="bs-title">Add Subscription</h2>
    <button class="bs-close" onclick="closeSheet()"><svg viewBox="0 0 24 24" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>
  <div class="bs-body">
    <div class="templates-label">Quick Templates</div>
    <div class="templates-grid" id="templates-grid"></div>
    <div class="templates-label">Or fill manually</div>
    <form id="sub-form" onsubmit="return handleSubForm(event)">
      <div class="form-group">
        <label>Service Name *</label>
        <input class="form-input" id="f-name" required placeholder="e.g. Netflix">
      </div>
      <div class="form-group">
        <label>Logo URL (optional)</label>
        <input class="form-input" id="f-logo" placeholder="https://...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Cost (â‚¹) *</label>
          <input class="form-input" id="f-cost" type="number" min="1" required placeholder="499">
        </div>
        <div class="form-group">
          <label>Billing Cycle *</label>
          <select class="form-input" id="f-cycle" required>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="weekly">Weekly</option>
            <option value="quarterly">Quarterly</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Next Billing Date *</label>
        <input class="form-input" id="f-date" type="date" required>
      </div>
      <div class="form-group">
        <label>Category</label>
        <select class="form-input" id="f-category">
          <option value="Entertainment">Entertainment</option>
          <option value="Food & Delivery">Food & Delivery</option>
          <option value="Music">Music</option>
          <option value="Gaming">Gaming</option>
          <option value="Productivity">Productivity</option>
          <option value="Cloud Storage">Cloud Storage</option>
          <option value="News">News</option>
          <option value="Fitness">Fitness</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes (optional)</label>
        <input class="form-input" id="f-notes" placeholder="Family plan, shared, etc.">
      </div>
      <input type="hidden" id="f-edit-id" value="">
      <button class="form-submit" type="submit" id="f-submit-btn">Add Subscription</button>
    </form>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
// â”€â”€ Firebase Init â”€â”€
const firebaseConfig={apiKey:"AIzaSyAp9negxP0RVgyJD0DJ3uh1Twz0VrNj9Q4",authDomain:"subscriptions-7c00f.firebaseapp.com",projectId:"subscriptions-7c00f",storageBucket:"subscriptions-7c00f.firebasestorage.app",messagingSenderId:"124269956323",appId:"1:124269956323:web:76f5617aae481fdf6bc9d6"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

// â”€â”€ State â”€â”€
let currentUser=null;
let subscriptions=[];
let currentTab='dashboard';
let isSignUp=false;
let editingId=null;
let currentSort='date';
let searchQuery='';
let activeCategory='All';
let unsubListener=null;

// â”€â”€ Templates (12 Indian services) â”€â”€
const TEMPLATES=[
{name:'Netflix',color:'#E50914',logo:'https://cdn.simpleicons.org/netflix/E50914',cost:649,cycle:'monthly',category:'Entertainment'},
{name:'Amazon Prime',color:'#00A8E1',logo:'https://cdn.simpleicons.org/amazon/00A8E1',cost:1499,cycle:'yearly',category:'Entertainment'},
{name:'JioCinema',color:'#E8308C',logo:'https://cdn.simpleicons.org/jio/E8308C',cost:999,cycle:'yearly',category:'Entertainment'},
{name:'SonyLIV',color:'#121212',logo:'https://cdn.simpleicons.org/sony/FFFFFF',cost:999,cycle:'yearly',category:'Entertainment'},
{name:'Zee5',color:'#8230C6',logo:'https://cdn.simpleicons.org/zee5/8230C6',cost:999,cycle:'yearly',category:'Entertainment'},
{name:'Swiggy One',color:'#FC8019',logo:'https://cdn.simpleicons.org/swiggy/FC8019',cost:299,cycle:'monthly',category:'Food & Delivery'},
{name:'Zomato Gold',color:'#E23744',logo:'https://cdn.simpleicons.org/zomato/E23744',cost:300,cycle:'monthly',category:'Food & Delivery'},
{name:'Spotify',color:'#1DB954',logo:'https://cdn.simpleicons.org/spotify/1DB954',cost:119,cycle:'monthly',category:'Music'},
{name:'YouTube Premium',color:'#FF0000',logo:'https://cdn.simpleicons.org/youtube/FF0000',cost:149,cycle:'monthly',category:'Entertainment'},
{name:'Xbox Game Pass',color:'#107C10',logo:'https://cdn.simpleicons.org/xbox/107C10',cost:999,cycle:'monthly',category:'Gaming'},
{name:'Hotstar',color:'#1F2833',logo:'https://cdn.simpleicons.org/hotstar/1F2833',cost:899,cycle:'yearly',category:'Entertainment'},
{name:'Apple Music',color:'#FA243C',logo:'https://cdn.simpleicons.org/applemusic/FA243C',cost:99,cycle:'monthly',category:'Music'},
];

// â”€â”€ Auth â”€â”€
function toggleAuthMode(){
  isSignUp=!isSignUp;
  document.getElementById('auth-name-group').style.display=isSignUp?'block':'none';
  document.getElementById('auth-submit').textContent=isSignUp?'Create Account':'Sign In';
  document.getElementById('auth-toggle').innerHTML=isSignUp
    ?'Already have an account? <span onclick="toggleAuthMode()">Sign In</span>'
    :'Don\'t have an account? <span onclick="toggleAuthMode()">Sign Up</span>';
  document.getElementById('auth-error').textContent='';
}

async function handleAuth(){
  const email=document.getElementById('auth-email').value.trim();
  const pass=document.getElementById('auth-pass').value;
  const btn=document.getElementById('auth-submit');
  const errEl=document.getElementById('auth-error');
  if(!email||!pass){errEl.textContent='Please fill in all fields.';return}
  btn.disabled=true;
  errEl.textContent='';
  try{
    if(isSignUp){
      const cred=await auth.createUserWithEmailAndPassword(email,pass);
      const name=document.getElementById('auth-name').value.trim();
      if(name)await cred.user.updateProfile({displayName:name});
      await db.collection('users').doc(cred.user.uid).set({email,displayName:name||'',createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    }else{
      await auth.signInWithEmailAndPassword(email,pass);
    }
  }catch(e){
    const msgs={'auth/email-already-in-use':'Email already registered','auth/invalid-email':'Invalid email','auth/weak-password':'Password must be 6+ characters','auth/user-not-found':'No account found','auth/wrong-password':'Incorrect password','auth/invalid-credential':'Invalid credentials','auth/too-many-requests':'Too many attempts. Try later.'};
    errEl.textContent=msgs[e.code]||e.message;
    btn.disabled=false;
  }
}

auth.onAuthStateChanged(user=>{
  currentUser=user;
  if(user){
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.add('visible');
    loadSubscriptions();
  }else{
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app').classList.remove('visible');
    if(unsubListener)unsubListener();
    subscriptions=[];
  }
  document.getElementById('auth-submit').disabled=false;
});

// â”€â”€ Firestore â”€â”€
function subsRef(){return db.collection('users').doc(currentUser.uid).collection('subscriptions')}

function loadSubscriptions(){
  if(unsubListener)unsubListener();
  unsubListener=subsRef().onSnapshot(snap=>{
    subscriptions=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderAll();
  },err=>{console.error(err);showToast('Error loading data','error')});
}

async function addSubscription(data){
  try{await subsRef().add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});showToast('Subscription added!','success')}
  catch(e){showToast('Failed to add','error')}
}
async function updateSubscription(id,data){
  try{await subsRef().doc(id).update(data);showToast('Updated!','success')}
  catch(e){showToast('Failed to update','error')}
}
async function deleteSubscription(id){
  try{await subsRef().doc(id).delete();showToast('Removed','success')}
  catch(e){showToast('Failed to delete','error')}
}

// â”€â”€ Render â”€â”€
function renderAll(){
  renderDashboard();
  renderSubsList();
  renderInsights();
  renderAccount();
}

function daysUntil(dateStr){
  const d=new Date(dateStr);d.setHours(0,0,0,0);
  const now=new Date();now.setHours(0,0,0,0);
  return Math.ceil((d-now)/(86400000));
}

function monthlyEquiv(cost,cycle){
  if(cycle==='monthly')return cost;
  if(cycle==='yearly')return cost/12;
  if(cycle==='quarterly')return cost/3;
  if(cycle==='weekly')return cost*4.33;
  return cost;
}

function yearlyEquiv(cost,cycle){
  if(cycle==='yearly')return cost;
  if(cycle==='monthly')return cost*12;
  if(cycle==='quarterly')return cost*4;
  if(cycle==='weekly')return cost*52;
  return cost;
}

function formatINR(n){return 'â‚¹'+Math.round(n).toLocaleString('en-IN')}
function fmtDate(d){const dt=new Date(d);return dt.toLocaleDateString('en-IN',{day:'numeric',month:'short'})}
function getInitials(name){return name.split(/\s+/).map(w=>w[0]).join('').substring(0,2).toUpperCase()}

function sortedSubs(list){
  const arr=[...list];
  switch(currentSort){
    case 'date':arr.sort((a,b)=>new Date(a.nextDate)-new Date(b.nextDate));break;
    case 'price-asc':arr.sort((a,b)=>a.cost-b.cost);break;
    case 'price-desc':arr.sort((a,b)=>b.cost-a.cost);break;
    case 'name':arr.sort((a,b)=>a.name.localeCompare(b.name));break;
  }
  return arr;
}

function filteredSubs(){
  let list=subscriptions;
  if(searchQuery){const q=searchQuery.toLowerCase();list=list.filter(s=>s.name.toLowerCase().includes(q))}
  if(activeCategory!=='All')list=list.filter(s=>s.category===activeCategory);
  return sortedSubs(list);
}

// Dashboard
function renderDashboard(){
  const monthly=subscriptions.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
  const yearly=subscriptions.reduce((s,i)=>s+yearlyEquiv(i.cost,i.cycle),0);

  // Urgent warnings (due within 3 days)
  const urgent=subscriptions.filter(s=>{const d=daysUntil(s.nextDate);return d>=0&&d<=3}).sort((a,b)=>daysUntil(a.nextDate)-daysUntil(b.nextDate));
  const urgentEl=document.getElementById('urgent-container');
  if(urgent.length){
    urgentEl.innerHTML='<div class="section-label">âš  Due Soon</div>'+urgent.map(s=>{
      const d=daysUntil(s.nextDate);
      const label=d===0?'Due Today':d===1?'Due Tomorrow':`Due in ${d} days`;
      return `<div class="urgent-card" onclick="openEditSheet('${s.id}')">
        <div class="urgent-icon">${s.logo?`<img src="${s.logo}" onerror="this.parentNode.textContent='${getInitials(s.name)}'">`:`${getInitials(s.name)}`}</div>
        <div class="urgent-info"><div class="urgent-name">${esc(s.name)}</div><div class="urgent-detail">${label}</div></div>
        <div class="urgent-amount">${formatINR(s.cost)}</div>
      </div>`}).join('');
  }else{urgentEl.innerHTML=''}

  // Metrics
  document.getElementById('metrics-container').innerHTML=`
    <div class="metric-card"><div class="metric-label">Monthly Outflow</div><div class="metric-value">${formatINR(monthly)}</div></div>
    <div class="metric-card"><div class="metric-label">Yearly Outflow</div><div class="metric-value">${formatINR(yearly)}</div></div>`;

  // 6-month chart
  renderChart(monthly);

  // Recent (next 5 by date)
  const recent=sortedSubs(subscriptions).slice(0,5);
  const recentEl=document.getElementById('dashboard-recent');
  if(!recent.length){recentEl.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg><h3>No Subscriptions Yet</h3><p>Tap + to add your first subscription</p></div>';return}
  recentEl.innerHTML=recent.map(s=>renderSubCard(s)).join('');
  initSwipe(recentEl);
}

function renderChart(monthlyTotal){
  const bars=document.getElementById('chart-bars');
  const now=new Date();
  const months=[];
  for(let i=0;i<6;i++){
    const d=new Date(now.getFullYear(),now.getMonth()+i,1);
    months.push({label:d.toLocaleDateString('en-IN',{month:'short'}),val:monthlyTotal*(1+Math.random()*.08-.04),current:i===0});
  }
  const max=Math.max(...months.map(m=>m.val),1);
  bars.innerHTML=months.map(m=>{
    const h=Math.max((m.val/max)*120,4);
    return `<div class="chart-bar-wrap"><div class="chart-bar ${m.current?'current':''}" style="height:${h}px"><span class="chart-bar-val">${formatINR(m.val)}</span></div><span class="chart-bar-label">${m.label}</span></div>`;
  }).join('');
}

function renderSubCard(s){
  const d=daysUntil(s.nextDate);
  let statusClass='active',statusLabel='Active';
  if(d<0){statusClass='overdue';statusLabel='Overdue'}
  else if(d<=3){statusClass='due-soon';statusLabel=d===0?'Today':d===1?'Tomorrow':`${d}d`}
  const brandColor=s.brandColor||'var(--accent)';
  const glowStyle=s.brandColor?`--glow-color:${s.brandColor}33`:''
  return `<div class="sub-card-wrapper" data-id="${s.id}" style="max-height:200px">
    <div class="sub-card-delete-bg"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
    <div class="sub-card" data-id="${s.id}" onclick="openEditSheet('${s.id}')">
      <div class="sub-logo glow" style="${glowStyle};background:${brandColor}18">
        ${s.logo?`<img src="${s.logo}" onerror="this.parentNode.innerHTML='${getInitials(s.name)}'">`:getInitials(s.name)}
      </div>
      <div class="sub-info">
        <div class="sub-name">${esc(s.name)}</div>
        <div class="sub-cycle"><span class="sub-status-dot ${statusClass}"></span>${s.cycle} Â· ${s.category||'General'}</div>
      </div>
      <div class="sub-right">
        <div class="sub-price">${formatINR(s.cost)}</div>
        <div class="sub-next">${d<0?'Overdue':fmtDate(s.nextDate)}</div>
      </div>
    </div>
  </div>`;
}

// Active Subs
function renderSubsList(){
  const categories=['All',...new Set(subscriptions.map(s=>s.category||'Other'))];
  const filterEl=document.getElementById('category-filters');
  filterEl.innerHTML=categories.map(c=>`<button class="cat-tag ${activeCategory===c?'active':''}" onclick="setCategory('${c}')">${c}</button>`).join('');

  const list=filteredSubs();
  const el=document.getElementById('subs-list');
  if(!list.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" y1="15" x2="16" y2="15"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg><h3>No subscriptions found</h3><p>Try a different filter or add a new one</p></div>';return}
  el.innerHTML=list.map(s=>renderSubCard(s)).join('');
  initSwipe(el);
}

function setCategory(c){activeCategory=c;renderSubsList()}
function filterSubs(q){searchQuery=q;renderSubsList()}
function openSearch(){
  const el=document.getElementById('subs-search');
  if(currentTab!=='subs')switchTab('subs');
  el.style.display=el.style.display==='none'?'block':'none';
  if(el.style.display==='block')el.querySelector('input').focus();
}

// Insights
function renderInsights(){
  const el=document.getElementById('insights-content');
  if(!subscriptions.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><h3>No insights yet</h3><p>Add subscriptions to see spending analytics</p></div>';return}

  const monthly=subscriptions.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
  const yearly=subscriptions.reduce((s,i)=>s+yearlyEquiv(i.cost,i.cycle),0);
  const daily=monthly/30;
  const catMap={};
  subscriptions.forEach(s=>{const c=s.category||'Other';catMap[c]=(catMap[c]||0)+monthlyEquiv(s.cost,s.cycle)});
  const catEntries=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const colors=['#8B5CF6','#EC4899','#F59E0B','#22C55E','#3B82F6','#EF4444','#06B6D4','#F97316','#6366F1'];
  const most=subscriptions.reduce((a,b)=>monthlyEquiv(a.cost,a.cycle)>monthlyEquiv(b.cost,b.cycle)?a:b);
  const least=subscriptions.reduce((a,b)=>monthlyEquiv(a.cost,a.cycle)<monthlyEquiv(b.cost,b.cycle)?a:b);

  // SVG Donut
  const total=catEntries.reduce((s,e)=>s+e[1],0);
  let cumPct=0;
  const donutParts=catEntries.map((e,i)=>{
    const pct=e[1]/total*100;const startAngle=cumPct*3.6;cumPct+=pct;
    const endAngle=cumPct*3.6;const large=pct>50?1:0;
    const r=50,cx=60,cy=60;
    const x1=cx+r*Math.cos((startAngle-90)*Math.PI/180);
    const y1=cy+r*Math.sin((startAngle-90)*Math.PI/180);
    const x2=cx+r*Math.cos((endAngle-90)*Math.PI/180);
    const y2=cy+r*Math.sin((endAngle-90)*Math.PI/180);
    return `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z" fill="${colors[i%colors.length]}" opacity="0.85"/>`;
  }).join('');

  el.innerHTML=`
  <div class="insight-card">
    <h3><span>ðŸ“Š</span> Spending by Category</h3>
    <div class="donut-container">
      <svg class="donut-chart" viewBox="0 0 120 120">${donutParts}<circle cx="60" cy="60" r="30" fill="var(--surface)"/><text x="60" y="57" text-anchor="middle" fill="var(--text)" font-size="10" font-weight="800">${formatINR(monthly)}</text><text x="60" y="70" text-anchor="middle" fill="var(--text3)" font-size="6">/month</text></svg>
      <div class="donut-legend">${catEntries.map((e,i)=>`<div class="legend-item"><div class="legend-dot" style="background:${colors[i%colors.length]}"></div><span class="legend-name">${e[0]}</span><span class="legend-val">${formatINR(e[1])}</span></div>`).join('')}</div>
    </div>
  </div>
  <div class="insight-card">
    <h3><span>ðŸ’¡</span> Quick Stats</h3>
    <div class="stat-row"><span class="stat-label">Total subscriptions</span><span class="stat-value">${subscriptions.length}</span></div>
    <div class="stat-row"><span class="stat-label">Daily cost</span><span class="stat-value">${formatINR(daily)}</span></div>
    <div class="stat-row"><span class="stat-label">Avg per subscription</span><span class="stat-value">${formatINR(monthly/subscriptions.length)}/mo</span></div>
    <div class="stat-row"><span class="stat-label">Most expensive</span><span class="stat-value">${esc(most.name)} Â· ${formatINR(monthlyEquiv(most.cost,most.cycle))}/mo</span></div>
    <div class="stat-row"><span class="stat-label">Cheapest</span><span class="stat-value">${esc(least.name)} Â· ${formatINR(monthlyEquiv(least.cost,least.cycle))}/mo</span></div>
    <div class="stat-row"><span class="stat-label">Yearly total</span><span class="stat-value">${formatINR(yearly)}</span></div>
  </div>
  <div class="insight-card">
    <h3><span>ðŸ“…</span> Upcoming Renewals</h3>
    ${sortedSubs(subscriptions).filter(s=>daysUntil(s.nextDate)>=0).slice(0,6).map(s=>`<div class="stat-row"><span class="stat-label">${esc(s.name)}</span><span class="stat-value">${fmtDate(s.nextDate)} Â· ${formatINR(s.cost)}</span></div>`).join('')||'<p style="color:var(--text3);font-size:13px">No upcoming renewals</p>'}
  </div>`;
}

// Account
function renderAccount(){
  if(!currentUser)return;
  const el=document.getElementById('account-content');
  const name=currentUser.displayName||currentUser.email.split('@')[0];
  const monthly=subscriptions.reduce((s,i)=>s+monthlyEquiv(i.cost,i.cycle),0);
  el.innerHTML=`
    <div class="account-avatar">${getInitials(name)}</div>
    <div style="text-align:center;font-size:18px;font-weight:800;margin-bottom:4px">${esc(name)}</div>
    <div class="account-email">${esc(currentUser.email)}</div>
    <div class="account-section">
      <div class="account-section-title">Summary</div>
      <div class="account-item"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg><span>${subscriptions.length} Active Subscriptions</span></div>
      <div class="account-item"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span>${formatINR(monthly)}/month</span></div>
    </div>
    <div class="account-section">
      <div class="account-section-title">Data</div>
      <div class="account-item" onclick="exportCSV()"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Export as CSV</span><svg class="chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
      <div class="account-item" onclick="exportJSON()"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>Export as JSON</span><svg class="chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></div>
    </div>
    <div class="account-section">
      <div class="account-section-title">Account</div>
      <div class="account-item danger" onclick="handleSignOut()"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg><span>Sign Out</span></div>
    </div>
    <div style="text-align:center;margin-top:24px;color:var(--text3);font-size:11px">SubsTrack v1.0 Â· Made for India ðŸ‡®ðŸ‡³</div>`;
}

function handleSignOut(){auth.signOut()}

// â”€â”€ Export â”€â”€
function exportCSV(){
  const rows=[['Name','Cost (â‚¹)','Cycle','Category','Next Billing','Notes']];
  subscriptions.forEach(s=>rows.push([s.name,s.cost,s.cycle,s.category||'',s.nextDate||'',s.notes||'']));
  const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  downloadFile(csv,'subscriptions.csv','text/csv');
  showToast('CSV exported!','success');
}
function exportJSON(){
  const data=subscriptions.map(({id,createdAt,...rest})=>rest);
  downloadFile(JSON.stringify(data,null,2),'subscriptions.json','application/json');
  showToast('JSON exported!','success');
}
function downloadFile(content,name,type){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=name;a.click();URL.revokeObjectURL(a.href);
}

// â”€â”€ Navigation â”€â”€
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(el=>{el.classList.toggle('active',el.dataset.tab===tab)});
  updateNavIndicator();
  document.getElementById('main-scroll').scrollTop=0;
}

function updateNavIndicator(){
  const activeBtn=document.querySelector('.nav-item.active');
  const ind=document.getElementById('nav-indicator');
  if(!activeBtn)return;
  const rect=activeBtn.getBoundingClientRect();
  const navRect=activeBtn.parentElement.getBoundingClientRect();
  ind.style.left=(rect.left-navRect.left)+'px';
  ind.style.width=rect.width+'px';
}
window.addEventListener('resize',updateNavIndicator);
setTimeout(updateNavIndicator,100);

// â”€â”€ Sort â”€â”€
function toggleSort(){
  const menu=document.getElementById('sort-menu');
  menu.classList.toggle('open');
}
document.querySelectorAll('.sort-option').forEach(btn=>{
  btn.addEventListener('click',()=>{
    currentSort=btn.dataset.sort;
    document.querySelectorAll('.sort-option').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('sort-menu').classList.remove('open');
    renderAll();
  });
});
document.addEventListener('click',e=>{if(!e.target.closest('.sort-dropdown')&&!e.target.closest('.header-btn'))document.getElementById('sort-menu').classList.remove('open')});

// â”€â”€ Bottom Sheet â”€â”€
function openAddSheet(){
  editingId=null;
  document.getElementById('bs-title').textContent='Add Subscription';
  document.getElementById('f-submit-btn').textContent='Add Subscription';
  document.getElementById('sub-form').reset();
  document.getElementById('f-edit-id').value='';
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.querySelectorAll('.template-btn').forEach(b=>b.classList.remove('selected'));
  openSheet();
}

function openEditSheet(id){
  const sub=subscriptions.find(s=>s.id===id);
  if(!sub)return;
  editingId=id;
  document.getElementById('bs-title').textContent='Edit Subscription';
  document.getElementById('f-submit-btn').textContent='Save Changes';
  document.getElementById('f-name').value=sub.name;
  document.getElementById('f-logo').value=sub.logo||'';
  document.getElementById('f-cost').value=sub.cost;
  document.getElementById('f-cycle').value=sub.cycle;
  document.getElementById('f-date').value=sub.nextDate;
  document.getElementById('f-category').value=sub.category||'Entertainment';
  document.getElementById('f-notes').value=sub.notes||'';
  document.getElementById('f-edit-id').value=id;
  openSheet();
}

function openSheet(){
  document.getElementById('bs-overlay').classList.add('open');
  document.getElementById('bottom-sheet').classList.add('open');
}
function closeSheet(){
  document.getElementById('bs-overlay').classList.remove('open');
  document.getElementById('bottom-sheet').classList.remove('open');
}

// Templates
function renderTemplates(){
  const grid=document.getElementById('templates-grid');
  grid.innerHTML=TEMPLATES.map((t,i)=>`
    <button class="template-btn" type="button" onclick="selectTemplate(${i})">
      <div class="template-icon" style="background:${t.color}22"><img src="${t.logo}" onerror="this.parentNode.style.background='${t.color}';this.parentNode.textContent='${getInitials(t.name)}'"></div>
      <span class="template-name">${t.name}</span>
    </button>`).join('');
}
renderTemplates();

function selectTemplate(i){
  const t=TEMPLATES[i];
  document.getElementById('f-name').value=t.name;
  document.getElementById('f-logo').value=t.logo;
  document.getElementById('f-cost').value=t.cost;
  document.getElementById('f-cycle').value=t.cycle;
  document.getElementById('f-category').value=t.category;
  document.querySelectorAll('.template-btn').forEach((b,j)=>b.classList.toggle('selected',j===i));
}

// Form submit
function handleSubForm(e){
  e.preventDefault();
  const data={
    name:document.getElementById('f-name').value.trim(),
    logo:document.getElementById('f-logo').value.trim()||'',
    cost:parseFloat(document.getElementById('f-cost').value),
    cycle:document.getElementById('f-cycle').value,
    nextDate:document.getElementById('f-date').value,
    category:document.getElementById('f-category').value,
    notes:document.getElementById('f-notes').value.trim(),
  };
  // Try to match brand color
  const tmpl=TEMPLATES.find(t=>t.name.toLowerCase()===data.name.toLowerCase());
  if(tmpl)data.brandColor=tmpl.color;
  if(!data.logo&&tmpl)data.logo=tmpl.logo;

  if(editingId){updateSubscription(editingId,data)}
  else{addSubscription(data)}
  closeSheet();
  return false;
}

// â”€â”€ Swipe to Delete â”€â”€
function initSwipe(container){
  const cards=container.querySelectorAll('.sub-card');
  cards.forEach(card=>{
    let startX=0,currentX=0,isDragging=false;
    const wrapper=card.closest('.sub-card-wrapper');
    card.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;isDragging=false;card.style.transition='none'},{ passive: true });
    card.addEventListener('touchmove',e=>{
      const dx=e.touches[0].clientX-startX;
      if(dx<-10){isDragging=true;card.classList.add('swiping')}
      if(isDragging){
        currentX=Math.min(0,Math.max(dx,-120));
        card.style.transform=`translateX(${currentX}px)`;
      }
    },{ passive: true });
    card.addEventListener('touchend',()=>{
      card.style.transition='transform .3s var(--ease-spring)';
      if(currentX<-80){
        card.style.transform='translateX(-100%)';
        const id=card.dataset.id;
        setTimeout(()=>{
          wrapper.classList.add('removing');
          setTimeout(()=>deleteSubscription(id),400);
        },150);
      }else{
        card.style.transform='translateX(0)';
      }
      setTimeout(()=>card.classList.remove('swiping'),300);
      currentX=0;isDragging=false;
    });
  });
}

// â”€â”€ Pull to Refresh â”€â”€
(function(){
  const scroll=document.getElementById('main-scroll');
  const ptr=document.getElementById('ptr-indicator');
  let startY=0,pulling=false;
  scroll.addEventListener('touchstart',e=>{if(scroll.scrollTop<=0)startY=e.touches[0].clientY},{passive:true});
  scroll.addEventListener('touchmove',e=>{
    if(scroll.scrollTop>0)return;
    const dy=e.touches[0].clientY-startY;
    if(dy>0&&dy<120){pulling=true;ptr.style.height=Math.min(dy*.6,50)+'px';ptr.querySelector('svg').style.transform=`rotate(${dy*3}deg)`}
  },{passive:true});
  scroll.addEventListener('touchend',()=>{
    if(pulling&&parseInt(ptr.style.height)>35){
      ptr.classList.add('refreshing');
      ptr.querySelector('span').textContent='Syncing...';
      ptr.style.height='50px';
      loadSubscriptions();
      setTimeout(()=>{ptr.classList.remove('refreshing');ptr.style.height='0';ptr.querySelector('span').textContent='Pull to refresh'},1500);
    }else{ptr.style.height='0'}
    pulling=false;
  });
})();

// â”€â”€ Toast â”€â”€
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.className='toast '+type;
  t.innerHTML=(type==='success'?'âœ“':'âœ•')+' '+esc(msg);
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// â”€â”€ Helpers â”€â”€
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// Keyboard: Enter to submit auth
document.getElementById('auth-pass').addEventListener('keydown',e=>{if(e.key==='Enter')handleAuth()});
document.getElementById('auth-email').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('auth-pass').focus()});

// Close sort menu on sheet open
document.getElementById('bottom-sheet').addEventListener('transitionend',()=>{document.getElementById('sort-menu').classList.remove('open')});
</script>
</body>
</html>
