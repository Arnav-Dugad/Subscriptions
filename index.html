<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="theme-color" content="#06060f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SubsTrack">
<meta name="application-name" content="SubsTrack">
<meta name="description" content="Premium Subscription Manager for India">
<title>SubsTrack</title>
<link rel="manifest" id="pwa-manifest">
<link rel="apple-touch-icon" id="apple-icon">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cabinet+Grotesk:wght@400;500;700;800;900&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#06060f;
  --s1:#0d0d1f;--s2:#121226;--s3:#191933;--s4:#1f1f42;--s5:#252550;
  --a0:rgba(99,102,241,.06);--a1:rgba(99,102,241,.12);--a2:rgba(99,102,241,.22);
  --accent:#6366f1;--accent2:#818cf8;--accent3:#a5b4fc;
  --text:#eeeef8;--text2:#9898b8;--text3:#4a4a6a;
  --danger:#f43f5e;--d1:rgba(244,63,94,.1);
  --success:#10b981;--s0:rgba(16,185,129,.1);
  --warn:#f59e0b;--w0:rgba(245,158,11,.1);
  --info:#06b6d4;--i0:rgba(6,182,212,.1);
  --paused:#a78bfa;--p0:rgba(167,139,250,.1);
  --trial:#fb923c;--t0:rgba(251,146,60,.1);
  --border:rgba(255,255,255,.055);--border2:rgba(255,255,255,.09);
  --shine:rgba(255,255,255,.035);
  --r1:20px;--r2:16px;--r3:12px;--r4:8px;--rpill:100px;
  --nav:66px;--safe-b:env(safe-area-inset-bottom,0px);--safe-t:env(safe-area-inset-top,0px);
  --spring:cubic-bezier(0.34,1.56,0.64,1);--ease:cubic-bezier(0.16,1,0.3,1);
}
html{background:var(--bg);overflow:hidden;height:100%;overscroll-behavior:none}
body{font-family:'Instrument Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;overscroll-behavior:none;-webkit-font-smoothing:antialiased}
input,button,select,textarea{font-family:inherit;border:none;outline:none;background:none;color:inherit}
button{cursor:pointer}

/* Ambient */
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 140% 70% at 10% -10%,rgba(99,102,241,.055) 0%,transparent 55%),
  radial-gradient(ellipse 90% 70% at 90% 110%,rgba(139,92,246,.04) 0%,transparent 50%)}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.016;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E")}

/* ‚îÄ‚îÄ LOADING SPLASH ‚îÄ‚îÄ */
#splash{position:fixed;inset:0;z-index:2000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .4s var(--ease),transform .4s var(--ease)}
#splash.hide{opacity:0;pointer-events:none;transform:scale(1.05)}
.splash-logo{width:64px;height:64px;border-radius:18px;background:linear-gradient(145deg,#6366f1,#4338ca);display:flex;align-items:center;justify-content:center;box-shadow:0 16px 40px rgba(99,102,241,.4),inset 0 1px 0 rgba(255,255,255,.12);animation:splashPulse 1.6s ease-in-out infinite}
@keyframes splashPulse{0%,100%{box-shadow:0 16px 40px rgba(99,102,241,.4)}50%{box-shadow:0 20px 56px rgba(99,102,241,.6)}}
.splash-logo svg{width:30px;height:30px;fill:#fff}
.splash-name{font-family:'Cabinet Grotesk',sans-serif;font-size:22px;font-weight:900;letter-spacing:-.6px;background:linear-gradient(135deg,#eeeef8,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.splash-dots{display:flex;gap:5px}
.splash-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:dotBounce 1.2s ease-in-out infinite}
.splash-dot:nth-child(2){animation-delay:.15s;background:var(--accent2)}
.splash-dot:nth-child(3){animation-delay:.3s;background:var(--accent3)}
@keyframes dotBounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}

/* ‚îÄ‚îÄ SKELETON ‚îÄ‚îÄ */
.skel{border-radius:var(--r2);background:linear-gradient(90deg,var(--s1) 0%,var(--s3) 50%,var(--s1) 100%);background-size:200% 100%;animation:shim 1.8s ease-in-out infinite}
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#auth-screen{position:fixed;inset:0;z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;opacity:0;transition:opacity .5s var(--ease),transform .5s var(--ease);pointer-events:none}
#auth-screen.visible{opacity:1;pointer-events:auto}
#auth-screen.hidden{opacity:0;pointer-events:none;transform:translateY(-12px) scale(1.02)}
#auth-screen::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 100% 70% at 50% 0%,rgba(99,102,241,.08) 0%,transparent 60%)}
.auth-orb{width:68px;height:68px;border-radius:20px;background:linear-gradient(145deg,#6366f1,#4338ca);display:flex;align-items:center;justify-content:center;margin-bottom:20px;box-shadow:0 14px 44px rgba(99,102,241,.4),0 0 0 1px rgba(99,102,241,.3),inset 0 1px 0 rgba(255,255,255,.12);position:relative}
.auth-orb svg{width:32px;height:32px;fill:#fff}
.auth-headline{font-family:'Cabinet Grotesk',sans-serif;font-size:30px;font-weight:900;letter-spacing:-1.1px;margin-bottom:5px;background:linear-gradient(135deg,#eeeef8 0%,#818cf8 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-sub{font-size:13px;color:var(--text3);margin-bottom:36px}
.auth-form{width:100%;max-width:360px;position:relative;z-index:1}
.auth-field{position:relative;margin-bottom:11px}
.auth-field input{width:100%;height:54px;background:var(--s2);border:1.5px solid var(--s4);border-radius:var(--r3);padding:18px 16px 0;font-size:15px;transition:border-color .2s,box-shadow .2s}
.auth-field input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--a1)}
.auth-field label{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--text3);pointer-events:none;transition:.18s;font-weight:500}
.auth-field input:focus+label,.auth-field input:not(:placeholder-shown)+label{top:13px;font-size:9px;transform:none;color:var(--accent2);font-weight:700;letter-spacing:.6px;text-transform:uppercase}
.auth-action{width:100%;height:54px;background:linear-gradient(135deg,#6366f1,#4338ca);border-radius:var(--r3);font-size:15px;font-weight:700;color:#fff;transition:transform .18s,box-shadow .18s,opacity .2s;margin-top:8px;font-family:'Cabinet Grotesk',sans-serif;box-shadow:0 8px 28px rgba(99,102,241,.42),inset 0 1px 0 rgba(255,255,255,.1)}
.auth-action:active{transform:scale(0.97)}
.auth-action:disabled{opacity:.5}
.auth-switch{text-align:center;margin-top:20px;font-size:13px;color:var(--text3)}
.auth-switch b{color:var(--accent3);font-weight:600;cursor:pointer}
.auth-err{color:var(--danger);font-size:12px;text-align:center;margin-top:8px;min-height:18px;font-weight:600}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP SHELL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#app{height:100%;display:flex;flex-direction:column;position:relative;z-index:1;opacity:0;transition:opacity .45s var(--ease)}
#app.on{opacity:1}

/* Header */
.hdr{position:sticky;top:0;z-index:50;padding:calc(8px + var(--safe-t)) 18px 8px;background:rgba(6,6,15,.88);-webkit-backdrop-filter:blur(40px) saturate(180%);backdrop-filter:blur(40px) saturate(180%);border-bottom:1px solid var(--border)}
.hdr-row{display:flex;align-items:center;justify-content:space-between}
.hdr-brand{display:flex;align-items:center;gap:9px}
.hdr-mark{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,#6366f1,#4338ca);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(99,102,241,.35)}
.hdr-mark svg{width:15px;height:15px;fill:#fff}
.hdr h1{font-family:'Cabinet Grotesk',sans-serif;font-size:20px;font-weight:900;letter-spacing:-.6px}
.hdr h1 span{background:linear-gradient(90deg,#818cf8,#a5b4fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-btns{display:flex;gap:5px;align-items:center;position:relative}
.hdr-btn{width:34px;height:34px;border-radius:50%;background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;transition:transform .15s,background .15s;position:relative}
.hdr-btn:active{transform:scale(0.87);background:var(--s3)}
.hdr-btn svg{width:15px;height:15px;stroke:var(--text2);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.hdr-badge{position:absolute;top:1px;right:1px;width:8px;height:8px;border-radius:50%;background:var(--danger);border:2px solid var(--bg)}

/* Sort */
.sort-drop{position:absolute;top:calc(100% + 8px);right:0;background:var(--s2);border:1px solid var(--border2);border-radius:var(--r3);padding:5px;min-width:184px;z-index:80;opacity:0;transform:scale(.93) translateY(-6px);pointer-events:none;transition:all .18s var(--ease);box-shadow:0 24px 60px rgba(0,0,0,.6)}
.sort-drop.open{opacity:1;transform:none;pointer-events:auto}
.sort-opt{display:block;width:100%;padding:9px 12px;text-align:left;font-size:12px;font-weight:600;border-radius:7px;color:var(--text2);transition:background .1s;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:.1px}
.sort-opt.on{background:var(--a1);color:var(--accent3)}
.sort-opt:active{background:var(--s3)}

/* Scroll */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav) + var(--safe-b) + 72px);position:relative;z-index:1}
::-webkit-scrollbar{width:0;height:0}

/* PTR */
.ptr{height:0;overflow:hidden;transition:height .3s var(--spring);color:var(--accent3);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:6px;letter-spacing:.5px;text-transform:uppercase}
.ptr svg{width:14px;height:14px;stroke:var(--accent3);fill:none;stroke-width:2}
.ptr.spin svg{animation:rot .8s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}

/* Tabs */
.tab{display:none;padding:14px 15px;animation:fUp .3s var(--ease)}
.tab.on{display:block}
@keyframes fUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

/* Section label */
.slabel{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px;font-family:'Cabinet Grotesk',sans-serif}
.slabel::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--s3),transparent)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê URGENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.urgent-wrap{margin-bottom:4px}
.urgent-card{background:linear-gradient(135deg,rgba(244,63,94,.07),rgba(244,63,94,.02));border:1px solid rgba(244,63,94,.15);border-radius:var(--r2);padding:12px 14px;display:flex;align-items:center;gap:12px;margin-bottom:8px;cursor:pointer;transition:transform .18s;position:relative;overflow:hidden}
.urgent-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2.5px;background:linear-gradient(180deg,#f43f5e,rgba(244,63,94,.2))}
.urgent-card:active{transform:scale(0.97)}
.urgent-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:800;color:#fff;overflow:hidden;font-family:'Cabinet Grotesk',sans-serif}
.urgent-icon img{width:100%;height:100%;object-fit:contain;padding:5px}
.urgent-info{flex:1;min-width:0}
.urgent-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.2px}
.urgent-detail{font-size:11px;color:var(--danger);font-weight:600;margin-top:2px}
.urgent-amt{font-size:14px;font-weight:800;white-space:nowrap;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.3px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê METRICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.metrics-row{display:flex;gap:10px;margin-bottom:18px}
.mcard{flex:1;background:var(--s1);border:1px solid var(--border);border-radius:var(--r1);padding:15px;position:relative;overflow:hidden}
.mcard::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,var(--shine),transparent);pointer-events:none}
.mcard-glow{position:absolute;top:-40px;right:-20px;width:90px;height:90px;border-radius:50%;filter:blur(30px);pointer-events:none;opacity:.45}
.mcard-label{font-size:9px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:1px;font-family:'Cabinet Grotesk',sans-serif}
.mcard-val{font-size:24px;font-weight:900;margin-top:7px;letter-spacing:-.9px;line-height:1;font-family:'Cabinet Grotesk',sans-serif}
.mcard-val .cur{font-size:13px;font-weight:600;color:var(--text2);vertical-align:super;line-height:0}
.mcard-sub{font-size:10px;color:var(--text3);margin-top:4px;font-weight:500}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.chart-section{margin-bottom:20px}
.chart-box{background:var(--s1);border:1px solid var(--border);border-radius:var(--r1);padding:16px;overflow:hidden;position:relative}
.chart-box::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,var(--shine),transparent);pointer-events:none}
.chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.chart-title{font-size:12px;font-weight:700;color:var(--text2);font-family:'Cabinet Grotesk',sans-serif}
.chart-sub{font-size:10px;color:var(--accent3);font-family:'Cabinet Grotesk',sans-serif;font-weight:700}
/* SVG-based bar chart */
.chart-svg-wrap{width:100%;overflow-x:auto}
.chart-svg-wrap svg{display:block;overflow:visible;min-width:300px}
/* SVG-based line chart */
.line-svg-wrap{width:100%;overflow:hidden}
.line-svg-wrap svg{display:block;overflow:visible}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUB CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sub-list{display:flex;flex-direction:column;gap:7px}
.sw-wrapper{position:relative;overflow:hidden;border-radius:var(--r2);transition:max-height .35s var(--ease),opacity .25s,margin .3s}
.sw-wrapper.bye{max-height:0!important;opacity:0;margin:0!important}
.sw-del-bg{position:absolute;right:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,transparent 45%,rgba(244,63,94,.9));display:flex;align-items:center;justify-content:flex-end;padding-right:18px;border-radius:var(--r2)}
.sw-del-bg svg{width:19px;height:19px;stroke:#fff;fill:none;stroke-width:2}
.sub-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r2);padding:11px 13px;display:flex;align-items:center;gap:11px;position:relative;overflow:hidden;transition:transform .15s;cursor:pointer;touch-action:pan-y;user-select:none;-webkit-user-select:none}
.sub-card:active{transform:scale(0.975)}
.sub-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--shine),transparent);pointer-events:none}
.sub-card.paused-card{opacity:.65}
.sub-card.paused-card::after{content:'PAUSED';position:absolute;right:10px;bottom:7px;font-size:7px;font-weight:700;letter-spacing:1px;color:var(--paused);font-family:'Cabinet Grotesk',sans-serif;background:var(--p0);padding:2px 6px;border-radius:var(--rpill);border:1px solid rgba(167,139,250,.2)}
.sub-card.trial-card::after{content:'TRIAL';position:absolute;right:10px;bottom:7px;font-size:7px;font-weight:700;letter-spacing:1px;color:var(--trial);font-family:'Cabinet Grotesk',sans-serif;background:var(--t0);padding:2px 6px;border-radius:var(--rpill);border:1px solid rgba(251,146,60,.2)}
.sub-logo{width:39px;height:39px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:800;color:#fff;overflow:hidden;font-family:'Cabinet Grotesk',sans-serif}
.sub-logo img{width:100%;height:100%;object-fit:contain;padding:5px}
.sub-info{flex:1;min-width:0}
.sub-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.2px}
.sub-meta{display:flex;align-items:center;gap:5px;margin-top:3px;flex-wrap:wrap}
.sub-cycle{font-size:10px;color:var(--text3);font-weight:500}
.sdot{width:5px;height:5px;border-radius:50%;display:inline-block;flex-shrink:0}
.sdot.ok{background:var(--success)}
.sdot.soon{background:var(--warn)}
.sdot.over{background:var(--danger)}
.sdot.pre{background:var(--info)}
.sdot.paused{background:var(--paused)}
.sdot.trial{background:var(--trial)}
.sub-right{text-align:right;flex-shrink:0}
.sub-price{font-size:14px;font-weight:800;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.3px}
.sub-next{font-size:10px;color:var(--text3);margin-top:2px;font-weight:500}
/* badges */
.badge{display:inline-flex;align-items:center;font-size:8.5px;font-weight:700;padding:2px 6px;border-radius:var(--rpill);text-transform:uppercase;letter-spacing:.3px;flex-shrink:0}
.badge.upi{background:rgba(99,102,241,.1);color:var(--accent3)}
.badge.card-b{background:rgba(16,185,129,.08);color:var(--success)}
.badge.gplay{background:rgba(6,182,212,.08);color:var(--info)}
.badge.net{background:rgba(245,158,11,.08);color:var(--warn)}
.badge.pre-b{background:rgba(6,182,212,.1);color:var(--info)}
.badge.trial-b{background:var(--t0);color:var(--trial)}
/* prepaid bar */
.pre-bar-row{margin-top:5px;display:flex;align-items:center;gap:6px}
.pre-bar{flex:1;height:2.5px;background:var(--s3);border-radius:2px;overflow:hidden}
.pre-bar-fill{height:100%;background:linear-gradient(90deg,var(--info),#67e8f9);border-radius:2px;transition:width .7s var(--spring)}
.pre-bar-txt{font-size:9px;color:var(--text3);font-weight:700;white-space:nowrap;font-family:'Cabinet Grotesk',sans-serif}
/* trial bar */
.trial-bar-row{margin-top:5px;display:flex;align-items:center;gap:6px}
.trial-bar{flex:1;height:2.5px;background:var(--s3);border-radius:2px;overflow:hidden}
.trial-bar-fill{height:100%;background:linear-gradient(90deg,var(--trial),#fdba74);border-radius:2px}
.trial-bar-txt{font-size:9px;color:var(--text3);font-weight:700;white-space:nowrap;font-family:'Cabinet Grotesk',sans-serif}

/* Empty */
.empty{text-align:center;padding:48px 24px}
.empty-icon{width:58px;height:58px;border-radius:16px;background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.empty-icon svg{width:24px;height:24px;stroke:var(--text3);fill:none;stroke-width:1.5}
.empty h3{font-size:15px;font-weight:700;margin-bottom:5px;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.3px}
.empty p{font-size:12px;color:var(--text3);line-height:1.65}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INSIGHTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.i-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r1);padding:16px;margin-bottom:11px;position:relative;overflow:hidden}
.i-card::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,var(--shine),transparent);pointer-events:none}
.i-card h3{font-size:12px;font-weight:700;margin-bottom:13px;display:flex;align-items:center;gap:7px;font-family:'Cabinet Grotesk',sans-serif;color:var(--text2)}
/* donut */
.donut-wrap{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.donut-svg{width:112px;height:112px;flex-shrink:0}
.donut-legend{display:flex;flex-direction:column;gap:7px;flex:1;min-width:110px}
.d-item{display:flex;align-items:center;gap:7px;font-size:11px}
.d-dot{width:7px;height:7px;border-radius:2px;flex-shrink:0}
.d-name{flex:1;color:var(--text2);font-weight:500}
.d-val{font-weight:700;font-size:11px;font-family:'Cabinet Grotesk',sans-serif}
/* stat rows */
.srow{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.srow:last-child{border-bottom:none}
.srow-l{font-size:12px;color:var(--text2);font-weight:500;flex:1;min-width:0;padding-right:10px}
.srow-r{font-size:12px;font-weight:700;font-family:'Cabinet Grotesk',sans-serif;text-align:right;letter-spacing:-.2px;flex-shrink:0}
/* cat bars */
.cbar-wrap{margin-bottom:9px}
.cbar-head{display:flex;justify-content:space-between;margin-bottom:4px}
.cbar-name{font-size:12px;font-weight:600;color:var(--text2)}
.cbar-val{font-size:11px;font-weight:700;font-family:'Cabinet Grotesk',sans-serif}
.cbar-track{height:5px;background:var(--s3);border-radius:3px;overflow:hidden}
.cbar-fill{height:100%;border-radius:3px;transition:width .8s var(--spring)}
/* grid stat */
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:2px}
.stat-cell{background:var(--s2);border:1px solid var(--border);border-radius:var(--r3);padding:12px;text-align:center}
.stat-cell-v{font-size:20px;font-weight:900;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.5px}
.stat-cell-l{font-size:9px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-top:3px;font-family:'Cabinet Grotesk',sans-serif}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACCOUNT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.acct-avatar{width:66px;height:66px;border-radius:50%;background:linear-gradient(145deg,#6366f1,#4338ca);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff;margin:0 auto 10px;box-shadow:0 0 0 3px var(--s2),0 0 0 4px var(--a2),0 12px 30px rgba(99,102,241,.32);font-family:'Cabinet Grotesk',sans-serif}
.acct-name{text-align:center;font-size:17px;font-weight:800;margin-bottom:3px;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.4px}
.acct-email{text-align:center;font-size:12px;color:var(--text3);margin-bottom:24px;word-break:break-all}
.acct-sec{margin-bottom:18px}
.acct-sec-title{font-size:9px;text-transform:uppercase;letter-spacing:1.3px;color:var(--text3);font-weight:700;margin-bottom:8px;font-family:'Cabinet Grotesk',sans-serif}
.acct-item{background:var(--s1);border:1px solid var(--border);border-radius:var(--r3);padding:12px 14px;display:flex;align-items:center;gap:11px;margin-bottom:7px;transition:transform .15s,background .15s;cursor:pointer}
.acct-item:active{transform:scale(0.97);background:var(--s2)}
.acct-item svg{width:16px;height:16px;stroke:var(--text2);fill:none;stroke-width:2;flex-shrink:0}
.acct-item span{flex:1;font-size:13px;font-weight:500}
.acct-item .chev{width:12px;height:12px;stroke:var(--text3)}
.acct-item.danger span{color:var(--danger)}
.acct-item.danger svg{stroke:var(--danger)}
.acct-footer{text-align:center;margin-top:20px;padding:16px 0 4px;border-top:1px solid var(--border);color:var(--text3);font-size:11px;line-height:1.9}
.acct-footer strong{color:var(--text2);font-weight:700;font-family:'Cabinet Grotesk',sans-serif}
/* Budget card */
.budget-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r2);padding:14px 15px;margin-bottom:16px;position:relative;overflow:hidden}
.budget-card::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,var(--shine),transparent);pointer-events:none}
.budget-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:9px}
.budget-lbl{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.9px;font-family:'Cabinet Grotesk',sans-serif}
.budget-edit-btn{font-size:9px;font-weight:700;color:var(--accent3);background:var(--a1);padding:3px 8px;border-radius:var(--rpill);font-family:'Cabinet Grotesk',sans-serif;border:none;cursor:pointer}
.budget-track{height:7px;background:var(--s3);border-radius:5px;overflow:hidden;margin-bottom:8px}
.budget-bar{height:100%;border-radius:5px;transition:width .8s var(--spring)}
.budget-stats{display:flex;justify-content:space-between;font-family:'Cabinet Grotesk',sans-serif}
.budget-v{font-size:14px;font-weight:800;letter-spacing:-.3px}
.budget-l{font-size:9px;color:var(--text3);margin-top:2px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.nav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(6,6,15,.92);-webkit-backdrop-filter:blur(40px) saturate(200%);backdrop-filter:blur(40px) saturate(200%);border-top:1px solid var(--border);padding-bottom:var(--safe-b)}
.nav-inner{display:flex;height:var(--nav);align-items:center;position:relative}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;color:var(--text3);transition:color .2s;padding:8px 0;-webkit-tap-highlight-color:transparent;position:relative}
.nav-item.on{color:var(--accent3)}
.nav-item svg{width:19px;height:19px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:transform .22s var(--spring)}
.nav-item.on svg{transform:scale(1.1)}
.nav-item span{font-size:9px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;font-family:'Cabinet Grotesk',sans-serif}
.nav-pill{position:absolute;top:-1px;height:2px;background:linear-gradient(90deg,transparent,var(--accent3),transparent);border-radius:0 0 2px 2px;transition:left .3s var(--spring),width .3s var(--spring)}
.nav-badge{position:absolute;top:5px;right:calc(50% - 18px);min-width:16px;height:16px;border-radius:8px;background:var(--danger);border:2px solid var(--bg);font-size:8px;font-weight:800;color:#fff;font-family:'Cabinet Grotesk',sans-serif;display:flex;align-items:center;justify-content:center;padding:0 3px}

/* FAB */
.fab{position:fixed;bottom:calc(var(--nav) + var(--safe-b) + 13px);right:16px;z-index:90;width:50px;height:50px;border-radius:15px;background:linear-gradient(135deg,#6366f1,#4338ca);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(99,102,241,.48),0 0 0 1px rgba(99,102,241,.22),inset 0 1px 0 rgba(255,255,255,.1);transition:transform .2s var(--spring),box-shadow .2s}
.fab:active{transform:scale(0.88);box-shadow:0 4px 12px rgba(99,102,241,.3)}
.fab svg{width:20px;height:20px;stroke:#fff;fill:none;stroke-width:2.5;stroke-linecap:round}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM SHEET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.bs-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.68);opacity:0;pointer-events:none;transition:opacity .25s;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}
.bs-overlay.on{opacity:1;pointer-events:auto}
.bs{position:fixed;bottom:0;left:0;right:0;z-index:201;background:var(--s2);border-radius:24px 24px 0 0;max-height:94vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform 300ms var(--ease);padding-bottom:var(--safe-b);border:1px solid var(--border2);border-bottom:none}
.bs::before{content:'';position:absolute;inset:0;background:linear-gradient(145deg,var(--shine),transparent);pointer-events:none}
.bs.on{transform:translateY(0)}
.bs-handle{width:32px;height:3.5px;background:var(--s4);border-radius:3px;margin:10px auto 0;flex-shrink:0}
.bs-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 18px 13px;flex-shrink:0}
.bs-hdr h2{font-size:17px;font-weight:800;letter-spacing:-.4px;font-family:'Cabinet Grotesk',sans-serif}
.bs-hdr-actions{display:flex;gap:7px;align-items:center}
.bs-close{width:27px;height:27px;border-radius:50%;background:var(--s3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center}
.bs-close svg{width:12px;height:12px;stroke:var(--text2);fill:none;stroke-width:2.5}
.bs-delete-btn{font-size:11px;font-weight:700;color:var(--danger);background:var(--d1);padding:5px 11px;border-radius:var(--rpill);border:1px solid rgba(244,63,94,.15);font-family:'Cabinet Grotesk',sans-serif}
.bs-body{overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 17px 28px;flex:1}

/* Templates */
.tmpl-lbl{font-size:9px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:9px;font-family:'Cabinet Grotesk',sans-serif}
.tmpl-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:18px}
.tmpl-btn{display:flex;flex-direction:column;align-items:center;gap:5px;padding:8px 3px;border-radius:var(--r3);background:var(--s3);border:1.5px solid var(--border);transition:transform .15s,border-color .15s,box-shadow .15s;position:relative}
.tmpl-btn:active{transform:scale(0.9)}
.tmpl-btn.sel{border-color:var(--accent);box-shadow:0 0 0 2px var(--a1)}
.tmpl-ico{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;overflow:hidden;font-family:'Cabinet Grotesk',sans-serif}
.tmpl-ico img{width:100%;height:100%;object-fit:contain;padding:4px}
.tmpl-name{font-size:7.5px;font-weight:700;color:var(--text2);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;font-family:'Cabinet Grotesk',sans-serif;text-transform:uppercase;letter-spacing:.2px}

/* Form */
.fg{margin-bottom:11px}
.fg>label{display:block;font-size:9px;font-weight:700;color:var(--text3);margin-bottom:5px;text-transform:uppercase;letter-spacing:.8px;font-family:'Cabinet Grotesk',sans-serif}
.fi{width:100%;height:43px;background:var(--s3);border:1.5px solid var(--s5);border-radius:var(--r4);padding:0 12px;font-size:13px;transition:border-color .18s,box-shadow .18s;color:var(--text)}
.fi:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--a1)}
.fi::placeholder{color:var(--text3)}
select.fi{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%234a4a6a'%3E%3Cpath d='M5 7L0 2h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;background-color:var(--s3)}
select.fi option{background:var(--s2);color:var(--text)}
.frow{display:flex;gap:9px}
.frow .fg{flex:1}
.fsub{width:100%;height:49px;background:linear-gradient(135deg,#6366f1,#4338ca);border-radius:var(--r3);font-size:14px;font-weight:700;color:#fff;transition:transform .15s,box-shadow .15s;margin-top:7px;letter-spacing:.1px;box-shadow:0 6px 20px rgba(99,102,241,.38),inset 0 1px 0 rgba(255,255,255,.1);font-family:'Cabinet Grotesk',sans-serif}
.fsub:active{transform:scale(0.97)}
.fsub:disabled{opacity:.5}
/* toggles */
.ftoggle{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--s3);border:1.5px solid var(--s5);border-radius:var(--r4);margin-bottom:11px;cursor:pointer;transition:border-color .15s}
.ftoggle.on{border-color:var(--a2);background:var(--a0)}
.ftoggle-lbl{font-size:13px;font-weight:600;color:var(--text2);display:flex;align-items:center;gap:7px}
.tog{width:36px;height:20px;border-radius:10px;background:var(--s5);position:relative;transition:background .2s;flex-shrink:0}
.tog::after{content:'';position:absolute;width:14px;height:14px;border-radius:50%;background:#fff;top:3px;left:3px;transition:transform .2s var(--spring)}
.ftoggle.on .tog{background:var(--accent)}
.ftoggle.on .tog::after{transform:translateX(16px)}
/* section boxes */
.fsection{background:var(--s3);border:1px solid var(--a2);border-radius:var(--r4);padding:12px;margin-bottom:11px;display:none}
.fsection.show{display:block}
/* mode tabs */
.mode-tabs{display:flex;background:var(--s4);border-radius:var(--r4);padding:3px;margin-bottom:10px}
.mode-tab{flex:1;padding:6px 0;text-align:center;font-size:11px;font-weight:700;color:var(--text3);border-radius:6px;transition:all .18s;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:.2px;cursor:pointer}
.mode-tab.on{background:var(--s2);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3)}
/* pay detail */
.pay-detail-box{background:var(--a0);border:1px solid var(--a2);border-radius:var(--r4);padding:11px;margin-bottom:11px;animation:fUp .22s var(--ease)}
/* cat tags */
.cat-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:11px}
.cat-tag{padding:4px 11px;border-radius:var(--rpill);font-size:10px;font-weight:700;background:var(--s2);color:var(--text2);border:1px solid var(--border);transition:all .15s;font-family:'Cabinet Grotesk',sans-serif;text-transform:uppercase;letter-spacing:.2px}
.cat-tag.on{background:var(--a1);color:var(--accent3);border-color:var(--a2)}
.cat-tag:active{transform:scale(0.94)}
/* search */
.search-bar{position:relative;margin-bottom:11px}
.search-bar input{width:100%;height:39px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r3);padding:0 12px 0 36px;font-size:13px;color:var(--text);transition:border-color .18s}
.search-bar input::placeholder{color:var(--text3)}
.search-bar input:focus{border-color:var(--accent);outline:none}
.search-bar svg{position:absolute;left:11px;top:50%;transform:translateY(-50%);width:14px;height:14px;stroke:var(--text3);fill:none;stroke-width:2}
/* summary strip */
.sum-strip{display:flex;align-items:center;justify-content:space-between;background:var(--s1);border:1px solid var(--border);border-radius:var(--r3);padding:9px 14px;margin-bottom:11px}
.strip-item{text-align:center}
.strip-v{font-size:14px;font-weight:800;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.4px}
.strip-l{font-size:9px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-top:2px;font-family:'Cabinet Grotesk',sans-serif}
.strip-div{width:1px;height:24px;background:var(--border)}
/* toast */
.toast{position:fixed;top:calc(11px + var(--safe-t));left:50%;transform:translateX(-50%) translateY(-140%);z-index:500;background:var(--s3);border:1px solid var(--border2);border-radius:var(--r3);padding:9px 15px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;transition:transform .32s var(--spring);white-space:nowrap;max-width:92vw;box-shadow:0 20px 50px rgba(0,0,0,.6);font-family:'Cabinet Grotesk',sans-serif;letter-spacing:.1px}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast-ico{width:17px;height:17px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0}
.toast.ok .toast-ico{background:rgba(16,185,129,.15);color:var(--success)}
.toast.err .toast-ico{background:rgba(244,63,94,.15);color:var(--danger)}
/* budget/modal */
.modal-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.72);display:flex;align-items:flex-end;padding-bottom:var(--safe-b);opacity:0;pointer-events:none;transition:opacity .25s;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}
.modal-overlay.on{opacity:1;pointer-events:auto}
.modal-box{background:var(--s2);border:1px solid var(--border2);border-radius:24px 24px 0 0;padding:22px 18px;width:100%;animation:fUp .28s var(--ease)}
.modal-box h3{font-size:16px;font-weight:800;margin-bottom:14px;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.3px}
.modal-btns{display:flex;gap:8px;margin-top:11px}
.mbtn-cancel{flex:1;height:43px;background:var(--s3);border:1px solid var(--border);border-radius:var(--r3);font-size:13px;font-weight:700;color:var(--text2);font-family:'Cabinet Grotesk',sans-serif}
.mbtn-ok{flex:1;height:43px;background:linear-gradient(135deg,#6366f1,#4338ca);border-radius:var(--r3);font-size:13px;font-weight:700;color:#fff;font-family:'Cabinet Grotesk',sans-serif;box-shadow:0 4px 14px rgba(99,102,241,.32)}
</style>
</head>
<body>

<!-- Loading Splash (shown until Firebase auth resolves) -->
<div id="splash">
  <div class="splash-logo"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 8 12 11.82 4.65 8 12 4.18zM4 9.47l7 3.5V19.7l-7-3.5V9.47zm10 10.23V12.97l7-3.5v6.73l-7 3.5z"/></svg></div>
  <span class="splash-name">SubsTrack</span>
  <div class="splash-dots"><div class="splash-dot"></div><div class="splash-dot"></div><div class="splash-dot"></div></div>
</div>

<!-- Auth -->
<div id="auth-screen">
  <div class="auth-orb"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 8 12 11.82 4.65 8 12 4.18zM4 9.47l7 3.5V19.7l-7-3.5V9.47zm10 10.23V12.97l7-3.5v6.73l-7 3.5z"/></svg></div>
  <h2 class="auth-headline">SubsTrack</h2>
  <p class="auth-sub">Premium subscription management for India üáÆüá≥</p>
  <div class="auth-form">
    <div id="aname-wrap" class="auth-field" style="display:none">
      <input type="text" id="a-name" placeholder=" " autocomplete="name"><label>Display Name</label>
    </div>
    <div class="auth-field">
      <input type="email" id="a-email" placeholder=" " autocomplete="email"><label>Email</label>
    </div>
    <div class="auth-field">
      <input type="password" id="a-pass" placeholder=" " autocomplete="current-password"><label>Password</label>
    </div>
    <button class="auth-action" id="a-btn" onclick="doAuth()">Sign In</button>
    <div class="auth-err" id="a-err"></div>
    <p class="auth-switch" id="a-toggle">No account? <b onclick="toggleAuth()">Sign Up</b></p>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="hdr">
    <div class="hdr-row">
      <div class="hdr-brand">
        <div class="hdr-mark"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 8 12 11.82 4.65 8 12 4.18zM4 9.47l7 3.5V19.7l-7-3.5V9.47zm10 10.23V12.97l7-3.5v6.73l-7 3.5z"/></svg></div>
        <h1>Subs<span>Track</span></h1>
      </div>
      <div class="hdr-btns">
        <button class="hdr-btn" onclick="openSearch()" aria-label="Search"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
        <button class="hdr-btn" id="notif-btn" onclick="switchTab('dashboard')" aria-label="Alerts" style="display:none"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><div class="hdr-badge" id="notif-badge"></div></button>
        <button class="hdr-btn" onclick="toggleSort()" aria-label="Sort"><svg viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="16" y2="12"/><line x1="4" y1="18" x2="12" y2="18"/></svg></button>
        <div class="sort-drop" id="sort-drop">
          <button class="sort-opt on" data-s="date">üìÖ Next Billing</button>
          <button class="sort-opt" data-s="price-asc">üí∞ Low ‚Üí High</button>
          <button class="sort-opt" data-s="price-desc">üí∞ High ‚Üí Low</button>
          <button class="sort-opt" data-s="name">üî§ Name A ‚Üí Z</button>
          <button class="sort-opt" data-s="cat">üóÇ Category</button>
        </div>
      </div>
    </div>
  </div>

  <div class="scroll" id="main-scroll">
    <div class="ptr" id="ptr"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg><span>Syncing</span></div>

    <!-- Dashboard -->
    <div class="tab on" id="tab-dashboard">
      <div id="urgent-wrap"></div>
      <div id="metrics-wrap">
        <div class="metrics-row">
          <div class="mcard skel" style="height:96px;flex:1"></div>
          <div class="mcard skel" style="height:96px;flex:1"></div>
        </div>
      </div>
      <div class="chart-section">
        <div class="slabel">6-Month Projection</div>
        <div class="chart-box">
          <div class="chart-head"><span class="chart-title">Monthly Spend</span><span class="chart-sub" id="chart-sub"></span></div>
          <div class="chart-svg-wrap" id="projection-wrap"></div>
        </div>
      </div>
      <div class="slabel">Upcoming Renewals</div>
      <div class="sub-list" id="dash-list">
        <div class="skel" style="height:66px"></div>
        <div class="skel" style="height:66px;margin-top:7px"></div>
        <div class="skel" style="height:66px;margin-top:7px"></div>
      </div>
    </div>

    <!-- My Subs -->
    <div class="tab" id="tab-subs">
      <div class="search-bar" id="subs-search" style="display:none">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" placeholder="Search subscriptions‚Ä¶" oninput="filterSubs(this.value)">
      </div>
      <div class="cat-tags" id="cat-filters"></div>
      <div id="subs-strip"></div>
      <div class="sub-list" id="subs-list">
        <div class="skel" style="height:66px"></div>
        <div class="skel" style="height:66px;margin-top:7px"></div>
      </div>
    </div>

    <!-- Insights -->
    <div class="tab" id="tab-insights"><div id="insights-wrap"></div></div>

    <!-- Account -->
    <div class="tab" id="tab-account"><div id="account-wrap"></div></div>
  </div>

  <button class="fab" onclick="openAddSheet()" aria-label="Add">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>

  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-pill" id="nav-pill"></div>
      <button class="nav-item on" data-tab="dashboard" onclick="switchTab('dashboard')">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
        <span>Dashboard</span>
      </button>
      <button class="nav-item" data-tab="subs" onclick="switchTab('subs')">
        <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
        <span>My Subs</span>
      </button>
      <button class="nav-item" data-tab="insights" onclick="switchTab('insights')">
        <svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <span>Insights</span>
      </button>
      <button class="nav-item" data-tab="account" onclick="switchTab('account')">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>Account</span>
      </button>
    </div>
  </nav>
</div>

<!-- Sheet overlay -->
<div class="bs-overlay" id="bs-overlay" onclick="closeSheet()"></div>
<div class="bs" id="bottom-sheet">
  <div class="bs-handle"></div>
  <div class="bs-hdr">
    <h2 id="bs-title">New Subscription</h2>
    <div class="bs-hdr-actions">
      <button class="bs-delete-btn" id="bs-delete-btn" style="display:none" onclick="deleteCurrentEdit()">Delete</button>
      <button class="bs-close" onclick="closeSheet()"><svg viewBox="0 0 24 24" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
  </div>
  <div class="bs-body">
    <div class="tmpl-lbl">Quick Templates</div>
    <div class="tmpl-grid" id="tmpl-grid"></div>
    <div class="tmpl-lbl">Details</div>
    <form id="sub-form" onsubmit="return onSubForm(event)">
      <div class="fg"><label>Service Name *</label><input class="fi" id="f-name" required placeholder="e.g. Netflix"></div>
      <div class="fg"><label>Logo URL (optional)</label><input class="fi" id="f-logo" placeholder="https://..."></div>
      <div class="frow">
        <div class="fg"><label>Cost (‚Çπ) *</label><input class="fi" id="f-cost" type="number" min="1" step="0.01" required placeholder="499"></div>
        <div class="fg"><label>Billing Cycle *</label>
          <select class="fi" id="f-cycle" required>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
            <option value="quarterly">Quarterly</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
      </div>
      <div class="fg"><label>Next Billing Date *</label><input class="fi" id="f-date" type="date" required></div>
      <div class="frow">
        <div class="fg"><label>Category</label>
          <select class="fi" id="f-category">
            <option value="Entertainment">Entertainment</option>
            <option value="AI & Productivity">AI & Productivity</option>
            <option value="Food & Delivery">Food & Delivery</option>
            <option value="Music">Music</option>
            <option value="Gaming">Gaming</option>
            <option value="Cloud Storage">Cloud Storage</option>
            <option value="News">News</option>
            <option value="Fitness">Fitness</option>
            <option value="Shopping">Shopping</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="fg"><label>Payment Mode</label>
          <select class="fi" id="f-payment" onchange="onPayChange()">
            <option value="">Select‚Ä¶</option>
            <optgroup label="UPI">
              <option value="UPI/GPay">Google Pay (UPI)</option>
              <option value="UPI/PhonePe">PhonePe (UPI)</option>
              <option value="UPI/Paytm">Paytm (UPI)</option>
              <option value="UPI/BHIM">BHIM UPI</option>
              <option value="UPI/AmazonPay">Amazon Pay UPI</option>
              <option value="UPI/Cred">CRED UPI</option>
              <option value="UPI/Other">UPI (Other)</option>
            </optgroup>
            <optgroup label="Cards">
              <option value="Credit Card">Credit Card</option>
              <option value="Debit Card">Debit Card</option>
              <option value="Prepaid Card">Prepaid Card</option>
            </optgroup>
            <optgroup label="Other">
              <option value="Google Play">Google Play</option>
              <option value="Apple Pay">Apple Pay</option>
              <option value="Net Banking">Net Banking</option>
              <option value="Wallet">Wallet</option>
              <option value="Other">Other</option>
            </optgroup>
          </select>
        </div>
      </div>
      <div id="pay-detail-wrap"></div>

      <!-- Trial Toggle -->
      <div class="ftoggle" id="trial-toggle" onclick="toggleTrial()">
        <span class="ftoggle-lbl"><span>üÜì</span> Free Trial</span>
        <div class="tog" id="trial-tog"></div>
      </div>
      <div class="fsection" id="trial-section">
        <div class="fg"><label>Trial Ends On</label><input class="fi" id="f-trial-end" type="date"></div>
      </div>

      <!-- Prepaid Toggle -->
      <div class="ftoggle" id="prepaid-toggle" onclick="togglePrepaid()">
        <span class="ftoggle-lbl"><span>üéüÔ∏è</span> Prepaid Subscription</span>
        <div class="tog" id="prepaid-tog"></div>
      </div>
      <div class="fsection" id="prepaid-section">
        <!-- Mode selector: Duration OR Direct End Date -->
        <div class="mode-tabs">
          <div class="mode-tab on" id="pre-tab-dur" onclick="setPreMode('duration')">Set Duration</div>
          <div class="mode-tab" id="pre-tab-date" onclick="setPreMode('date')">Set End Date</div>
        </div>
        <!-- Duration mode -->
        <div id="pre-dur-fields">
          <div class="frow">
            <div class="fg"><label>Duration</label><input class="fi" id="f-pre-dur" type="number" min="1" max="120" placeholder="12" oninput="calcPrepaidEnd()"></div>
            <div class="fg"><label>Unit</label>
              <select class="fi" id="f-pre-unit" onchange="calcPrepaidEnd()">
                <option value="months">Months</option>
                <option value="years">Years</option>
                <option value="days">Days</option>
              </select>
            </div>
          </div>
        </div>
        <!-- Direct date mode -->
        <div id="pre-date-fields" style="display:none">
          <div class="fg"><label>Subscription Active Until</label><input class="fi" id="f-pre-direct" type="date" onchange="onDirectDateChange()"></div>
        </div>
        <div class="fg"><label>Valid Until (calculated)</label><input class="fi" id="f-pre-until" type="date" style="opacity:.65" readonly></div>
      </div>

      <!-- Pause Toggle -->
      <div class="ftoggle" id="pause-toggle" onclick="togglePause()">
        <span class="ftoggle-lbl"><span>‚è∏Ô∏è</span> Mark as Paused</span>
        <div class="tog" id="pause-tog"></div>
      </div>

      <div class="fg"><label>Notes (optional)</label><input class="fi" id="f-notes" placeholder="Family plan, shared with‚Ä¶"></div>
      <input type="hidden" id="f-edit-id">
      <input type="hidden" id="f-is-prepaid" value="false">
      <input type="hidden" id="f-is-trial" value="false">
      <input type="hidden" id="f-is-paused" value="false">
      <input type="hidden" id="f-pre-mode" value="duration">
      <button class="fsub" type="submit" id="f-submit">Add Subscription</button>
    </form>
  </div>
</div>

<!-- Budget modal -->
<div class="modal-overlay" id="budget-modal">
  <div class="modal-box">
    <h3>Monthly Budget</h3>
    <p style="font-size:12px;color:var(--text3);margin-bottom:14px">Set a monthly spending limit to track your budget utilisation.</p>
    <div class="fg"><label>Budget Amount (‚Çπ)</label><input class="fi" id="budget-input" type="number" min="0" placeholder="e.g. 5000" oninput="updateBudgetPreview()"></div>
    <div id="budget-preview" style="font-size:12px;color:var(--text3);margin-bottom:4px;min-height:18px"></div>
    <div class="modal-btns">
      <button class="mbtn-cancel" onclick="closeBudgetModal()">Cancel</button>
      <button class="mbtn-ok" onclick="saveBudget()">Save</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"><div class="toast-ico" id="toast-ico"></div><span id="toast-msg"></span></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PWA Setup ‚Äî Android compatible
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const svgStr=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="96" fill="#06060f"/><defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#4338ca"/></linearGradient></defs><rect x="48" y="48" width="416" height="416" rx="88" fill="url(#g)"/><path fill="white" d="M256 112L156 166v108l100 50 100-50V166L256 112zm0 23L331 173l-75 37.5L181 173 256 135zm-80 53.2l68 34V290l-68-34V188.2zm100 68.8l68-34V290l-68 34V257z"/></svg>`;
  const b64=btoa(svgStr);
  const dataURI=`data:image/svg+xml;base64,${b64}`;
  function buildManifest(icon){
    const m={name:'SubsTrack',short_name:'SubsTrack',description:'Premium Subscription Manager for India',start_url:window.location.href,scope:window.location.origin+'/',display:'standalone',background_color:'#06060f',theme_color:'#06060f',orientation:'portrait-primary',categories:['finance','utilities'],icons:[{src:icon,sizes:'192x192',type:'image/png',purpose:'any maskable'},{src:icon,sizes:'512x512',type:'image/png',purpose:'any maskable'}]};
    const blob=new Blob([JSON.stringify(m)],{type:'application/manifest+json'});
    document.getElementById('pwa-manifest').href=URL.createObjectURL(blob);
  }
  try{
    const c=document.createElement('canvas');c.width=192;c.height=192;
    const ctx=c.getContext('2d');
    const img=new Image();
    img.onload=function(){ctx.drawImage(img,0,0,192,192);const png=c.toDataURL('image/png');document.getElementById('apple-icon').href=png;buildManifest(png)};
    img.onerror=()=>buildManifest(dataURI);
    img.src=dataURI;
  }catch(e){buildManifest(dataURI)}
  if('serviceWorker' in navigator){
    const sw=`const C='substrack-v4';
self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open(C).then(c=>c.add('/')))});
self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k)))).then(()=>self.clients.claim())));
self.addEventListener('fetch',e=>{if(e.request.method!=='GET'||!e.request.url.startsWith('http'))return;e.respondWith(fetch(e.request).then(r=>{const cl=r.clone();caches.open(C).then(ca=>ca.put(e.request,cl));return r}).catch(()=>caches.match(e.request)))});`;
    navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'})),{scope:'./'}).catch(()=>{});
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Firebase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FC={apiKey:"AIzaSyAp9negxP0RVgyJD0DJ3uh1Twz0VrNj9Q4",authDomain:"subscriptions-7c00f.firebaseapp.com",projectId:"subscriptions-7c00f",storageBucket:"subscriptions-7c00f.firebasestorage.app",messagingSenderId:"124269956323",appId:"1:124269956323:web:76f5617aae481fdf6bc9d6"};
firebase.initializeApp(FC);
const auth=firebase.auth();
const db=firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  State
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let USER=null,SUBS=[],tab='dashboard';
let isSignUp=false,editId=null,sortMode='date';
let searchQ='',activeCat='All',unsub=null;
let isPrepaid=false,isTrial=false,isPaused=false,preMode='duration';
let budget=0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Templates
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TMPLS=[
  {name:'Netflix',color:'#E50914',logo:'https://cdn.simpleicons.org/netflix/E50914',cost:649,cycle:'monthly',category:'Entertainment'},
  {name:'Amazon Prime',color:'#00A8E1',logo:'https://cdn.simpleicons.org/amazon/00A8E1',cost:1499,cycle:'yearly',category:'Entertainment'},
  {name:'JioHotstar',color:'#1565C0',logo:'https://cdn.simpleicons.org/hotstar/1565C0',cost:899,cycle:'yearly',category:'Entertainment'},
  {name:'YouTube Premium',color:'#FF0000',logo:'https://cdn.simpleicons.org/youtube/FF0000',cost:149,cycle:'monthly',category:'Entertainment'},
  {name:'Spotify',color:'#1DB954',logo:'https://cdn.simpleicons.org/spotify/1DB954',cost:119,cycle:'monthly',category:'Music'},
  {name:'Apple Music',color:'#FC3C44',logo:'https://cdn.simpleicons.org/applemusic/FC3C44',cost:99,cycle:'monthly',category:'Music'},
  {name:'Swiggy One',color:'#FC8019',logo:'https://cdn.simpleicons.org/swiggy/FC8019',cost:299,cycle:'monthly',category:'Food & Delivery'},
  {name:'Zomato Gold',color:'#E23744',logo:'https://cdn.simpleicons.org/zomato/E23744',cost:300,cycle:'monthly',category:'Food & Delivery'},
  {name:'ChatGPT Plus',color:'#10a37f',logo:'https://cdn.simpleicons.org/openai/10a37f',cost:1668,cycle:'monthly',category:'AI & Productivity'},
  {name:'Claude Pro',color:'#D97757',logo:'https://cdn.simpleicons.org/anthropic/D97757',cost:1668,cycle:'monthly',category:'AI & Productivity'},
  {name:'Gemini Advanced',color:'#4285F4',logo:'https://cdn.simpleicons.org/google/4285F4',cost:1950,cycle:'monthly',category:'AI & Productivity'},
  {name:'Grok Premium',color:'#1DA1F2',logo:'https://cdn.simpleicons.org/x/e7e7e7',cost:975,cycle:'monthly',category:'AI & Productivity'},
  {name:'Xbox Game Pass',color:'#107C10',logo:'https://cdn.simpleicons.org/xbox/107C10',cost:999,cycle:'monthly',category:'Gaming'},
  {name:'Google One',color:'#4285F4',logo:'https://cdn.simpleicons.org/google/4285F4',cost:130,cycle:'monthly',category:'Cloud Storage'},
  {name:'iCloud+',color:'#147CE5',logo:'https://cdn.simpleicons.org/icloud/147CE5',cost:75,cycle:'monthly',category:'Cloud Storage'},
  {name:'LinkedIn Premium',color:'#0077B5',logo:'https://cdn.simpleicons.org/linkedin/0077B5',cost:1300,cycle:'monthly',category:'AI & Productivity'},
];

const PAY_CFG={
  'UPI/GPay':{l:'GPay',c:'upi'},'UPI/PhonePe':{l:'PhonePe',c:'upi'},
  'UPI/Paytm':{l:'Paytm',c:'upi'},'UPI/BHIM':{l:'BHIM',c:'upi'},
  'UPI/AmazonPay':{l:'AmzPay',c:'upi'},'UPI/Cred':{l:'CRED',c:'upi'},
  'UPI/Other':{l:'UPI',c:'upi'},
  'Credit Card':{l:'Credit',c:'card-b'},'Debit Card':{l:'Debit',c:'card-b'},
  'Prepaid Card':{l:'Prepaid',c:'card-b'},'Google Play':{l:'GPlay',c:'gplay'},
  'Apple Pay':{l:'Apple',c:'gplay'},'Net Banking':{l:'NetBank',c:'net'},
  'Wallet':{l:'Wallet',c:'net'},'Other':{l:'Other',c:''},
};
const COLORS=['#6366f1','#ec4899','#f59e0b','#10b981','#06b6d4','#f43f5e','#a78bfa','#f97316','#84cc16','#14b8a6'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH ‚Äî Hide splash, show correct screen
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
auth.onAuthStateChanged(u=>{
  USER=u;
  // Hide splash
  document.getElementById('splash').classList.add('hide');
  if(u){
    document.getElementById('auth-screen').classList.remove('visible');
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.add('on');
    loadBudget();
    loadSubs();
  }else{
    document.getElementById('auth-screen').classList.add('visible');
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app').classList.remove('on');
    if(unsub)unsub();
    SUBS=[];
  }
  document.getElementById('a-btn').disabled=false;
});

function toggleAuth(){
  isSignUp=!isSignUp;
  document.getElementById('aname-wrap').style.display=isSignUp?'block':'none';
  document.getElementById('a-btn').textContent=isSignUp?'Create Account':'Sign In';
  document.getElementById('a-toggle').innerHTML=isSignUp?'Have an account? <b onclick="toggleAuth()">Sign In</b>':'No account? <b onclick="toggleAuth()">Sign Up</b>';
  document.getElementById('a-err').textContent='';
}

async function doAuth(){
  const email=document.getElementById('a-email').value.trim();
  const pass=document.getElementById('a-pass').value;
  const btn=document.getElementById('a-btn');
  const err=document.getElementById('a-err');
  if(!email||!pass){err.textContent='Please fill in all fields.';return}
  btn.disabled=true;err.textContent='';
  try{
    if(isSignUp){
      const c=await auth.createUserWithEmailAndPassword(email,pass);
      const name=document.getElementById('a-name').value.trim();
      if(name)await c.user.updateProfile({displayName:name});
      await db.collection('users').doc(c.user.uid).set({email,displayName:name||'',createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    }else{
      await auth.signInWithEmailAndPassword(email,pass);
    }
  }catch(e){
    const M={'auth/email-already-in-use':'Email already registered','auth/invalid-email':'Invalid email','auth/weak-password':'Password must be 6+ characters','auth/user-not-found':'No account with this email','auth/wrong-password':'Incorrect password','auth/invalid-credential':'Invalid email or password','auth/too-many-requests':'Too many attempts ‚Äî try later'};
    err.textContent=M[e.code]||e.message;btn.disabled=false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Firestore
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const subsRef=()=>db.collection('users').doc(USER.uid).collection('subscriptions');
const userRef=()=>db.collection('users').doc(USER.uid);

function loadSubs(){
  if(unsub)unsub();
  unsub=subsRef().onSnapshot(snap=>{
    SUBS=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderAll();
  },()=>showToast('Load error','err'));
}

function loadBudget(){
  userRef().get().then(d=>{if(d.exists&&d.data().budget!=null)budget=d.data().budget}).catch(()=>{});
}

const addSub=async d=>{try{await subsRef().add({...d,createdAt:firebase.firestore.FieldValue.serverTimestamp()});showToast('Added!','ok')}catch(e){showToast('Failed to add','err')}};
const updSub=async(id,d)=>{try{await subsRef().doc(id).update(d);showToast('Saved!','ok')}catch(e){showToast('Failed','err')}};
const delSub=async id=>{try{await subsRef().doc(id).delete();showToast('Removed','ok')}catch(e){showToast('Failed','err')}};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Helpers
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const daysUntil=ds=>{if(!ds)return 9999;const d=new Date(ds);d.setHours(0,0,0,0);const n=new Date();n.setHours(0,0,0,0);return Math.ceil((d-n)/86400000)};
const moEq=(c,cy)=>cy==='yearly'?c/12:cy==='quarterly'?c/3:cy==='weekly'?c*4.33:c;
const yrEq=(c,cy)=>cy==='yearly'?c:cy==='monthly'?c*12:cy==='quarterly'?c*4:cy==='weekly'?c*52:c;
const fINR=n=>'‚Çπ'+Math.round(n).toLocaleString('en-IN');
const fDate=d=>{if(!d)return'‚Äî';return new Date(d).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})};
const fDateS=d=>{if(!d)return'‚Äî';return new Date(d).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'2-digit'})};
const initials=n=>n.split(/\s+/).map(w=>w[0]).join('').substring(0,2).toUpperCase();
const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
const CYCLE_LBL={monthly:'Monthly',yearly:'Yearly',weekly:'Weekly',quarterly:'Quarterly'};

function getStatus(s){
  if(s.isPaused)return{cls:'paused',lbl:'Paused'};
  if(s.isTrial&&s.trialEnd){
    const d=daysUntil(s.trialEnd);
    if(d<0)return{cls:'over',lbl:'Trial Ended'};
    if(d<=3)return{cls:'trial',lbl:`Trial: ${d}d left`};
    return{cls:'trial',lbl:'On Trial'};
  }
  if(s.isPrepaid&&s.prepaidUntil){
    const d=daysUntil(s.prepaidUntil);
    if(d<0)return{cls:'over',lbl:'Expired'};
    if(d<=7)return{cls:'soon',lbl:`Expires in ${d}d`};
    return{cls:'pre',lbl:'Prepaid'};
  }
  const d=daysUntil(s.nextDate);
  if(d<0)return{cls:'over',lbl:'Overdue'};
  if(d===0)return{cls:'soon',lbl:'Due Today'};
  if(d<=3)return{cls:'soon',lbl:`Due in ${d}d`};
  if(d<=7)return{cls:'soon',lbl:`Due in ${d}d`};
  return{cls:'ok',lbl:'Active'};
}

function sortedSubs(list){
  const a=[...list];
  const effDate=s=>s.isPrepaid&&s.prepaidUntil?s.prepaidUntil:(s.nextDate||'9999-12-31');
  if(sortMode==='date')a.sort((x,y)=>new Date(effDate(x))-new Date(effDate(y)));
  else if(sortMode==='price-asc')a.sort((x,y)=>x.cost-y.cost);
  else if(sortMode==='price-desc')a.sort((x,y)=>y.cost-x.cost);
  else if(sortMode==='name')a.sort((x,y)=>x.name.localeCompare(y.name));
  else if(sortMode==='cat')a.sort((x,y)=>(x.category||'Other').localeCompare(y.category||'Other'));
  return a;
}

function filteredSubs(){
  let l=SUBS;
  if(searchQ){const q=searchQ.toLowerCase();l=l.filter(s=>s.name.toLowerCase().includes(q)||(s.notes||'').toLowerCase().includes(q)||(s.category||'').toLowerCase().includes(q))}
  if(activeCat!=='All')l=l.filter(s=>(s.category||'Other')===activeCat);
  return sortedSubs(l);
}

function payBadgeHTML(pm,pd){
  if(!pm)return'';
  const cfg=PAY_CFG[pm];if(!cfg)return'';
  let lbl=cfg.l;
  if(pd?.bankName)lbl=pd.bankName.substring(0,7);
  return`<span class="badge ${cfg.c}">${lbl}</span>`;
}

function alertCount(){
  return SUBS.filter(s=>{
    if(s.isPaused)return false;
    if(s.isPrepaid&&s.prepaidUntil){const d=daysUntil(s.prepaidUntil);return d>=0&&d<=7}
    if(s.isTrial&&s.trialEnd){const d=daysUntil(s.trialEnd);return d>=0&&d<=3}
    const d=daysUntil(s.nextDate);return d>=0&&d<=3;
  }).length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Payment detail fields
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onPayChange(){
  const mode=document.getElementById('f-payment').value;
  const wrap=document.getElementById('pay-detail-wrap');
  if(!mode){wrap.innerHTML='';return}
  const isCard=mode==='Credit Card'||mode==='Debit Card';
  const isNet=mode==='Net Banking';
  const isUPI=mode.startsWith('UPI/');
  const isWallet=mode==='Wallet';
  if(isCard){
    wrap.innerHTML=`<div class="pay-detail-box">
      <div class="frow">
        <div class="fg"><label>Bank Name</label><input class="fi" id="pd-bank" placeholder="HDFC, SBI, ICICI‚Ä¶"></div>
        <div class="fg"><label>Last 4 Digits</label><input class="fi" id="pd-last4" type="text" maxlength="4" placeholder="1234" pattern="[0-9]{4}"></div>
      </div>
      <div class="fg"><label>Card Network</label>
        <select class="fi" id="pd-cardtype">
          <option value="">Select‚Ä¶</option>
          <option value="Visa">Visa</option><option value="Mastercard">Mastercard</option>
          <option value="RuPay">RuPay</option><option value="Amex">American Express</option>
          <option value="Diners">Diners Club</option>
        </select>
      </div>
    </div>`;
  }else if(isNet){
    wrap.innerHTML=`<div class="pay-detail-box"><div class="fg"><label>Bank Name</label><input class="fi" id="pd-bank" placeholder="HDFC, SBI, Axis‚Ä¶"></div></div>`;
  }else if(isUPI){
    wrap.innerHTML=`<div class="pay-detail-box"><div class="fg"><label>UPI ID (optional)</label><input class="fi" id="pd-upiid" placeholder="yourname@bank"></div></div>`;
  }else if(isWallet){
    wrap.innerHTML=`<div class="pay-detail-box"><div class="fg"><label>Wallet Name</label><input class="fi" id="pd-wallet" placeholder="Paytm, Ola Money‚Ä¶"></div></div>`;
  }else{wrap.innerHTML=''}
}

function getPayDetail(){
  const mode=document.getElementById('f-payment').value;
  const isCard=mode==='Credit Card'||mode==='Debit Card';
  const isNet=mode==='Net Banking';
  const isUPI=mode.startsWith('UPI/');
  const isWallet=mode==='Wallet';
  const d={};
  if(isCard){d.bankName=(document.getElementById('pd-bank')?.value||'').trim();d.last4=(document.getElementById('pd-last4')?.value||'').trim();d.cardType=(document.getElementById('pd-cardtype')?.value||'');}
  else if(isNet){d.bankName=(document.getElementById('pd-bank')?.value||'').trim();}
  else if(isUPI){d.upiId=(document.getElementById('pd-upiid')?.value||'').trim();}
  else if(isWallet){d.walletName=(document.getElementById('pd-wallet')?.value||'').trim();}
  return Object.values(d).some(v=>v)?d:null;
}

function fillPayDetail(pd,pm){
  if(!pd||!pm)return;
  setTimeout(()=>{
    const isCard=pm==='Credit Card'||pm==='Debit Card';
    const isNet=pm==='Net Banking';const isUPI=pm.startsWith('UPI/');const isWallet=pm==='Wallet';
    if(isCard){if(document.getElementById('pd-bank'))document.getElementById('pd-bank').value=pd.bankName||'';if(document.getElementById('pd-last4'))document.getElementById('pd-last4').value=pd.last4||'';if(document.getElementById('pd-cardtype'))document.getElementById('pd-cardtype').value=pd.cardType||'';}
    else if(isNet){if(document.getElementById('pd-bank'))document.getElementById('pd-bank').value=pd.bankName||'';}
    else if(isUPI){if(document.getElementById('pd-upiid'))document.getElementById('pd-upiid').value=pd.upiId||'';}
    else if(isWallet){if(document.getElementById('pd-wallet'))document.getElementById('pd-wallet').value=pd.walletName||'';}
  },60);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Form Toggles
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTrial(){
  isTrial=!isTrial;
  document.getElementById('trial-toggle').classList.toggle('on',isTrial);
  document.getElementById('trial-section').classList.toggle('show',isTrial);
  document.getElementById('f-is-trial').value=isTrial?'true':'false';
}

function togglePrepaid(){
  isPrepaid=!isPrepaid;
  document.getElementById('prepaid-toggle').classList.toggle('on',isPrepaid);
  document.getElementById('prepaid-section').classList.toggle('show',isPrepaid);
  document.getElementById('f-is-prepaid').value=isPrepaid?'true':'false';
  if(isPrepaid)calcPrepaidEnd();
}

function togglePause(){
  isPaused=!isPaused;
  document.getElementById('pause-toggle').classList.toggle('on',isPaused);
  document.getElementById('f-is-paused').value=isPaused?'true':'false';
}

function setPreMode(mode){
  preMode=mode;
  document.getElementById('f-pre-mode').value=mode;
  document.getElementById('pre-tab-dur').classList.toggle('on',mode==='duration');
  document.getElementById('pre-tab-date').classList.toggle('on',mode==='date');
  document.getElementById('pre-dur-fields').style.display=mode==='duration'?'block':'none';
  document.getElementById('pre-date-fields').style.display=mode==='date'?'block':'none';
  if(mode==='duration')calcPrepaidEnd();
}

function calcPrepaidEnd(){
  if(preMode!=='duration')return;
  const dur=parseInt(document.getElementById('f-pre-dur').value)||0;
  const unit=document.getElementById('f-pre-unit').value;
  const start=document.getElementById('f-date').value;
  if(!dur||!start){document.getElementById('f-pre-until').value='';return}
  const d=new Date(start);
  if(unit==='years')d.setFullYear(d.getFullYear()+dur);
  else if(unit==='months')d.setMonth(d.getMonth()+dur);
  else if(unit==='days')d.setDate(d.getDate()+dur);
  document.getElementById('f-pre-until').value=d.toISOString().split('T')[0];
}

function onDirectDateChange(){
  const v=document.getElementById('f-pre-direct').value;
  document.getElementById('f-pre-until').value=v;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Render All
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){renderDash();renderSubsList();renderInsights();renderAccount();updateAlertBadge()}

function updateAlertBadge(){
  const cnt=alertCount();
  const btn=document.getElementById('notif-btn');
  const badge=document.getElementById('notif-badge');
  btn.style.display=cnt>0?'flex':'none';
  badge.textContent=cnt>9?'9+':cnt;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Dashboard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDash(){
  const activeSubs=SUBS.filter(s=>!s.isPaused);
  const monthly=activeSubs.reduce((s,i)=>s+moEq(i.cost,i.cycle),0);
  const yearly=activeSubs.reduce((s,i)=>s+yrEq(i.cost,i.cycle),0);

  // Urgent
  const urgent=SUBS.filter(s=>{
    if(s.isPaused)return false;
    if(s.isPrepaid&&s.prepaidUntil){const d=daysUntil(s.prepaidUntil);return d>=0&&d<=7}
    if(s.isTrial&&s.trialEnd){const d=daysUntil(s.trialEnd);return d>=0&&d<=3}
    const d=daysUntil(s.nextDate);return d>=0&&d<=3;
  }).sort((a,b)=>{
    const da=a.isPrepaid?daysUntil(a.prepaidUntil||''):a.isTrial?daysUntil(a.trialEnd||''):daysUntil(a.nextDate);
    const db=b.isPrepaid?daysUntil(b.prepaidUntil||''):b.isTrial?daysUntil(b.trialEnd||''):daysUntil(b.nextDate);
    return da-db;
  });

  const urgentEl=document.getElementById('urgent-wrap');
  if(urgent.length){
    urgentEl.innerHTML='<div class="slabel" style="margin-bottom:8px">‚ö†Ô∏è Needs Attention</div>'+urgent.map(s=>{
      const d=s.isPrepaid?daysUntil(s.prepaidUntil||''):s.isTrial?daysUntil(s.trialEnd||''):daysUntil(s.nextDate);
      const tmpl=TMPLS.find(t=>t.name===s.name);const color=s.brandColor||tmpl?.color||'#6366f1';
      const logo=s.logo?`<img src="${esc(s.logo)}" onerror="this.parentNode.textContent='${initials(s.name)}'">`:initials(s.name);
      const lbl=s.isTrial?`Trial ends in ${d}d`:s.isPrepaid?(d===0?'Expires Today':`Expires in ${d}d`):(d===0?'Due Today':`Due in ${d}d`);
      return`<div class="urgent-card" onclick="openEditSheet('${s.id}')">
        <div class="urgent-icon" style="background:${color}22">${logo}</div>
        <div class="urgent-info"><div class="urgent-name">${esc(s.name)}</div><div class="urgent-detail">${lbl}</div></div>
        <div class="urgent-amt">${fINR(s.cost)}</div>
      </div>`;
    }).join('');
  }else{urgentEl.innerHTML=''}

  // Budget card
  let budgetHTML='';
  if(budget>0){
    const pct=Math.min((monthly/budget)*100,100);
    const over=monthly>budget;
    const bar=over?'linear-gradient(90deg,#f43f5e,#e11d48)':pct>80?'linear-gradient(90deg,#f59e0b,#d97706)':'linear-gradient(90deg,#6366f1,#818cf8)';
    budgetHTML=`<div class="budget-card" style="margin-bottom:14px">
      <div class="budget-head"><span class="budget-lbl">Monthly Budget</span><button class="budget-edit-btn" onclick="openBudgetModal()">Edit</button></div>
      <div class="budget-track"><div class="budget-bar" style="width:${pct}%;background:${bar}"></div></div>
      <div class="budget-stats">
        <div><div class="budget-v">${fINR(monthly)}</div><div class="budget-l">Spent</div></div>
        <div style="text-align:center"><div class="budget-v" style="color:${over?'var(--danger)':'var(--success)'}">${over?fINR(monthly-budget)+' over':fINR(budget-monthly)+' left'}</div><div class="budget-l">${over?'Over Budget':'Remaining'}</div></div>
        <div style="text-align:right"><div class="budget-v">${fINR(budget)}</div><div class="budget-l">Budget</div></div>
      </div>
    </div>`;
  }

  document.getElementById('metrics-wrap').innerHTML=budgetHTML+`
    <div class="metrics-row">
      <div class="mcard">
        <div class="mcard-glow" style="background:rgba(99,102,241,.45)"></div>
        <div class="mcard-label">Monthly</div>
        <div class="mcard-val"><span class="cur">‚Çπ</span>${Math.round(monthly).toLocaleString('en-IN')}</div>
        <div class="mcard-sub">${activeSubs.length} active ¬∑ ${SUBS.filter(s=>s.isPaused).length} paused</div>
      </div>
      <div class="mcard">
        <div class="mcard-glow" style="background:rgba(16,185,129,.35)"></div>
        <div class="mcard-label">Yearly</div>
        <div class="mcard-val"><span class="cur">‚Çπ</span>${Math.round(yearly).toLocaleString('en-IN')}</div>
        <div class="mcard-sub">${fINR(monthly/30)}/day avg</div>
      </div>
    </div>`;

  renderProjectionChart(monthly);

  // Upcoming renewals (sorted, active only)
  const upcoming=sortedSubs(SUBS).filter(s=>{
    if(s.isPaused)return false;
    if(s.isPrepaid)return daysUntil(s.prepaidUntil||'')>=0;
    return true;
  }).slice(0,6);
  const dashEl=document.getElementById('dash-list');
  if(!upcoming.length){
    dashEl.innerHTML=`<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div><h3>No Subscriptions Yet</h3><p>Tap the + button to add your first subscription.</p></div>`;
    return;
  }
  dashEl.innerHTML=upcoming.map(s=>subCardHTML(s)).join('');
  initSwipe(dashEl);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Projection Chart ‚Äî proper SVG bar chart
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProjectionChart(monthly){
  const W=340,H=130,PL=44,PT=10,PB=28,PR=8;
  const now=new Date();
  const months=Array.from({length:6},(_,i)=>{
    const d=new Date(now.getFullYear(),now.getMonth()+i,1);
    const noise=i===0?0:(Math.sin(i*1.7)*.04+Math.sin(i*3.1)*.02);
    return{
      lbl:d.toLocaleDateString('en-IN',{month:'short'}),
      yr:"'"+d.getFullYear().toString().slice(2),
      val:i===0?monthly:monthly*(1+noise),
      cur:i===0
    };
  });

  const maxVal=Math.max(...months.map(m=>m.val),1);
  const gridVals=[0,.25,.5,.75,1].map(f=>maxVal*f);
  const chartW=W-PL-PR;const chartH=H-PT-PB;
  const barW=Math.min(32,chartW/months.length-8);

  // grid lines
  const gridLines=gridVals.map(v=>{
    const y=PT+chartH-(v/maxVal)*chartH;
    const label=v===0?'0':v>=1000?Math.round(v/1000)+'k':Math.round(v);
    return`<line x1="${PL}" y1="${y}" x2="${W-PR}" y2="${y}" stroke="rgba(255,255,255,.04)" stroke-width="1"/>
    <text x="${PL-4}" y="${y+3.5}" text-anchor="end" fill="#4a4a6a" font-size="8" font-family="Cabinet Grotesk,sans-serif" font-weight="700">‚Çπ${label}</text>`;
  }).join('');

  // bars
  const bars=months.map((m,i)=>{
    const x=PL+(i/months.length)*chartW+(chartW/months.length-barW)/2;
    const barH=Math.max((m.val/maxVal)*chartH,3);
    const y=PT+chartH-barH;
    const fill=m.cur?'url(#barGrad)':'url(#barGradDim)';
    const tipY=y-5;
    const tipLabel=m.val>=1000?'‚Çπ'+Math.round(m.val/100)/10+'k':'‚Çπ'+Math.round(m.val);
    return`<rect x="${x}" y="${y}" width="${barW}" height="${barH}" fill="${fill}" rx="5"/>
    <text x="${x+barW/2}" y="${tipY}" text-anchor="middle" fill="${m.cur?'#a5b4fc':'#4a4a6a'}" font-size="7.5" font-family="Cabinet Grotesk,sans-serif" font-weight="700">${tipLabel}</text>
    <text x="${x+barW/2}" y="${H-PT+4}" text-anchor="middle" fill="#4a4a6a" font-size="8" font-family="Cabinet Grotesk,sans-serif" font-weight="700">${m.lbl}</text>
    <text x="${x+barW/2}" y="${H-PT+13}" text-anchor="middle" fill="#333350" font-size="7" font-family="Cabinet Grotesk,sans-serif">${m.yr}</text>`;
  }).join('');

  const total=months.reduce((s,m)=>s+m.val,0);
  document.getElementById('chart-sub').textContent=`6M: ${fINR(total)}`;

  document.getElementById('projection-wrap').innerHTML=`<svg width="100%" viewBox="0 0 ${W} ${H+18}" xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
    <defs>
      <linearGradient id="barGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#818cf8"/>
        <stop offset="100%" stop-color="#6366f1" stop-opacity=".7"/>
      </linearGradient>
      <linearGradient id="barGradDim" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#1f1f42"/>
        <stop offset="100%" stop-color="#191933"/>
      </linearGradient>
    </defs>
    ${gridLines}
    <line x1="${PL}" y1="${PT}" x2="${PL}" y2="${PT+chartH}" stroke="rgba(255,255,255,.05)" stroke-width="1"/>
    ${bars}
  </svg>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Sub Card HTML
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function subCardHTML(s){
  const st=getStatus(s);
  const tmpl=TMPLS.find(t=>t.name===s.name);
  const color=s.brandColor||tmpl?.color||'var(--accent)';
  const logo=s.logo?`<img src="${esc(s.logo)}" onerror="this.parentNode.textContent='${initials(s.name)}'">`:initials(s.name);

  let extraBar='';
  if(s.isPrepaid&&s.prepaidUntil){
    const dLeft=Math.max(0,daysUntil(s.prepaidUntil));
    const totalDays=s.prepaidUnit==='years'?(s.prepaidDuration||12)*365:s.prepaidUnit==='days'?(s.prepaidDuration||30):(s.prepaidDuration||12)*30;
    const pct=totalDays>0?Math.max(0,Math.min(100,(dLeft/totalDays)*100)):50;
    extraBar=`<div class="pre-bar-row"><div class="pre-bar"><div class="pre-bar-fill" style="width:${pct}%"></div></div><span class="pre-bar-txt">${dLeft}d left</span></div>`;
  }
  if(s.isTrial&&s.trialEnd){
    const dLeft=Math.max(0,daysUntil(s.trialEnd));
    const totalDays=14;
    const pct=Math.max(0,Math.min(100,(dLeft/totalDays)*100));
    extraBar=`<div class="trial-bar-row"><div class="trial-bar"><div class="trial-bar-fill" style="width:${pct}%"></div></div><span class="trial-bar-txt">Trial: ${dLeft}d left</span></div>`;
  }

  const payBadge=payBadgeHTML(s.paymentMode,s.payDetail);
  const d=s.isPrepaid?daysUntil(s.prepaidUntil||''):s.isTrial?daysUntil(s.trialEnd||''):daysUntil(s.nextDate||'');
  const isOver=d<0;
  const nextTxt=s.isPrepaid?`Until ${fDateS(s.prepaidUntil)}`:s.isTrial?`Trial until ${fDateS(s.trialEnd)}`:(isOver?'‚ö† Overdue':fDateS(s.nextDate));
  const cardClass=s.isPaused?'paused-card':s.isTrial?'trial-card':'';

  return`<div class="sw-wrapper" data-id="${s.id}" style="max-height:180px">
    <div class="sw-del-bg"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
    <div class="sub-card ${cardClass}" data-id="${s.id}" onclick="openEditSheet('${s.id}')">
      <div class="sub-logo" style="background:${color}1a">${logo}</div>
      <div class="sub-info">
        <div class="sub-name">${esc(s.name)}</div>
        <div class="sub-meta">
          <span class="sdot ${st.cls}"></span>
          <span class="sub-cycle">${CYCLE_LBL[s.cycle]||s.cycle}</span>
          ${payBadge}
          ${s.isPrepaid?'<span class="badge pre-b">Prepaid</span>':''}
          ${s.isTrial?'<span class="badge trial-b">Trial</span>':''}
        </div>
        ${extraBar}
      </div>
      <div class="sub-right">
        <div class="sub-price">${fINR(s.cost)}</div>
        <div class="sub-next">${nextTxt}</div>
      </div>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  My Subs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSubsList(){
  const cats=['All',...[...new Set(SUBS.map(s=>s.category||'Other'))].sort()];
  document.getElementById('cat-filters').innerHTML=cats.map(c=>`<button class="cat-tag${activeCat===c?' on':''}" onclick="setCat('${c}')">${c}</button>`).join('');
  const list=filteredSubs();
  const stripEl=document.getElementById('subs-strip');
  if(list.length){
    const m=list.filter(s=>!s.isPaused).reduce((s,i)=>s+moEq(i.cost,i.cycle),0);
    const alerts=list.filter(s=>{
      if(s.isPaused)return false;
      if(s.isPrepaid&&s.prepaidUntil)return daysUntil(s.prepaidUntil)<0;
      return daysUntil(s.nextDate||'9999')<0;
    }).length;
    const paused=list.filter(s=>s.isPaused).length;
    stripEl.innerHTML=`<div class="sum-strip">
      <div class="strip-item"><div class="strip-v">${list.length}</div><div class="strip-l">Total</div></div>
      <div class="strip-div"></div>
      <div class="strip-item"><div class="strip-v">${fINR(m)}</div><div class="strip-l">Monthly</div></div>
      <div class="strip-div"></div>
      <div class="strip-item"><div class="strip-v" style="color:${paused?'var(--paused)':'var(--text2)'}">${paused}</div><div class="strip-l">Paused</div></div>
      <div class="strip-div"></div>
      <div class="strip-item"><div class="strip-v" style="color:${alerts?'var(--danger)':'var(--success)'}">${alerts}</div><div class="strip-l">Alerts</div></div>
    </div>`;
  }else{stripEl.innerHTML=''}
  const el=document.getElementById('subs-list');
  if(!list.length){el.innerHTML=`<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div><h3>Nothing here</h3><p>Try a different filter or add a new subscription.</p></div>`;return}
  el.innerHTML=list.map(s=>subCardHTML(s)).join('');
  initSwipe(el);
}

const setCat=c=>{activeCat=c;renderSubsList()};
const filterSubs=q=>{searchQ=q;renderSubsList()};
function openSearch(){
  const el=document.getElementById('subs-search');
  if(tab!=='subs')switchTab('subs');
  const open=el.style.display!=='none';
  el.style.display=open?'none':'block';
  if(!open)setTimeout(()=>el.querySelector('input').focus(),100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Insights
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderInsights(){
  const el=document.getElementById('insights-wrap');
  if(!SUBS.length){el.innerHTML=`<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div><h3>No data yet</h3><p>Add subscriptions to unlock detailed spending insights.</p></div>`;return}

  const active=SUBS.filter(s=>!s.isPaused);
  const monthly=active.reduce((s,i)=>s+moEq(i.cost,i.cycle),0);
  const yearly=active.reduce((s,i)=>s+yrEq(i.cost,i.cycle),0);
  const pausedSavings=SUBS.filter(s=>s.isPaused).reduce((s,i)=>s+moEq(i.cost,i.cycle),0);

  // Category map
  const catMap={};active.forEach(s=>{const c=s.category||'Other';catMap[c]=(catMap[c]||0)+moEq(s.cost,s.cycle)});
  const catE=Object.entries(catMap).sort((a,b)=>b[1]-a[1]);
  const catMax=catE[0]?catE[0][1]:1;

  // Payment map
  const payMap={};SUBS.forEach(s=>{const p=s.paymentMode||'Not Set';payMap[p]=(payMap[p]||0)+1});
  const payE=Object.entries(payMap).sort((a,b)=>b[1]-a[1]);

  // Top by spend
  const topSubs=[...active].sort((a,b)=>moEq(b.cost,b.cycle)-moEq(a.cost,a.cycle)).slice(0,5);

  // Next 30 days
  const next30=sortedSubs(active).filter(s=>{
    const d=s.isPrepaid?daysUntil(s.prepaidUntil||''):daysUntil(s.nextDate||'');
    return d>=0&&d<=30;
  });
  const next30total=next30.filter(s=>!s.isPrepaid).reduce((sum,s)=>sum+s.cost,0);

  // Donut
  const total=catE.reduce((s,e)=>s+e[1],0);
  let cum=0;const r=46,cx=58,cy=58;
  const arcs=catE.map((e,i)=>{
    if(total===0)return'';
    const pct=e[1]/total*100;const start=cum*3.6;cum+=pct;const end=cum*3.6;
    const large=pct>50?1:0;
    const x1=cx+r*Math.cos((start-90)*Math.PI/180);const y1=cy+r*Math.sin((start-90)*Math.PI/180);
    const x2=cx+r*Math.cos((end-90)*Math.PI/180);const y2=cy+r*Math.sin((end-90)*Math.PI/180);
    return`<path d="M${cx},${cy} L${x1.toFixed(1)},${y1.toFixed(1)} A${r},${r} 0 ${large},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${COLORS[i%COLORS.length]}" opacity=".9"/>`;
  }).join('');

  // 6-month trend SVG
  const now=new Date();
  const trendMonths=Array.from({length:6},(_,i)=>{
    const offset=5-i;
    const d=new Date(now.getFullYear(),now.getMonth()-offset,1);
    const noise=i===5?0:(Math.sin(i*1.8)*.05+Math.sin(i*3.5)*.025);
    return{lbl:d.toLocaleDateString('en-IN',{month:'short'}),val:monthly*(1+noise),cur:i===5};
  });
  const tMax=Math.max(...trendMonths.map(d=>d.val),1);
  const TW=320,TH=80,TPL=36,TPT=12,TPB=22,TPR=8;
  const tChartW=TW-TPL-TPR;const tChartH=TH-TPT-TPB;

  const tGridVals=[0,0.5,1].map(f=>tMax*f);
  const tGridLines=tGridVals.map(v=>{
    const y=TPT+tChartH-(v/tMax)*tChartH;
    const label=v===0?'0':v>=1000?'‚Çπ'+Math.round(v/1000)+'k':'‚Çπ'+Math.round(v);
    return`<line x1="${TPL}" y1="${y}" x2="${TW-TPR}" y2="${y}" stroke="rgba(255,255,255,.035)" stroke-width="1"/>
    <text x="${TPL-4}" y="${y+3}" text-anchor="end" fill="#4a4a6a" font-size="7" font-family="Cabinet Grotesk,sans-serif" font-weight="700">${label}</text>`;
  }).join('');

  const pts=trendMonths.map((d,i)=>{
    const x=TPL+(i/(trendMonths.length-1))*tChartW;
    const y=TPT+tChartH-(d.val/tMax)*tChartH;
    return`${x},${y}`;
  }).join(' ');
  const areaPath=trendMonths.map((d,i)=>{
    const x=TPL+(i/(trendMonths.length-1))*tChartW;
    const y=TPT+tChartH-(d.val/tMax)*tChartH;
    return i===0?`M${x},${y}`:`L${x},${y}`;
  }).join(' ')+` L${TPL+tChartW},${TPT+tChartH} L${TPL},${TPT+tChartH} Z`;
  const dots=trendMonths.map((d,i)=>{
    const x=TPL+(i/(trendMonths.length-1))*tChartW;
    const y=TPT+tChartH-(d.val/tMax)*tChartH;
    const lbl=d.val>=1000?'‚Çπ'+Math.round(d.val/100)/10+'k':'‚Çπ'+Math.round(d.val);
    return`<circle cx="${x}" cy="${y}" r="${d.cur?4:2.5}" fill="${d.cur?'#818cf8':'#6366f1'}" ${d.cur?'stroke="#a5b4fc" stroke-width="1.5"':''}/>${d.cur?`<text x="${x}" y="${y-8}" text-anchor="middle" fill="#a5b4fc" font-size="7.5" font-family="Cabinet Grotesk,sans-serif" font-weight="700">${lbl}</text>`:''}
    <text x="${x}" y="${TH}" text-anchor="middle" fill="#4a4a6a" font-size="7.5" font-family="Cabinet Grotesk,sans-serif" font-weight="700">${d.lbl}</text>`;
  }).join('');

  const trendSVG=`<svg width="100%" viewBox="0 0 ${TW} ${TH+4}" xmlns="http://www.w3.org/2000/svg" style="overflow:visible">
    <defs>
      <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#6366f1" stop-opacity=".25"/>
        <stop offset="100%" stop-color="#6366f1" stop-opacity="0"/>
      </linearGradient>
    </defs>
    ${tGridLines}
    <line x1="${TPL}" y1="${TPT}" x2="${TPL}" y2="${TPT+tChartH}" stroke="rgba(255,255,255,.04)" stroke-width="1"/>
    <path d="${areaPath}" fill="url(#areaGrad)"/>
    <polyline points="${pts}" fill="none" stroke="#6366f1" stroke-width="1.8" stroke-linejoin="round" stroke-linecap="round"/>
    ${dots}
  </svg>`;

  // Health score
  const overdue=SUBS.filter(s=>!s.isPaused&&!s.isPrepaid&&daysUntil(s.nextDate||'')<0).length;
  const expiredPrepaid=SUBS.filter(s=>s.isPrepaid&&daysUntil(s.prepaidUntil||'')<0).length;
  const score=Math.max(0,Math.min(100,100-overdue*20-expiredPrepaid*10-(pausedSavings>0?5:0)));
  const scoreColor=score>=80?'var(--success)':score>=60?'var(--warn)':'var(--danger)';
  const scoreLabel=score>=80?'Excellent':score>=60?'Good':score>=40?'Fair':'Needs Attention';

  el.innerHTML=`
  <!-- Health score -->
  <div class="i-card">
    <h3>üè• Subscription Health</h3>
    <div style="display:flex;align-items:center;gap:16px">
      <div style="text-align:center;flex-shrink:0">
        <div style="font-size:38px;font-weight:900;font-family:'Cabinet Grotesk',sans-serif;color:${scoreColor};line-height:1;letter-spacing:-1px">${score}</div>
        <div style="font-size:9px;color:${scoreColor};font-weight:700;text-transform:uppercase;letter-spacing:.7px;font-family:'Cabinet Grotesk',sans-serif">${scoreLabel}</div>
      </div>
      <div style="flex:1">
        <div style="height:8px;background:var(--s3);border-radius:4px;overflow:hidden;margin-bottom:8px"><div style="width:${score}%;height:100%;background:${scoreColor};border-radius:4px;transition:width .8s var(--spring)"></div></div>
        <div class="srow" style="padding:5px 0;border-bottom:none"><span class="srow-l">Overdue</span><span class="srow-r" style="color:${overdue?'var(--danger)':'var(--success)'}">${overdue}</span></div>
        <div class="srow" style="padding:5px 0;border-bottom:none"><span class="srow-l">Expired prepaid</span><span class="srow-r" style="color:${expiredPrepaid?'var(--danger)':'var(--success)'}">${expiredPrepaid}</span></div>
        <div class="srow" style="padding:5px 0;border-bottom:none"><span class="srow-l">Paused savings</span><span class="srow-r" style="color:var(--paused)">${fINR(pausedSavings)}/mo</span></div>
      </div>
    </div>
  </div>

  <!-- Overview grid -->
  <div class="i-card">
    <h3>üìä Spending Overview</h3>
    <div class="stat-grid">
      <div class="stat-cell"><div class="stat-cell-v">${fINR(monthly)}</div><div class="stat-cell-l">Per Month</div></div>
      <div class="stat-cell"><div class="stat-cell-v">${fINR(yearly)}</div><div class="stat-cell-l">Per Year</div></div>
      <div class="stat-cell"><div class="stat-cell-v" style="color:var(--warn)">${fINR(next30total)}</div><div class="stat-cell-l">Next 30 Days</div></div>
      <div class="stat-cell"><div class="stat-cell-v" style="color:var(--accent3)">${fINR(monthly/30)}</div><div class="stat-cell-l">Per Day</div></div>
    </div>
  </div>

  <!-- 6-month trend -->
  <div class="i-card">
    <h3>üìà 6-Month Trend</h3>
    <div class="line-svg-wrap">${trendSVG}</div>
  </div>

  <!-- Category donut -->
  <div class="i-card">
    <h3>üóÇ Category Split</h3>
    <div class="donut-wrap">
      <svg class="donut-svg" viewBox="0 0 116 116">
        ${arcs||`<circle cx="58" cy="58" r="46" fill="var(--s3)"/>`}
        <circle cx="${cx}" cy="${cy}" r="26" fill="var(--s1)"/>
        <text x="${cx}" y="${cy-4}" text-anchor="middle" fill="var(--text)" font-size="9.5" font-weight="900" font-family="Cabinet Grotesk,sans-serif">${fINR(monthly)}</text>
        <text x="${cx}" y="${cy+8}" text-anchor="middle" fill="var(--text3)" font-size="6" font-family="Cabinet Grotesk,sans-serif">/month</text>
      </svg>
      <div class="donut-legend">${catE.map((e,i)=>`<div class="d-item"><div class="d-dot" style="background:${COLORS[i%COLORS.length]}"></div><span class="d-name">${esc(e[0])}</span><span class="d-val">${fINR(e[1])}</span></div>`).join('')}</div>
    </div>
  </div>

  <!-- Category bars -->
  <div class="i-card">
    <h3>üí≥ Category Breakdown</h3>
    ${catE.map((e,i)=>{const pct=(e[1]/catMax)*100;const cnt=active.filter(s=>(s.category||'Other')===e[0]).length;
    return`<div class="cbar-wrap"><div class="cbar-head"><span class="cbar-name">${esc(e[0])}</span><span class="cbar-val">${fINR(e[1])}/mo ¬∑ ${cnt}</span></div><div class="cbar-track"><div class="cbar-fill" style="width:${pct}%;background:${COLORS[i%COLORS.length]}"></div></div></div>`;}).join('')}
  </div>

  <!-- Top by spend -->
  <div class="i-card">
    <h3>üèÜ Top by Spend</h3>
    ${topSubs.map((s,i)=>{const mo=moEq(s.cost,s.cycle);const pct=monthly>0?(mo/monthly)*100:0;
    return`<div class="cbar-wrap"><div class="cbar-head"><span class="cbar-name">${i+1}. ${esc(s.name)}</span><span class="cbar-val">${fINR(mo)}/mo</span></div><div class="cbar-track"><div class="cbar-fill" style="width:${pct}%;background:${COLORS[i%COLORS.length]}"></div></div></div>`;}).join('')}
  </div>

  <!-- Quick stats -->
  <div class="i-card">
    <h3>üìã Quick Stats</h3>
    <div class="srow"><span class="srow-l">Total subscriptions</span><span class="srow-r">${SUBS.length}</span></div>
    <div class="srow"><span class="srow-l">Active</span><span class="srow-r">${active.length}</span></div>
    <div class="srow"><span class="srow-l">Paused</span><span class="srow-r" style="color:var(--paused)">${SUBS.filter(s=>s.isPaused).length}</span></div>
    <div class="srow"><span class="srow-l">Prepaid</span><span class="srow-r">${SUBS.filter(s=>s.isPrepaid).length}</span></div>
    <div class="srow"><span class="srow-l">On trial</span><span class="srow-r" style="color:var(--trial)">${SUBS.filter(s=>s.isTrial).length}</span></div>
    <div class="srow"><span class="srow-l">Avg per sub</span><span class="srow-r">${fINR(monthly/(active.length||1))}/mo</span></div>
    ${SUBS.length?`<div class="srow"><span class="srow-l">Most expensive</span><span class="srow-r">${esc(topSubs[0]?.name||'‚Äî')}</span></div>`:''}
    ${budget>0?`<div class="srow"><span class="srow-l">Budget used</span><span class="srow-r" style="color:${monthly>budget?'var(--danger)':monthly>budget*.8?'var(--warn)':'var(--success)'}">${Math.round((monthly/budget)*100)}%</span></div>`:''}
    <div class="srow"><span class="srow-l">Pausing savings</span><span class="srow-r" style="color:var(--paused)">${fINR(pausedSavings)}/mo</span></div>
  </div>

  <!-- Payment methods -->
  <div class="i-card">
    <h3>üí∏ Payment Methods</h3>
    ${payE.map(([p,n])=>`<div class="srow"><span class="srow-l">${esc(p)}</span><span class="srow-r">${n} sub${n!==1?'s':''}</span></div>`).join('')}
  </div>

  <!-- Next 30 days -->
  <div class="i-card">
    <h3>üìÖ Renewals in 30 Days</h3>
    ${next30.length?next30.map(s=>{
      const dLeft=s.isPrepaid?daysUntil(s.prepaidUntil):daysUntil(s.nextDate);
      const dStr=s.isPrepaid?`Expires ${fDate(s.prepaidUntil)}`:`Renews ${fDate(s.nextDate)}`;
      return`<div class="srow"><span class="srow-l">${esc(s.name)}${s.isPrepaid?' üéüÔ∏è':''}<br><span style="font-size:10px;color:var(--text3)">${dStr}</span></span><span class="srow-r" style="color:${dLeft<=3?'var(--danger)':dLeft<=7?'var(--warn)':'var(--text)'}">${fINR(s.cost)}<br><span style="font-size:10px;color:var(--text3)">${dLeft}d</span></span></div>`;
    }).join(''):`<p style="color:var(--text3);font-size:12px;padding:6px 0">No renewals in the next 30 days üéâ</p>`}
    ${next30total>0?`<div style="margin-top:10px;padding:9px 12px;background:var(--s2);border-radius:var(--r4);border:1px solid var(--border)"><span style="font-size:9px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.6px;font-family:'Cabinet Grotesk',sans-serif">30-day outflow</span><div style="font-size:18px;font-weight:900;font-family:'Cabinet Grotesk',sans-serif;letter-spacing:-.4px;color:var(--warn);margin-top:3px">${fINR(next30total)}</div></div>`:''}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Account
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAccount(){
  if(!USER)return;
  const el=document.getElementById('account-wrap');
  const name=USER.displayName||USER.email.split('@')[0];
  const monthly=SUBS.filter(s=>!s.isPaused).reduce((s,i)=>s+moEq(i.cost,i.cycle),0);
  const yr=new Date().getFullYear();
  el.innerHTML=`
    <div class="acct-avatar">${initials(name)}</div>
    <div class="acct-name">${esc(name)}</div>
    <div class="acct-email">${esc(USER.email)}</div>
    <div class="acct-sec">
      <div class="acct-sec-title">Budget</div>
      <div class="budget-card">
        <div class="budget-head"><span class="budget-lbl">${budget?'Monthly Budget':'Set a Budget'}</span><button class="budget-edit-btn" onclick="openBudgetModal()">${budget?'Edit':'Set'}</button></div>
        ${budget>0?`<div class="budget-track"><div class="budget-bar" style="width:${Math.min(monthly/budget*100,100)}%;background:${monthly>budget?'linear-gradient(90deg,#f43f5e,#e11d48)':monthly>budget*.8?'linear-gradient(90deg,#f59e0b,#d97706)':'linear-gradient(90deg,#6366f1,#818cf8)'}"></div></div>
        <div class="budget-stats">
          <div><div class="budget-v">${fINR(monthly)}</div><div class="budget-l">Spent</div></div>
          <div style="text-align:center"><div class="budget-v">${Math.round(monthly/budget*100)}%</div><div class="budget-l">Used</div></div>
          <div style="text-align:right"><div class="budget-v">${fINR(budget)}</div><div class="budget-l">Budget</div></div>
        </div>`:`<div style="font-size:12px;color:var(--text3);padding:4px 0">Track your spending against a monthly limit</div>`}
      </div>
    </div>
    <div class="acct-sec">
      <div class="acct-sec-title">Summary</div>
      <div class="acct-item">
        <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
        <span>${SUBS.length} subs ¬∑ ${fINR(monthly)}/mo ¬∑ ${fINR(monthly*12)}/yr</span>
      </div>
      <div class="acct-item">
        <svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
        <span>${SUBS.filter(s=>s.isPrepaid).length} prepaid ¬∑ ${SUBS.filter(s=>s.isTrial).length} trials ¬∑ ${SUBS.filter(s=>s.isPaused).length} paused</span>
      </div>
    </div>
    <div class="acct-sec">
      <div class="acct-sec-title">Export Data</div>
      <div class="acct-item" onclick="exportCSV()">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>Export as CSV</span>
        <svg class="chev" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="acct-item" onclick="exportJSON()">
        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span>Export as JSON</span>
        <svg class="chev" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>
    <div class="acct-sec">
      <div class="acct-sec-title">Account</div>
      <div class="acct-item danger" onclick="auth.signOut()">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        <span>Sign Out</span>
      </div>
    </div>
    <div class="acct-footer"><strong>SubsTrack</strong> v3.1 &nbsp;¬∑&nbsp; Made with ‚ù§Ô∏è for India üáÆüá≥<br><strong>Arnav Dugad</strong> &copy; ${yr}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Budget
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBudgetModal(){
  document.getElementById('budget-input').value=budget||'';
  document.getElementById('budget-preview').textContent='';
  document.getElementById('budget-modal').classList.add('on');
}
function closeBudgetModal(){document.getElementById('budget-modal').classList.remove('on')}
function updateBudgetPreview(){
  const v=parseFloat(document.getElementById('budget-input').value)||0;
  const monthly=SUBS.filter(s=>!s.isPaused).reduce((s,i)=>s+moEq(i.cost,i.cycle),0);
  if(v>0){
    const pct=Math.round((monthly/v)*100);
    document.getElementById('budget-preview').textContent=`You currently spend ${pct}% of this budget`;
  }else{document.getElementById('budget-preview').textContent='';}
}
async function saveBudget(){
  const v=parseFloat(document.getElementById('budget-input').value)||0;
  budget=v;
  try{await userRef().update({budget:v})}catch(e){await userRef().set({budget:v},{merge:true})}
  closeBudgetModal();
  showToast(v?`Budget set to ${fINR(v)}`:'Budget cleared','ok');
  renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Export
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(){
  const rows=[['Name','Cost (‚Çπ)','Cycle','Category','Payment Mode','Bank/Detail','Next Billing','Prepaid','Prepaid Until','Trial','Trial End','Paused','Notes']];
  SUBS.forEach(s=>{
    const pd=s.payDetail?`${s.payDetail.bankName||s.payDetail.upiId||s.payDetail.walletName||''}${s.payDetail.last4?' *'+s.payDetail.last4:''}${s.payDetail.cardType?' ('+s.payDetail.cardType+')':''}`.trim():'';
    rows.push([s.name,s.cost,s.cycle,s.category||'',s.paymentMode||'',pd,s.nextDate||'',s.isPrepaid?'Yes':'No',s.prepaidUntil||'',s.isTrial?'Yes':'No',s.trialEnd||'',s.isPaused?'Yes':'No',s.notes||'']);
  });
  dl(rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'),'substrack-export.csv','text/csv');
  showToast('CSV exported','ok');
}
function exportJSON(){
  dl(JSON.stringify(SUBS.map(({id,createdAt,...r})=>r),null,2),'substrack-export.json','application/json');
  showToast('JSON exported','ok');
}
function dl(content,name,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href)}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Navigation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(t){
  tab=t;
  document.querySelectorAll('.tab').forEach(e=>e.classList.remove('on'));
  document.getElementById('tab-'+t).classList.add('on');
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.toggle('on',e.dataset.tab===t));
  updatePill();
  document.getElementById('main-scroll').scrollTop=0;
}
function updatePill(){
  const a=document.querySelector('.nav-item.on');const p=document.getElementById('nav-pill');
  if(!a)return;
  const r=a.getBoundingClientRect();const pr=a.parentElement.getBoundingClientRect();
  p.style.left=(r.left-pr.left+r.width*.25)+'px';p.style.width=(r.width*.5)+'px';
}
window.addEventListener('resize',updatePill);
setTimeout(updatePill,150);

function toggleSort(){document.getElementById('sort-drop').classList.toggle('open')}
document.querySelectorAll('.sort-opt').forEach(b=>{
  b.onclick=()=>{
    sortMode=b.dataset.s;
    document.querySelectorAll('.sort-opt').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');
    document.getElementById('sort-drop').classList.remove('open');
    renderAll();
  };
});
document.addEventListener('click',e=>{
  if(!e.target.closest('.hdr-btns'))document.getElementById('sort-drop').classList.remove('open');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Bottom Sheet
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddSheet(){
  editId=null;isPrepaid=false;isTrial=false;isPaused=false;preMode='duration';
  document.getElementById('bs-title').textContent='New Subscription';
  document.getElementById('f-submit').textContent='Add Subscription';
  document.getElementById('bs-delete-btn').style.display='none';
  document.getElementById('sub-form').reset();
  document.getElementById('f-edit-id').value='';
  document.getElementById('f-is-prepaid').value='false';
  document.getElementById('f-is-trial').value='false';
  document.getElementById('f-is-paused').value='false';
  document.getElementById('f-pre-mode').value='duration';
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  ['prepaid-toggle','trial-toggle','pause-toggle'].forEach(id=>document.getElementById(id).classList.remove('on'));
  ['prepaid-section','trial-section'].forEach(id=>document.getElementById(id).classList.remove('show'));
  document.getElementById('pay-detail-wrap').innerHTML='';
  document.querySelectorAll('.tmpl-btn').forEach(b=>b.classList.remove('sel'));
  setPreMode('duration');
  openSheet();
}

function openEditSheet(id){
  const s=SUBS.find(x=>x.id===id);if(!s)return;
  editId=id;isPrepaid=!!s.isPrepaid;isTrial=!!s.isTrial;isPaused=!!s.isPaused;preMode='duration';
  document.getElementById('bs-title').textContent='Edit Subscription';
  document.getElementById('f-submit').textContent='Save Changes';
  document.getElementById('bs-delete-btn').style.display='block';
  document.getElementById('f-name').value=s.name||'';
  document.getElementById('f-logo').value=s.logo||'';
  document.getElementById('f-cost').value=s.cost||'';
  document.getElementById('f-cycle').value=s.cycle||'monthly';
  document.getElementById('f-date').value=s.nextDate||'';
  document.getElementById('f-category').value=s.category||'Entertainment';
  document.getElementById('f-payment').value=s.paymentMode||'';
  document.getElementById('f-notes').value=s.notes||'';
  document.getElementById('f-edit-id').value=id;
  document.getElementById('f-is-prepaid').value=isPrepaid?'true':'false';
  document.getElementById('f-is-trial').value=isTrial?'true':'false';
  document.getElementById('f-is-paused').value=isPaused?'true':'false';
  document.getElementById('f-pre-mode').value='duration';
  ['prepaid-toggle','trial-toggle','pause-toggle'].forEach(id=>document.getElementById(id).classList.remove('on'));
  ['prepaid-section','trial-section'].forEach(id=>document.getElementById(id).classList.remove('show'));
  if(isPrepaid){
    document.getElementById('prepaid-toggle').classList.add('on');
    document.getElementById('prepaid-section').classList.add('show');
    document.getElementById('f-pre-dur').value=s.prepaidDuration||'';
    document.getElementById('f-pre-unit').value=s.prepaidUnit||'months';
    document.getElementById('f-pre-until').value=s.prepaidUntil||'';
  }
  if(isTrial){
    document.getElementById('trial-toggle').classList.add('on');
    document.getElementById('trial-section').classList.add('show');
    document.getElementById('f-trial-end').value=s.trialEnd||'';
  }
  if(isPaused)document.getElementById('pause-toggle').classList.add('on');
  onPayChange();
  if(s.payDetail)fillPayDetail(s.payDetail,s.paymentMode);
  setPreMode('duration');
  openSheet();
}

function openSheet(){
  document.getElementById('bs-overlay').classList.add('on');
  document.getElementById('bottom-sheet').classList.add('on');
}
function closeSheet(){
  document.getElementById('bs-overlay').classList.remove('on');
  document.getElementById('bottom-sheet').classList.remove('on');
}

function deleteCurrentEdit(){
  if(!editId)return;
  if(confirm('Delete this subscription?')){delSub(editId);closeSheet();}
}

// Templates
function buildTemplates(){
  document.getElementById('tmpl-grid').innerHTML=TMPLS.map((t,i)=>`
    <button class="tmpl-btn" type="button" onclick="pickTmpl(${i})">
      <div class="tmpl-ico" style="background:${t.color}22"><img src="${t.logo}" onerror="this.parentNode.style.background='${t.color}';this.parentNode.textContent='${initials(t.name)}'"></div>
      <span class="tmpl-name">${t.name}</span>
    </button>`).join('');
}
buildTemplates();

function pickTmpl(i){
  const t=TMPLS[i];
  document.getElementById('f-name').value=t.name;
  document.getElementById('f-logo').value=t.logo;
  document.getElementById('f-cost').value=t.cost;
  document.getElementById('f-cycle').value=t.cycle;
  document.getElementById('f-category').value=t.category;
  document.querySelectorAll('.tmpl-btn').forEach((b,j)=>b.classList.toggle('sel',j===i));
}

function onSubForm(e){
  e.preventDefault();
  const prep=document.getElementById('f-is-prepaid').value==='true';
  const trial=document.getElementById('f-is-trial').value==='true';
  const paused=document.getElementById('f-is-paused').value==='true';
  const pdMode=document.getElementById('f-pre-mode').value;
  const dur=parseInt(document.getElementById('f-pre-dur').value)||0;
  const unit=document.getElementById('f-pre-unit').value||'months';
  const until=document.getElementById('f-pre-until').value||'';
  const trialEnd=document.getElementById('f-trial-end').value||'';
  const payDetail=getPayDetail();

  const data={
    name:document.getElementById('f-name').value.trim(),
    logo:document.getElementById('f-logo').value.trim()||'',
    cost:parseFloat(document.getElementById('f-cost').value),
    cycle:document.getElementById('f-cycle').value,
    nextDate:document.getElementById('f-date').value,
    category:document.getElementById('f-category').value,
    paymentMode:document.getElementById('f-payment').value||'',
    payDetail:payDetail||null,
    notes:document.getElementById('f-notes').value.trim(),
    isPrepaid:prep,
    prepaidDuration:prep?dur:0,
    prepaidUnit:prep?unit:'months',
    prepaidUntil:prep?until:'',
    isTrial:trial,
    trialEnd:trial?trialEnd:'',
    isPaused:paused,
  };

  const tmpl=TMPLS.find(t=>t.name.toLowerCase()===data.name.toLowerCase());
  if(tmpl){if(!data.logo)data.logo=tmpl.logo;data.brandColor=tmpl.color;}

  if(editId)updSub(editId,data);else addSub(data);
  closeSheet();
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Swipe to delete
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initSwipe(container){
  container.querySelectorAll('.sub-card').forEach(card=>{
    let sx=0,cx=0,dragging=false;
    const wrapper=card.closest('.sw-wrapper');
    card.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;dragging=false;card.style.transition='none'},{passive:true});
    card.addEventListener('touchmove',e=>{
      const dx=e.touches[0].clientX-sx;
      if(dx<-10)dragging=true;
      if(dragging){cx=Math.min(0,Math.max(dx,-95));card.style.transform=`translateX(${cx}px)`}
    },{passive:true});
    card.addEventListener('touchend',()=>{
      card.style.transition='transform .28s var(--ease)';
      if(cx<-60){
        card.style.transform='translateX(-100%)';
        const id=card.dataset.id;
        setTimeout(()=>{wrapper.classList.add('bye');setTimeout(()=>delSub(id),300)},100);
      }else{card.style.transform='translateX(0)'}
      cx=0;dragging=false;
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Pull to refresh
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(()=>{
  const scroll=document.getElementById('main-scroll');
  const ptr=document.getElementById('ptr');
  let sy=0,pulling=false;
  scroll.addEventListener('touchstart',e=>{if(scroll.scrollTop<=0)sy=e.touches[0].clientY},{passive:true});
  scroll.addEventListener('touchmove',e=>{
    if(scroll.scrollTop>0)return;
    const dy=e.touches[0].clientY-sy;
    if(dy>0&&dy<90){pulling=true;ptr.style.height=Math.min(dy*.5,40)+'px';ptr.querySelector('svg').style.transform=`rotate(${dy*3}deg)`}
  },{passive:true});
  scroll.addEventListener('touchend',()=>{
    if(pulling&&parseInt(ptr.style.height||0)>26){
      ptr.classList.add('spin');ptr.style.height='40px';
      loadSubs();
      setTimeout(()=>{ptr.classList.remove('spin');ptr.style.height='0'},1500);
    }else{ptr.style.height='0'}
    pulling=false;
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Toast
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg,type='ok'){
  const t=document.getElementById('toast');
  t.className='toast '+type;
  document.getElementById('toast-ico').textContent=type==='ok'?'‚úì':'‚úï';
  document.getElementById('toast-msg').textContent=msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.remove('show'),2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Keyboard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('a-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doAuth()});
document.getElementById('a-email').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('a-pass').focus()});
document.getElementById('f-date').addEventListener('change',()=>{if(isPrepaid&&preMode==='duration')calcPrepaidEnd()});
document.getElementById('budget-modal').addEventListener('click',e=>{if(e.target===document.getElementById('budget-modal'))closeBudgetModal()});
</script>
</body>
</html>
